#!/usr/bin/env bash
# adm-profile — gerenciador de perfis ADM
# Local: /usr/src/adm/bin/adm-profile
set -Eeuo pipefail
IFS=$'\n\t'

# --------- Exit codes (consistentes com sistema) ----------
ADM_OK=0
ADM_ERR_USAGE=80
ADM_ERR_INTERNAL=99
ADM_ERR_VERIFY=30
ADM_ERR_PERMISSION=70

# --------- Paths & defaults ----------
ADM_ROOT_DEFAULT="/usr/src/adm"
ADM_ROOT="${ADM_ROOT:-$ADM_ROOT_DEFAULT}"
ADM_LOGGER_PATH="${ADM_ROOT}/bin/adm-logger"
PROFILES_DIR="${ADM_ROOT}/etc/profile"
STATE_DIR="${ADM_ROOT}/var"
ACTIVE_PROFILE_FILE="${STATE_DIR}/state_profile"
EXPORT_ENV_FILE="${STATE_DIR}/profile.env"
EXEC_ID="$(date -u +%Y%m%d-%H%M%S)-$$"

# --------- load logger or fallback ----------
if [[ -f "$ADM_LOGGER_PATH" ]]; then
  # shellcheck source=/usr/src/adm/bin/adm-logger
  source "$ADM_LOGGER_PATH"
else
  log_start(){ :; }
  log_info(){ printf '[INFO] %s\n' "$*"; }
  log_ok(){ printf '[OK] %s\n' "$*"; }
  log_warn(){ printf '[WARN] %s\n' "$*"; }
  log_err(){ printf '[ERR] %s\n' "$*"; }
  log_end(){ :; }
  log_set_phase(){ :; }
  log_set_subject(){ :; }
  log_verbose_on(){ :; }
  log_quiet_on(){ :; }
fi

# --------- Helpers ----------
_safe_name() {
  # allow letters, numbers, - and _
  [[ "$1" =~ ^[a-zA-Z0-9_-]+$ ]]
}
_ensure_dirs() {
  mkdir -p "$PROFILES_DIR" "$STATE_DIR"
}
_atomic_write() {
  local dest="$1" tmp="${dest}.$EXEC_ID.tmp"
  printf '%s' "$2" >"$tmp" && mv -f "$tmp" "$dest"
}
_profile_path() { printf '%s/%s.sh' "$PROFILES_DIR" "$1"; }
_profile_exists(){ [[ -f "$(_profile_path "$1")" ]]; }
_load_and_validate_profile() {
  # loads profile in subshell to validate syntax, returns 0 if ok
  local file="$1"
  if ! bash -n "$file" 2>/dev/null; then
    return 1
  fi
  return 0
}
_create_file_if_missing() {
  local path="$1" content="$2"
  if [[ ! -f "$path" ]]; then
    _atomic_write "$path" "$content"
    return 0
  fi
  return 1
}
_current_profile() {
  if [[ -f "$ACTIVE_PROFILE_FILE" ]]; then
    cat "$ACTIVE_PROFILE_FILE"
  else
    echo "default"
  fi
}
_apply_profile_to_env() {
  # exports to EXPORT_ENV_FILE atomically
  local profile="$1" pfile
  pfile="$(_profile_path "$profile")"
  if [[ ! -f "$pfile" ]]; then
    return 1
  fi
  # source in subshell and print env lines (only vars we want)
  local tmp; tmp="$(mktemp)"
  # validate via subshell, then print core vars
  if ! bash -c "set -a; source '$pfile'; env -0" >/dev/null 2>&1; then
    rm -f "$tmp"
    return 2
  fi
  # produce export file: only keep vars defined in profile file by sourcing and diffing env snapshots
  # simpler approach: source profile in a clean shell and print a curated set
  bash -c "set -a; source '$pfile'; printf 'ARCH=%s\n' \"\${ARCH:-}\"; printf 'TARGET=%s\n' \"\${TARGET:-}\"; printf 'CFLAGS=%s\n' \"\${CFLAGS:-}\"; printf 'LDFLAGS=%s\n' \"\${LDFLAGS:-}\"; printf 'MAKEFLAGS=%s\n' \"\${MAKEFLAGS:-}\"; printf 'JOBS=%s\n' \"\${JOBS:-}\"; printf 'BUILD_PROFILE=%s\n' \"\${BUILD_PROFILE:-}\"; printf 'PROFILE_DESC=%s\n' \"\${PROFILE_DESC:-}\"" > "$tmp"
  _atomic_write "$EXPORT_ENV_FILE" "$(sed 's/^/export /' "$tmp" | sed 's/=/="/; s/$/"/')"
  rm -f "$tmp"
  return 0
}

# --------- Default profile contents ----------
profile_default_content='
# profile: default
ARCH="x86_64"
TARGET="x86_64-linux-gnu"
CFLAGS="-O2 -pipe -fstack-protector-strong"
LDFLAGS="-Wl,-O1"
MAKEFLAGS="-j$(nproc)"
JOBS="$(nproc)"
BUILD_PROFILE="default"
PROFILE_DESC="Perfil padrão equilibrado entre desempenho e segurança"
'

profile_normal_content='
# profile: normal
ARCH="x86_64"
TARGET="x86_64-linux-gnu"
CFLAGS="-O2 -pipe -fstack-protector-strong -march=x86-64"
LDFLAGS="-Wl,-O1"
MAKEFLAGS="-j$(nproc)"
JOBS="$(nproc)"
BUILD_PROFILE="normal"
PROFILE_DESC="Perfil normal: estabilidade com bom desempenho"
'

profile_aggressive_content='
# profile: aggressive
ARCH="x86_64"
TARGET="x86_64-linux-gnu"
# agressivo: otimizações máximas; cuidado com compatibilidade
CFLAGS="-O3 -march=native -flto -fno-plt -fstack-protector-strong -pipe -fomit-frame-pointer"
LDFLAGS="-Wl,-O1 -flto"
MAKEFLAGS="-j$(( $(nproc) * 2 ))"
JOBS="$(( $(nproc) * 2 ))"
BUILD_PROFILE="aggressive"
PROFILE_DESC="Perfil agressivo: máxima performance (LTO, -march=native). Testar em ambiente controlado"
'

profile_bootstrap_content='
# profile: bootstrap
ARCH="x86_64"
TARGET="x86_64-linux-gnu"
# bootstrap: flags conservadoras para construir toolchain
CFLAGS="-O2 -g -fno-builtin -fstack-protector-strong -pipe"
LDFLAGS=""
MAKEFLAGS="-j2"
JOBS="2"
BUILD_PROFILE="bootstrap"
PROFILE_DESC="Perfil bootstrap: conservador e reprodutível para construir toolchain"
'

# --------- Commands implementation ----------
_cmd_list() {
  log_set_phase "list"
  log_info "Listando perfis em $PROFILES_DIR"
  mkdir -p "$PROFILES_DIR"
  local f
  for f in "$PROFILES_DIR"/*.sh; do
    [[ -f "$f" ]] || continue
    basename "$f" .sh
  done
}

_cmd_show() {
  local name="${1:-$(_current_profile)}"
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_err "Perfil '$name' não existe"; return 1; fi
  log_set_phase "show"
  log_info "Mostrando perfil '$name'"
  sed -n '1,200p' "$p"
}

_cmd_create() {
  local name="$1"
  if ! _safe_name "$name"; then log_err "Nome inválido: $name"; return $ADM_ERR_USAGE; fi
  local p="$(_profile_path "$name")"
  if [[ -f "$p" ]]; then log_warn "Perfil '$name' já existe"; return 1; fi
  # base on current active or default
  local base="$(_current_profile)"
  local basefile="$(_profile_path "$base")"
  if [[ ! -f "$basefile" ]]; then basefile=""; fi
  if [[ -n "$basefile" ]]; then
    cp -a "$basefile" "$p"
  else
    _atomic_write "$p" "$profile_default_content"
  fi
  # validate
  if ! _load_and_validate_profile "$p"; then
    rm -f "$p"
    log_err "Falha ao validar perfil criado; criação abortada"
    return $ADM_ERR_VERIFY
  fi
  log_ok "Perfil '$name' criado (baseado em '${base:-default}')"
}

_cmd_set() {
  local name="$1"
  if ! _safe_name "$name"; then log_err "Nome inválido: $name"; return $ADM_ERR_USAGE; fi
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_err "Perfil '$name' não existe"; return 1; fi
  # validate by loading in subshell
  if ! _load_and_validate_profile "$p"; then
    log_err "Perfil '$name' falhou na validação; não será ativado"
    return $ADM_ERR_VERIFY
  fi
  # atomic set
  _atomic_write "$ACTIVE_PROFILE_FILE" "$name"
  if _apply_profile_to_env "$name"; then
    log_ok "Perfil ativo alterado para: $name"
    return 0
  else
    log_warn "Perfil aplicado, mas falha ao gerar export env"
    return 0
  fi
}

_cmd_delete() {
  local name="$1"
  if ! _safe_name "$name"; then log_err "Nome inválido: $name"; return $ADM_ERR_USAGE; fi
  if [[ "$name" == "default" ]]; then log_err "Não é permitido remover o perfil 'default'"; return 1; fi
  local active="$(_current_profile)"
  if [[ "$name" == "$active" ]]; then log_err "Não é permitido remover o perfil ativo ($active)"; return 1; fi
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_warn "Perfil '$name' não existe"; return 1; fi
  if ! rm -f "$p"; then log_err "Falha ao remover $p"; return $ADM_ERR_INTERNAL; fi
  log_ok "Perfil '$name' removido"
}

_cmd_edit() {
  local name="${1:-$(_current_profile)}"
  local editor="${EDITOR:-vi}"
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_err "Perfil '$name' não existe"; return 1; fi
  "$editor" "$p"
  if ! _load_and_validate_profile "$p"; then
    log_err "Alterações introduziram erro de sintaxe; revertendo"
    git --no-pager diff -- "$p" 2>/dev/null || true
    return $ADM_ERR_VERIFY
  fi
  log_ok "Perfil '$name' editado com sucesso"
}

_cmd_export() {
  local name="${1:-$(_current_profile)}"
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_err "Perfil '$name' não existe"; return 1; fi
  # build export content by sourcing in a clean shell and printing variables
  bash -c "set -a; source '$p'; printf 'export ARCH=\"%s\"\\nexport TARGET=\"%s\"\\nexport CFLAGS=\"%s\"\\nexport LDFLAGS=\"%s\"\\nexport MAKEFLAGS=\"%s\"\\nexport JOBS=\"%s\"\\nexport BUILD_PROFILE=\"%s\"\\n' \"\${ARCH:-}\" \"\${TARGET:-}\" \"\${CFLAGS:-}\" \"\${LDFLAGS:-}\" \"\${MAKEFLAGS:-}\" \"\${JOBS:-}\" \"\${BUILD_PROFILE:-}\""
}

_cmd_env() {
  local name="${1:-$(_current_profile)}"
  local p="$(_profile_path "$name")"
  if [[ ! -f "$p" ]]; then log_err "Perfil '$name' não existe"; return 1; fi
  log_info "Carregando perfil '$name' em ambiente atual (temporário)"
  # source in current shell (caller scripts can source the export file instead)
  # Note: using '.' will affect current shell; we prefer to print instructions
  echo "Para aplicar: source <(adm-profile export $name)"
  return 0
}

_cmd_reload() {
  local name="$(_current_profile)"
  if [[ -z "$name" ]]; then log_err "Nenhum perfil ativo"; return 1; fi
  if ! _apply_profile_to_env "$name"; then log_warn "Falha ao recarregar perfil '$name'"; return 1; fi
  log_ok "Perfil '$name' recarregado e exportado em $EXPORT_ENV_FILE"
  return 0
}

# --------- init defaults if missing ----------
_init_defaults() {
  _ensure_dirs
  _create_file_if_missing "$(_profile_path default)" "$profile_default_content"
  _create_file_if_missing "$(_profile_path normal)" "$profile_normal_content"
  _create_file_if_missing "$(_profile_path aggressive)" "$profile_aggressive_content"
  _create_file_if_missing "$(_profile_path bootstrap)" "$profile_bootstrap_content"
  # if no active profile, set default
  if [[ ! -f "$ACTIVE_PROFILE_FILE" ]]; then
    _atomic_write "$ACTIVE_PROFILE_FILE" "default"
  fi
  # ensure export env exists
  _apply_profile_to_env "$(_current_profile)" || true
}

# --------- usage ----------
_usage() {
  cat <<EOF
Usage: adm-profile <cmd> [args]

Commands:
  list                 : listar perfis
  show [name]          : mostrar perfil (ou ativo)
  set <name>           : ativar perfil
  create <name>        : criar perfil (base = ativo)
  edit [name]          : editar perfil
  delete <name>        : remover perfil (não ativo, não default)
  export [name]        : imprime env exportável
  env [name]           : mostra instruções para aplicar
  reload               : recarrega perfil ativo e atualiza export env
  help                 : esta ajuda
EOF
  exit $ADM_ERR_USAGE
}

# --------- parse & dispatch ----------
main() {
  log_start "adm-profile" "profile"
  log_set_subject "adm-profile"
  _ensure_dirs
  _init_defaults

  if [[ $# -lt 1 ]]; then _usage; fi
  local cmd="$1"; shift
  case "$cmd" in
    list) _cmd_list "$@" ;;
    show) _cmd_show "$@" ;;
    create) [[ $# -ge 1 ]] || { log_err "create precisa de um nome"; exit $ADM_ERR_USAGE; }; _cmd_create "$1" ;;
    set) [[ $# -ge 1 ]] || { log_err "set precisa de um nome"; exit $ADM_ERR_USAGE; }; _cmd_set "$1" ;;
    delete) [[ $# -ge 1 ]] || { log_err "delete precisa de um nome"; exit $ADM_ERR_USAGE; }; _cmd_delete "$1" ;;
    edit) _cmd_edit "$@" ;;
    export) _cmd_export "$@" ;;
    env) _cmd_env "$@" ;;
    reload) _cmd_reload ;;
    help) _usage ;;
    *) log_err "Comando desconhecido: $cmd"; _usage ;;
  esac

  log_end $ADM_OK
}

trap 'log_err "Interrompido"; log_end $ADM_ERR_INTERNAL; exit $ADM_ERR_INTERNAL' INT TERM
main "$@"
