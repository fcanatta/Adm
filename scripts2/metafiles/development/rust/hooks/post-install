#!/usr/bin/env bash
#
# ADM HOOK: rust post-install
# - Verifica integridade, gera registro de versÃ£o e realiza limpeza opcional.
#
set -euo pipefail

echo "ðŸ”§ [rust post-install] Verificando instalaÃ§Ã£o..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/rust-install.log}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/rust-destdir}"

if [ -z "$DESTDIR" ] || [ "$DESTDIR" = "/" ]; then
  echo "âŒ DESTDIR invÃ¡lido ($DESTDIR)"
  exit 2
fi

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) verificaria binÃ¡rios em $DESTDIR/usr/bin"
  exit 0
fi

if [ ! -x "$DESTDIR/usr/bin/rustc" ]; then
  echo "âš ï¸  rustc nÃ£o encontrado em $DESTDIR/usr/bin/"
  exit 1
fi

ver="$("$DESTDIR/usr/bin/rustc" --version || echo unknown)"
mkdir -p "$DESTDIR/var/lib/rust"
echo "$ver" > "$DESTDIR/var/lib/rust/version"

# Limpeza opcional
find "$DESTDIR" -name '*.pdb' -o -name '*.dbg' -delete 2>/dev/null || true

echo "âœ… [rust post-install] InstalaÃ§Ã£o OK â€” versÃ£o: $ver"
echo "[`date -u`] rust installed OK ($ver)" >> "$ADM_LOG"
