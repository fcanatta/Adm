#!/usr/bin/env bash
#
# ADM HOOK: rust pre-bootstrap
# - Prepara toolchain de bootstrap (stage0) para compilar o Rust a partir do zero.
# - Baixa binÃ¡rios oficiais ou usa toolchain local, valida SHA256, configura PATH e vars.
# - CompatÃ­vel com LFS/ADM. Respeita DRY_RUN e aborta se operaÃ§Ãµes inseguras.
#
set -euo pipefail

echo "ðŸ¦€ [rust pre-bootstrap] Inicializando ambiente bootstrap..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/rust-bootstrap.log}"
CACHE_DIR="${CACHE_DIR:-${ADM_ROOT}/cache}"
BOOTSTRAP_DIR="${BOOTSTRAP_DIR:-${ADM_ROOT}/toolchains/rust-bootstrap}"
ARCH="$(uname -m)"
OS="unknown-linux-gnu"
RUST_STAGE0_VERSION="${RUST_STAGE0_VERSION:-1.84.1}"
RUST_STAGE0_URL="https://static.rust-lang.org/dist/rust-${RUST_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz"
RUST_STAGE0_SHA256_URL="https://static.rust-lang.org/dist/rust-${RUST_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz.sha256"
RUST_STAGE0_ARCHIVE="${CACHE_DIR}/rust-${RUST_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz"
RUST_STAGE0_SUM="${CACHE_DIR}/rust-${RUST_STAGE0_VERSION}-${ARCH}-${OS}.sha256"

mkdir -p "$CACHE_DIR" "$BOOTSTRAP_DIR" "$(dirname "$ADM_LOG")"
echo "[`date -u`] rust pre-bootstrap start" >> "$ADM_LOG"

# 1ï¸âƒ£ Verificar se jÃ¡ existe toolchain bootstrap funcional
if command -v rustc >/dev/null 2>&1; then
  echo "âœ”ï¸ Toolchain Rust jÃ¡ detectado: $(rustc --version)"
  echo "[`date -u`] rust bootstrap skipped (existing toolchain)" >> "$ADM_LOG"
  exit 0
fi

# 2ï¸âƒ£ Baixar stage0 se nÃ£o existir no cache
if [ ! -f "$RUST_STAGE0_ARCHIVE" ]; then
  echo "ðŸ“¥ Baixando stage0 Rust ${RUST_STAGE0_VERSION}..."
  echo "    â†’ $RUST_STAGE0_URL"
  if [ "$DRY_RUN" -eq 1 ]; then
    echo "(dry-run) pularia download do stage0"
  else
    curl -L --fail -o "$RUST_STAGE0_ARCHIVE" "$RUST_STAGE0_URL"
    curl -L --fail -o "$RUST_STAGE0_SUM" "$RUST_STAGE0_SHA256_URL" || true
  fi
else
  echo "â„¹ï¸  Stage0 jÃ¡ em cache: $RUST_STAGE0_ARCHIVE"
fi

# 3ï¸âƒ£ Validar SHA256 do stage0
if [ "$DRY_RUN" -eq 0 ] && [ -f "$RUST_STAGE0_SUM" ]; then
  echo "ðŸ”’ Verificando SHA256..."
  EXPECTED_SHA="$(awk '{print $1}' "$RUST_STAGE0_SUM" | head -n1)"
  GOT_SHA="$(sha256sum "$RUST_STAGE0_ARCHIVE" | awk '{print $1}')"
  if [ "$EXPECTED_SHA" != "$GOT_SHA" ]; then
    echo "âŒ SHA256 incorreto para $RUST_STAGE0_ARCHIVE"
    echo "Esperado: $EXPECTED_SHA"
    echo "Obtido:   $GOT_SHA"
    echo "[`date -u`] SHA256 mismatch" >> "$ADM_LOG"
    exit 2
  fi
  echo "âœ”ï¸  SHA256 vÃ¡lido."
else
  echo "âš ï¸  SHA256 nÃ£o validado (modo dry-run ou sum ausente)"
fi

# 4ï¸âƒ£ Extrair stage0
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) extrairia $RUST_STAGE0_ARCHIVE â†’ $BOOTSTRAP_DIR"
else
  echo "ðŸ“¦ Extraindo bootstrap toolchain para $BOOTSTRAP_DIR..."
  tar -xJf "$RUST_STAGE0_ARCHIVE" -C "$BOOTSTRAP_DIR" --strip-components=1
fi

# 5ï¸âƒ£ Instalar stage0 (em ambiente isolado no ADM tree)
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) executaria ./install.sh --prefix=$BOOTSTRAP_DIR"
else
  pushd "$BOOTSTRAP_DIR" >/dev/null
  if [ -x "./install.sh" ]; then
    ./install.sh --prefix="$BOOTSTRAP_DIR" > install.log 2>&1 || {
      echo "âŒ Falha na instalaÃ§Ã£o do stage0. Veja install.log"
      tail -n 50 install.log
      exit 1
    }
  else
    echo "âš ï¸  Script install.sh nÃ£o encontrado. Verifique o tarball."
  fi
  popd >/dev/null
fi

# 6ï¸âƒ£ Configurar PATH e variÃ¡veis
export PATH="$BOOTSTRAP_DIR/bin:$PATH"
export RUSTC_BOOTSTRAP=1
export RUSTC="$BOOTSTRAP_DIR/bin/rustc"
export CARGO="$BOOTSTRAP_DIR/bin/cargo"
echo "PATH atualizado: $PATH"
echo "Rust bootstrap disponÃ­vel: $($RUSTC --version 2>/dev/null || echo 'nÃ£o detectado')"

# Registrar no log e exportar env
{
  echo "[`date -u`] rust stage0 installed â†’ $BOOTSTRAP_DIR"
  echo "PATH=$PATH"
  echo "RUSTC_BOOTSTRAP=$RUSTC_BOOTSTRAP"
} >> "$ADM_LOG"

echo "âœ… [rust pre-bootstrap] Ambiente pronto (stage0 toolchain)."
