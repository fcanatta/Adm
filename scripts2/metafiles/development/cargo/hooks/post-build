#!/usr/bin/env bash
#
# ADM HOOK: cargo post-build
# - Verifica se o binÃ¡rio foi gerado e empacota resultado.
#
set -euo pipefail

echo "ðŸ” [cargo post-build] Verificando build..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/cargo-build.log}"
SRC_DIR="$(pwd)"
BUILD_DIR="${BUILD_DIR:-${SRC_DIR}/build}"
CACHE_DIR="${ADM_ROOT}/cache"
PKG_NAME="cargo-${VERSION:-$(date +%Y%m%d)}"

mkdir -p "$CACHE_DIR"

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) verificaria e empacotaria $BUILD_DIR"
  exit 0
fi

# 1ï¸âƒ£ Validar binÃ¡rio
if [ ! -f "$SRC_DIR/target/release/cargo" ]; then
  echo "âŒ Cargo binÃ¡rio nÃ£o encontrado."
  exit 1
fi

# 2ï¸âƒ£ Empacotar binÃ¡rio
tar -C "$SRC_DIR/target/release" -cJf "${CACHE_DIR}/${PKG_NAME}.tar.xz" cargo
sha256sum "${CACHE_DIR}/${PKG_NAME}.tar.xz" > "${CACHE_DIR}/${PKG_NAME}.sha256"

echo "[`date -u`] cargo build OK" >> "$ADM_LOG"
echo "âœ… [cargo post-build] Empacotamento concluÃ­do: ${PKG_NAME}.tar.xz"
