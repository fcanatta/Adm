#!/usr/bin/env bash
#
# ADM HOOK: cargo pre-bootstrap
# - Prepara toolchain Cargo bootstrap em ambientes sem Cargo instalado.
# - Baixa binÃ¡rios oficiais do site da Rust Foundation, valida SHA256,
#   instala isoladamente em /usr/src/adm/toolchains/cargo-bootstrap
# - CompatÃ­vel com DRY_RUN, seguro e sem erros silenciosos.
#
set -euo pipefail

echo "ðŸ“¦ [cargo pre-bootstrap] Inicializando ambiente bootstrap para Cargo..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/cargo-bootstrap.log}"
CACHE_DIR="${CACHE_DIR:-${ADM_ROOT}/cache}"
BOOTSTRAP_DIR="${BOOTSTRAP_DIR:-${ADM_ROOT}/toolchains/cargo-bootstrap}"
ARCH="$(uname -m)"
OS="unknown-linux-gnu"
CARGO_STAGE0_VERSION="${CARGO_STAGE0_VERSION:-1.85.1}"

CARGO_URL="https://static.rust-lang.org/dist/cargo-${CARGO_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz"
CARGO_SHA256_URL="https://static.rust-lang.org/dist/cargo-${CARGO_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz.sha256"
CARGO_ARCHIVE="${CACHE_DIR}/cargo-${CARGO_STAGE0_VERSION}-${ARCH}-${OS}.tar.xz"
CARGO_SUM="${CACHE_DIR}/cargo-${CARGO_STAGE0_VERSION}-${ARCH}-${OS}.sha256"

mkdir -p "$CACHE_DIR" "$BOOTSTRAP_DIR" "$(dirname "$ADM_LOG")"
echo "[`date -u`] cargo pre-bootstrap start" >> "$ADM_LOG"

# 1ï¸âƒ£ Verificar se Cargo jÃ¡ existe
if command -v cargo >/dev/null 2>&1; then
  echo "âœ”ï¸ Cargo jÃ¡ detectado: $(cargo --version)"
  echo "[`date -u`] cargo pre-bootstrap skipped (found existing cargo)" >> "$ADM_LOG"
  exit 0
fi

# 2ï¸âƒ£ Download do binÃ¡rio de bootstrap
if [ ! -f "$CARGO_ARCHIVE" ]; then
  echo "ðŸ“¥ Baixando Cargo bootstrap ${CARGO_STAGE0_VERSION}..."
  echo "    â†’ $CARGO_URL"
  if [ "$DRY_RUN" -eq 1 ]; then
    echo "(dry-run) pularia download"
  else
    curl -L --fail -o "$CARGO_ARCHIVE" "$CARGO_URL"
    curl -L --fail -o "$CARGO_SUM" "$CARGO_SHA256_URL" || true
  fi
else
  echo "â„¹ï¸  Cargo bootstrap jÃ¡ em cache: $CARGO_ARCHIVE"
fi

# 3ï¸âƒ£ Validar SHA256
if [ "$DRY_RUN" -eq 0 ] && [ -f "$CARGO_SUM" ]; then
  echo "ðŸ”’ Validando integridade SHA256..."
  EXPECTED_SHA="$(awk '{print $1}' "$CARGO_SUM" | head -n1)"
  GOT_SHA="$(sha256sum "$CARGO_ARCHIVE" | awk '{print $1}')"
  if [ "$EXPECTED_SHA" != "$GOT_SHA" ]; then
    echo "âŒ SHA256 incorreto para $CARGO_ARCHIVE"
    echo "Esperado: $EXPECTED_SHA"
    echo "Obtido:   $GOT_SHA"
    echo "[`date -u`] cargo bootstrap sha256 mismatch" >> "$ADM_LOG"
    exit 2
  fi
  echo "âœ”ï¸  SHA256 vÃ¡lido."
else
  echo "âš ï¸  SHA256 nÃ£o validado (modo dry-run ou sum ausente)"
fi

# 4ï¸âƒ£ ExtraÃ§Ã£o
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) extrairia $CARGO_ARCHIVE â†’ $BOOTSTRAP_DIR"
else
  echo "ðŸ“¦ Extraindo Cargo bootstrap para $BOOTSTRAP_DIR..."
  tar -xJf "$CARGO_ARCHIVE" -C "$BOOTSTRAP_DIR" --strip-components=1
fi

# 5ï¸âƒ£ InstalaÃ§Ã£o isolada
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) executaria ./install.sh --prefix=$BOOTSTRAP_DIR"
else
  pushd "$BOOTSTRAP_DIR" >/dev/null
  if [ -x "./install.sh" ]; then
    ./install.sh --prefix="$BOOTSTRAP_DIR" > install.log 2>&1 || {
      echo "âŒ Falha na instalaÃ§Ã£o do Cargo bootstrap."
      tail -n 50 install.log
      exit 1
    }
  else
    echo "âš ï¸  Script install.sh nÃ£o encontrado, copiando binÃ¡rios manualmente..."
    mkdir -p "$BOOTSTRAP_DIR/bin"
    find "$BOOTSTRAP_DIR" -type f -name cargo -exec cp {} "$BOOTSTRAP_DIR/bin/" \; || true
  fi
  popd >/dev/null
fi

# 6ï¸âƒ£ Configurar ambiente
export PATH="$BOOTSTRAP_DIR/bin:$PATH"
export CARGO_HOME="${ADM_ROOT}/cache/cargo-home"
export CARGO="$BOOTSTRAP_DIR/bin/cargo"

mkdir -p "$CARGO_HOME" || true

# 7ï¸âƒ£ Verificar funcionalidade
if [ "$DRY_RUN" -eq 0 ]; then
  ver="$($CARGO --version || echo 'falha ao detectar versÃ£o')"
  echo "âœ”ï¸ Cargo bootstrap ativo: $ver"
  echo "$ver" > "$BOOTSTRAP_DIR/version"
else
  echo "(dry-run) verificaria $BOOTSTRAP_DIR/bin/cargo --version"
fi

echo "[`date -u`] cargo pre-bootstrap complete" >> "$ADM_LOG"
echo "âœ… [cargo pre-bootstrap] Ambiente Cargo bootstrap pronto."
