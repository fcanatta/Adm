#!/usr/bin/env bash
# ADM HOOK: binutils post-install
# Ajusta links simbÃ³licos, registra versÃ£o e limpa resÃ­duos

set -euo pipefail

echo "ðŸ”§ [binutils post-install] Ajustando instalaÃ§Ã£o..."

DESTDIR="${DESTDIR:-/usr/src/adm/tmp/binutils-destdir}"
PREFIX="${PREFIX:-/usr}"

# Criar links simbÃ³licos padrÃµes
ln -sf ld "$DESTDIR/$PREFIX/bin/ld.gold" 2>/dev/null || true
ln -sf as "$DESTDIR/$PREFIX/bin/assembler" 2>/dev/null || true

# Detectar versÃ£o instalada
if [ -x "$DESTDIR/$PREFIX/bin/ld" ]; then
  ver="$("$DESTDIR/$PREFIX/bin/ld" -v 2>&1 | head -n1 | awk '{print $NF}')"
  echo "$ver" > "$DESTDIR/$PREFIX/lib/binutils.version"
  echo "âœ”ï¸  Binutils versÃ£o registrada: $ver"
fi

# Remover arquivos temporÃ¡rios e arquivos .la
find "$DESTDIR" -name '*.la' -delete 2>/dev/null || true
echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."

echo "[`date -u`] Binutils ${ver:-unknown} instalado com sucesso" >> "${ADM_LOG:-/usr/src/adm/logs/binutils-install.log}"

echo "âœ… [binutils post-install] ConcluÃ­do"
