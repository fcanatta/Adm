#!/usr/bin/env bash
# ADM hook: glibc pre-install
# - Prepare DESTDIR and warn about dangerous installs
# - STRICT CHECK: abort if DESTDIR empty or "/"
#
set -euo pipefail

echo "üì¶ [glibc pre-install] Preparing install..."

DRY_RUN="${DRY_RUN:-0}"
ADM_LOG="${ADM_LOG:-/usr/src/adm/logs/glibc-install.log}"
# default safe DESTDIR inside ADM tree if not provided
DESTDIR="${DESTDIR:-${ADM_ROOT:-/usr/src/adm}/tmp/glibc-destdir}"
LFS="${LFS:-/mnt/lfs}"

# STRICT SAFETY CHECKS:
if [ -z "${DESTDIR:-}" ]; then
  echo "‚ùå RISCO: DESTDIR is empty. Aborting to avoid installing to host root."
  echo "[`date -u`] ABORT: DESTDIR empty" >> "$ADM_LOG"
  exit 2
fi
# normalize trailing slash
_norm_dest="${DESTDIR%/}"
if [ "${_norm_dest}" = "" ] || [ "${_norm_dest}" = "/" ]; then
  echo "‚ùå RISCO: DESTDIR resolves to root (/). Aborting to avoid system corruption."
  echo "[`date -u`] ABORT: DESTDIR would be root ($DESTDIR)" >> "$ADM_LOG"
  exit 2
fi

echo "‚ÑπÔ∏è  DESTDIR verified safe: $DESTDIR"
echo "[`date -u`] pre-install start: DESTDIR=${DESTDIR}" >> "$ADM_LOG"

# Danger warning (user-facing)
echo "## RISCO: make install MUST use DESTDIR. Installing directly to / will likely break the system."

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) would run: make DESTDIR=$DESTDIR install"
  exit 0
fi

# Perform install and capture output
if ! make DESTDIR="$DESTDIR" install > install.out 2>&1; then
  echo "‚ùå make install failed ‚Äî see install.out"
  tail -n 200 install.out || true
  echo "[`date -u`] make install failed (see install.out)" >> "$ADM_LOG"
  exit 1
fi

# Fix hard-coded ldd path in installed script per LFS:
if [ -f "$DESTDIR/usr/bin/ldd" ]; then
  sed -i '/RTLDLIST=/s@/usr@@g' "$DESTDIR/usr/bin/ldd" || true
  echo "[`date -u`] ldd script patched" >> "$ADM_LOG"
else
  echo "‚ö†Ô∏è  ldd script not found in $DESTDIR/usr/bin/ldd"
fi

echo "‚úÖ [glibc pre-install] Install into DESTDIR complete: $DESTDIR"
