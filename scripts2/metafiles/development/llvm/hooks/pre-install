#!/usr/bin/env bash
# ADM HOOK: llvm pre-install
# Instala a build para um DESTDIR seguro (valida√ß√£o estrita)
set -euo pipefail

echo "üì¶ [llvm pre-install] Preparando instala√ß√£o..."
DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/llvm-install.log}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/llvm-destdir}"
BUILD_DIR="${BUILD_DIR:-$(pwd)/build}"

# Valida√ß√£o DESTDIR estrita
if [ -z "${DESTDIR:-}" ]; then
  echo "‚ùå RISCO: DESTDIR vazio. Abortando."
  exit 2
fi
_norm_dest="${DESTDIR%/}"
if [ "${_norm_dest}" = "" ] || [ "${_norm_dest}" = "/" ]; then
  echo "‚ùå RISCO: DESTDIR resolve para / - abortando para proteger o sistema."
  exit 2
fi

echo "‚ÑπÔ∏è  DESTDIR validado: $DESTDIR"
mkdir -p "$DESTDIR" || true

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) make install to DESTDIR=$DESTDIR"
  exit 0
fi

pushd "$BUILD_DIR" >/dev/null
# Usar ninja install (cmake -G Ninja)
if ! ninja install DESTDIR="$DESTDIR" > install.out 2>&1; then
  echo "‚ùå Falha no ninja install ‚Äî ver install.out"
  tail -n 200 install.out || true
  popd >/dev/null
  exit 1
fi
popd >/dev/null

echo "[`date -u`] installed into $DESTDIR" >> "$ADM_LOG"
echo "‚úÖ [llvm pre-install] Instala√ß√£o em DESTDIR conclu√≠da"
