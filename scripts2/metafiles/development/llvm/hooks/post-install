#!/usr/bin/env bash
# ADM HOOK: llvm post-install
# Valida instala√ß√£o, executa checagens (clang --version) e limpeza de arquivos tempor√°rios
set -euo pipefail

echo "üîß [llvm post-install] Checando instala√ß√£o..."
DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/llvm-install.log}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/llvm-destdir}"
PREFIX="${PREFIX:-/usr}"

# DESTDIR validation
if [ -z "${DESTDIR:-}" ] || [ "${DESTDIR}" = "/" ]; then
  echo "‚ùå RISCO: DESTDIR inv√°lido. Abortando."
  exit 2
fi

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) checaria clang --version inside DESTDIR"
  exit 0
fi

# Use clang inside DESTDIR if present
if [ -x "${DESTDIR}${PREFIX}/bin/clang" ]; then
  ver="$("${DESTDIR}${PREFIX}/bin/clang" --version 2>/dev/null | head -n1 || echo unknown)"
  echo "‚úîÔ∏è  clang instalado: $ver"
  echo "$ver" > "${DESTDIR}${PREFIX}/lib/llvm.version" || true
else
  echo "‚ö†Ô∏è  clang n√£o encontrado em ${DESTDIR}${PREFIX}/bin/"
  # procurar em dest tree
  alt="$(find "${DESTDIR}" -type f -path "*/bin/clang" -print -quit || true)"
  if [ -n "$alt" ]; then
    ver="$("$alt" --version 2>/dev/null | head -n1 || echo unknown)"
    echo "‚úîÔ∏è  clang encontrado em $alt: $ver"
    echo "$ver" > "${DESTDIR}${PREFIX}/lib/llvm.version" || true
  else
    echo "‚ùå clang n√£o detectado ‚Äî instala√ß√£o possivelmente falhou"
    exit 1
  fi
fi

# Limpeza: remover arquivos .la se houver e logs tempor√°rios
find "${DESTDIR}" -name '*.la' -delete 2>/dev/null || true
rm -f "${ADM_ROOT}/logs/llvm-build.log" 2>/dev/null || true

echo "[`date -u`] llvm installed OK" >> "$ADM_LOG"
echo "‚úÖ [llvm post-install] Verifica√ß√£o final conclu√≠da"
