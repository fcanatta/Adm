#!/usr/bin/env bash
# ADM HOOK: GCC post-build
# Executado apÃ³s make (antes de instalar)
# ResponsÃ¡vel por rodar testes e validar binÃ¡rios

set -euo pipefail

echo "ðŸ” [GCC post-build] Validando build..."

# Detectar stage
ADM_STAGE="${ADM_STAGE:-$(cat /etc/adm-stage 2>/dev/null || echo stage3)}"

# Rodar testes apenas fora de bootstrap
if [[ "$ADM_STAGE" =~ stage0|stage1 ]]; then
  echo "â„¹ï¸  Testes desativados para bootstrap (${ADM_STAGE})"
else
  echo "âš™ï¸  Executando 'make -k check' (isso pode demorar)"
  if [ "${DRY_RUN:-0}" -eq 0 ]; then
    make -k check || echo "âš ï¸  Alguns testes falharam, continue com cautela"
  else
    echo "(dry-run) simulando testes"
  fi
fi

# Registrar sumÃ¡rio
if [ "${DRY_RUN:-0}" -eq 0 ]; then
  echo "[`date -u`] Testes finalizados para GCC ($ADM_STAGE)" >> "${ADM_LOG:-/usr/src/adm/logs/gcc-build.log}"
fi

echo "âœ… [GCC post-build] Etapa concluÃ­da"
