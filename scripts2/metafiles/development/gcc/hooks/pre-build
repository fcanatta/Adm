#!/usr/bin/env bash
# ADM HOOK: GCC pre-build
# Executado automaticamente antes do ./configure
# Respons√°vel por preparar ambiente, flags e build dir

set -euo pipefail

echo "üîß [GCC pre-build] Preparando ambiente para compila√ß√£o..."

# Detectar stage automaticamente
ADM_STAGE="${ADM_STAGE:-$(cat /etc/adm-stage 2>/dev/null || echo stage3)}"
echo "‚ÑπÔ∏è  Stage detectado: ${ADM_STAGE}"

# Garantir diret√≥rio de build isolado
mkdir -p build
cd build

# Definir perfil de compila√ß√£o
ADM_PROFILE="${ADM_PROFILE:-normal}"
case "$ADM_PROFILE" in
  extreme)
    export CFLAGS="-O3 -march=native -pipe -flto"
    export CXXFLAGS="$CFLAGS"
    export LDFLAGS="-Wl,-O1,--as-needed"
    echo "‚öôÔ∏è  Usando perfil extremo (LTO, O3, native)"
    ;;
  normal)
    export CFLAGS="-O2 -pipe"
    export CXXFLAGS="$CFLAGS"
    export LDFLAGS="-Wl,-O1"
    echo "‚öôÔ∏è  Usando perfil normal"
    ;;
  none)
    export CFLAGS=""
    export CXXFLAGS=""
    export LDFLAGS=""
    echo "‚öôÔ∏è  Usando perfil m√≠nimo (bootstrap seguro)"
    ;;
esac

# Definir prefixo
PREFIX="${PREFIX:-/usr}"

# Montar comando configure
CONFIGURE_CMD="../configure --prefix=${PREFIX} --enable-languages=c,c++ --disable-multilib"

# Adicionar op√ß√µes de stage
case "$ADM_STAGE" in
  stage0|stage1)
    CONFIGURE_CMD="${CONFIGURE_CMD} --disable-bootstrap --with-newlib --without-headers"
    ;;
  stage2|stage3)
    CONFIGURE_CMD="${CONFIGURE_CMD} --enable-bootstrap"
    ;;
esac

# Verificar depend√™ncias obrigat√≥rias
for dep in gmp mpfr mpc isl; do
  if ! ldconfig -p | grep -q "$dep" && [ ! -d "/usr/lib/$dep" ]; then
    echo "‚ö†Ô∏è  Depend√™ncia $dep n√£o encontrada (pode falhar na configura√ß√£o)"
  fi
done

echo "üèóÔ∏è  Comando de configura√ß√£o preparado:"
echo "    $CONFIGURE_CMD"

# Registrar no log de build
echo "[`date -u`] $CONFIGURE_CMD" >> "${ADM_LOG:-/usr/src/adm/logs/gcc-build.log}"

# Apenas executar se n√£o for dry-run
if [ "${DRY_RUN:-0}" -eq 0 ]; then
  eval "$CONFIGURE_CMD"
else
  echo "(dry-run) simulando configura√ß√£o"
fi
