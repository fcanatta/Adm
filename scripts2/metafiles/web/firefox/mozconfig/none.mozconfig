# ===============================================
# Mozilla Firefox - mozconfig (profile = none)
# Build m√≠nimo para bootstrap (stage0/stage1)
# Nenhuma otimiza√ß√£o, sem debug pesado, sem LTO, sem PGO.
# Compat√≠vel com ambientes chroot e toolchains incompletas.
# ===============================================

# Caminho do diret√≥rio de build (objdir separado)
mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-firefox

# ===============================================
# üß© Configura√ß√µes gerais
# ===============================================

# Aplica√ß√£o alvo
ac_add_options --enable-application=browser

# Build mais simples e est√°vel poss√≠vel
ac_add_options --disable-debug
ac_add_options --disable-tests
ac_add_options --disable-updater
ac_add_options --disable-crashreporter
ac_add_options --disable-install-strip
ac_add_options --disable-elf-hack
ac_add_options --disable-profiling
ac_add_options --disable-strip
ac_add_options --disable-optimize
ac_add_options --disable-lto
ac_add_options --disable-sandbox
ac_add_options --disable-webrtc
ac_add_options --disable-av1
ac_add_options --disable-libproxy
ac_add_options --disable-official-branding
ac_add_options --disable-verify-mar
ac_add_options --disable-eme
ac_add_options --disable-parental-controls

# Sem modo release ‚Äî apenas build funcional b√°sico
# Ideal para bootstrap e toolchain de teste
ac_add_options --enable-default-toolkit=cairo-gtk3

# ===============================================
# ü¶Ä Rust / LLVM m√≠nimos
# ===============================================

# Usa gcc/ld padr√£o se clang n√£o estiver dispon√≠vel
CC=${CC:-gcc}
CXX=${CXX:-g++}
LD=${LD:-ld}

# Se clang dispon√≠vel, usa ele (mais previs√≠vel)
if which clang >/dev/null 2>&1; then
  CC=clang
  CXX=clang++
  LD=lld
fi

export CC CXX LD

# Desativa otimiza√ß√µes Rust
export RUSTFLAGS="-C opt-level=0 -C debuginfo=1"
export CARGO_INCREMENTAL=1

# ===============================================
# üî® Simplifica√ß√µes de build
# ===============================================

# Menor paralelismo para ambientes pequenos
mk_add_options MOZ_MAKE_FLAGS=-j2

# Desativa uso de ccache (para evitar ru√≠dos no bootstrap)
unset CCACHE_DIR || true
ac_add_options --without-ccache

# Evita LTO/PGO e reprodutibilidade for√ßada
unset MOZ_LTO
unset MOZ_THIN_LTO
unset ADM_PGO

# ===============================================
# üì¶ Paths de instala√ß√£o e output
# ===============================================

# Prefixo /usr (mas adm-build mover√° via DESTDIR)
ac_add_options --prefix=/usr
ac_add_options --libdir=/usr/lib
ac_add_options --bindir=/usr/bin

# ===============================================
# üåê Depend√™ncias m√≠nimas
# ===============================================

# Usa bibliotecas do sistema, reduzindo build interno
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
ac_add_options --without-system-libvpx
ac_add_options --without-system-icu
ac_add_options --without-system-pixman
ac_add_options --without-system-harfbuzz
ac_add_options --without-system-freetype

# ===============================================
# üîí Seguran√ßa e estabilidade
# ===============================================

# Sem sandbox (para permitir execu√ß√£o em bootstrap)
ac_add_options --disable-content-sandbox

# Nenhum hardening (melhor compatibilidade inicial)
ac_add_options --disable-hardening

# ===============================================
# üìú Registro e diagn√≥stico
# ===============================================

# Verbose logging para debugging b√°sico
export MOZ_VERBOSE_LOGGING=1
export RUST_BACKTRACE=1

# ===============================================
# üßπ P√≥s-build (manuten√ß√£o)
# ===============================================

# N√£o stripar bin√°rios (√∫til para debugging)
STRIP_FLAGS=""
export STRIP_FLAGS

# O adm-post-build empacotar√° dist/bin sem limpeza extra
