# ===============================================
# Mozilla Firefox - mozconfig (profile = extreme)
# Otimizado para performance m√°xima, builds est√°veis e bin√°rios compactos
# Compat√≠vel com sistema ADM e pipeline adm-build
# ===============================================

# Caminho do diret√≥rio de build (objdir)
mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-firefox

# ===============================================
# üß© Configura√ß√µes gerais do build
# ===============================================

# Aplica√ß√£o alvo: Firefox
ac_add_options --enable-application=browser

# Tipo de build: otimizado e com s√≠mbolos m√≠nimos
ac_add_options --enable-optimize="-O3 -pipe -march=native -flto=auto -fuse-ld=lld"
ac_add_options --enable-strip
ac_add_options --disable-debug
ac_add_options --enable-release

# Desativar recursos n√£o essenciais para reduzir tamanho e tempo de build
ac_add_options --disable-tests
ac_add_options --disable-updater
ac_add_options --disable-crashreporter
ac_add_options --disable-install-strip
ac_add_options --disable-elf-hack

# Desativar sandbox de build (gera bin√°rios ligeiramente menores)
# ac_add_options --disable-sandbox  # opcional, se necess√°rio

# ===============================================
# ü¶Ä Integra√ß√£o com Rust / LLVM / LTO
# ===============================================

# For√ßa uso do clang e lld (melhor performance de linkagem)
CC=clang
CXX=clang++
LD=lld

# Ativa LTO e ThinLTO (Link-Time Optimization)
RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-fuse-ld=lld -C embed-bitcode=yes"
export RUSTFLAGS
export MOZ_LTO=1
export MOZ_THIN_LTO=1

# Rust incremental off ‚Üí builds reprodut√≠veis e r√°pidos em LTO
export CARGO_INCREMENTAL=0
export RUSTC_OPT_LEVEL=3

# ===============================================
# üß† PGO (Profile-Guided Optimization)
# ===============================================
# O PGO √© feito em duas etapas:
#   1. Build de instrumenta√ß√£o (com `--enable-profile-generate`)
#   2. Execu√ß√£o do Firefox instrumentado em modo headless
#   3. Rebuild final (com `--enable-profile-use`)
#
# As op√ß√µes abaixo est√£o preparadas, mas desabilitadas por padr√£o.
# Para usar PGO: defina `ADM_PGO=1` antes do build.

if [ "${ADM_PGO:-0}" -eq 1 ]; then
  ac_add_options --enable-profile-use
else
  # Primeira compila√ß√£o sem PGO
  ac_add_options --enable-profile-generate
fi

# ===============================================
# ‚öôÔ∏è Suporte a multithread, ccache e pipelines
# ===============================================

# Ativa uso de m√∫ltiplos jobs
mk_add_options MOZ_MAKE_FLAGS=-j$(nproc)

# Ativa ccache se dispon√≠vel
if which ccache >/dev/null 2>&1; then
  mk_add_options "CCACHE=ccache"
  export CCACHE_DIR="${CCACHE_DIR:-/usr/src/adm/cache/ccache}"
  export CCACHE_COMPRESS=1
  export CCACHE_SLOPPINESS=time_macros
fi

# ===============================================
# üîä Integra√ß√£o com √°udio e v√≠deo
# ===============================================

# Ativar integra√ß√£o com PulseAudio e PipeWire (conforme build_deps)
ac_add_options --enable-pulseaudio
ac_add_options --enable-webrtc
ac_add_options --enable-alsa
ac_add_options --enable-ffmpeg
ac_add_options --enable-av1

# ===============================================
# üåê Idioma, internacionaliza√ß√£o e localiza√ß√£o
# ===============================================

ac_add_options --with-l10n-base=@TOPSRCDIR@/l10n
ac_add_options --enable-ui-locale=en-US

# ===============================================
# üì¶ Paths de instala√ß√£o e output
# ===============================================

# Prefixo padr√£o /usr (sistema ADM mover√° via DESTDIR)
ac_add_options --prefix=/usr
ac_add_options --libdir=/usr/lib
ac_add_options --bindir=/usr/bin

# ===============================================
# üîí Seguran√ßa e integridade
# ===============================================

# Ativar suporte a sandbox de conte√∫do (mant√©m seguran√ßa)
ac_add_options --enable-content-sandbox
ac_add_options --enable-hardening
ac_add_options --enable-default-toolkit=cairo-gtk3

# Ativar uso de NSS/NSPR externos (mais seguros e consistentes)
ac_add_options --with-system-nspr
ac_add_options --with-system-nss

# ===============================================
# üìú Registro e diagn√≥stico
# ===============================================

# Logs detalhados (apenas se necess√°rio)
# export MOZ_VERBOSE_LOGGING=1
# export RUST_BACKTRACE=1

# ===============================================
# üßπ Limpeza e empacotamento
# ===============================================

# Ap√≥s build, `post-build` do ADM empacota o dist/bin/
# Aqui apenas garantimos que n√£o h√° s√≠mbolos desnecess√°rios
STRIP_FLAGS="--strip-unneeded"
export STRIP_FLAGS
