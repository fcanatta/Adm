#!/usr/bin/env bash
#
# ADM HOOK: Firefox pre-install
# - Valida DESTDIR (nÃ£o vazio, nÃ£o "/"), cria estrutura e instala pacote/arquivos nele.
# - Para Firefox, normalmente usamos empacotamento (tar) do dist e extraÃ­mos em DESTDIR.
#
set -euo pipefail

echo "ðŸ“¦ [firefox pre-install] Preparando DESTDIR e instalando artefatos..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/firefox-install.log}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/firefox-destdir}"
PKG_FILE="${PKG_FILE:-${ADM_ROOT}/cache/firefox-${VERSION:-unknown}.tar.xz}"

# STRICT DESTDIR checks (prevent host overwrite)
if [ -z "${DESTDIR:-}" ]; then
  echo "âŒ RISCO: DESTDIR vazio. Abortando."
  echo "[`date -u`] ABORT pre-install: DESTDIR vazio" >> "$ADM_LOG"
  exit 2
fi
_norm_dest="${DESTDIR%/}"
if [ "${_norm_dest}" = "" ] || [ "${_norm_dest}" = "/" ]; then
  echo "âŒ RISCO: DESTDIR resolve para root. Abortando."
  echo "[`date -u`] ABORT pre-install: DESTDIR root ($DESTDIR)" >> "$ADM_LOG"
  exit 2
fi

echo "â„¹ï¸  DESTDIR validado: $DESTDIR"
mkdir -p "$DESTDIR" || true

# If package file exists, extract; else, try to copy dist dir
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) instalaria pacote $PKG_FILE em $DESTDIR"
  exit 0
fi

if [ -f "$PKG_FILE" ]; then
  echo "ðŸ“¦ Extraindo pacote $PKG_FILE em $DESTDIR..."
  tar -C "$DESTDIR" -xJf "$PKG_FILE" || { echo "âŒ Falha ao extrair pacote"; exit 1; }
else
  # fallback: copy dist files from objdir if present
  OBJDIR="${OBJDIR:-${SRC_DIR:-.}/obj-firefox}"
  DIST_DIR="${DIST_DIR:-${OBJDIR}/dist}"
  if [ -d "$DIST_DIR" ]; then
    echo "ðŸ“ Copiando $DIST_DIR -> $DESTDIR"
    mkdir -p "$DESTDIR"
    cp -a "$DIST_DIR/." "$DESTDIR/" || { echo "âŒ Falha ao copiar dist -> DESTDIR"; exit 1; }
  else
    echo "âŒ Nenhum pacote encontrado e dist dir ausente (PKG_FILE=$PKG_FILE, DIST_DIR=$DIST_DIR)"
    exit 2
  fi
fi

# Ajustar permissÃµes bÃ¡sicas
echo "ðŸ” Ajustando permissÃµes (binÃ¡rios executÃ¡veis)"
find "$DESTDIR" -type f -perm -u+x -print0 2>/dev/null | xargs -0 -r chmod u+x 2>/dev/null || true

echo "[`date -u`] pre-install completed: installed into $DESTDIR" >> "$ADM_LOG"
echo "âœ… [firefox pre-install] ConcluÃ­do"
