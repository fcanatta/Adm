#!/usr/bin/env bash
#
# ADM HOOK: Firefox post-build
# - Verifica sucesso da compilaÃ§Ã£o, executa checagens mÃ­nimas, prepara pacote (tarball / package)
# - Respeita DRY_RUN
#
set -euo pipefail

echo "ðŸ” [firefox post-build] Iniciando validaÃ§Ã£o e empacotamento..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/firefox-build.log}"
SRC_DIR="$(pwd)"
OBJDIR="${OBJDIR:-${SRC_DIR}/obj-firefox}"
DIST_DIR="${DIST_DIR:-${OBJDIR}/dist}"
PACKAGE_NAME="${PACKAGE_NAME:-firefox-${VERSION:-unknown}}"

echo "[`date -u`] post-build start" >> "$ADM_LOG"

# 0) sanity: verificar se objdir existe e contÃ©m binÃ¡rios
if [ ! -d "$OBJDIR" ]; then
  echo "âŒ OBJDIR nÃ£o encontrado: $OBJDIR - build nÃ£o executado?"
  echo "[`date -u`] post-build abort: objdir missing" >> "$ADM_LOG"
  exit 1
fi

# 1) Checar execuÃ§Ã£o do build: procurar binÃ¡rio principal
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) verificaria presenÃ§a de binÃ¡rios em $OBJDIR"
else
  # exemplo: linux64 build produz dist/bin/firefox
  if [ ! -x "${OBJDIR}/dist/bin/firefox" ]; then
    echo "âš ï¸  firefox binÃ¡rio nÃ£o encontrado em ${OBJDIR}/dist/bin/firefox"
    # tentar detecÃ§Ã£o alternativa
    if ls "${OBJDIR}"/dist*/bin/firefox >/dev/null 2>&1; then
      echo "â„¹ï¸  firefox encontrado em dist*"
    else
      echo "âŒ Build parece ter falhado (binÃ¡rio ausente). Aborting."
      echo "[`date -u`] post-build abort: binary not found" >> "$ADM_LOG"
      exit 2
    fi
  fi
fi

# 2) Executar testes funcionais mÃ­nimos (opcional)
if [ "${RUN_SMOKE_TESTS:-1}" -eq 1 ] && [ "$DRY_RUN" -eq 0 ]; then
  echo "âš™ï¸  Executando smoke tests bÃ¡sicos (headless)"
  # Se mozprocess/marionette etc estiverem disponÃ­veis, rodar testes; caso contrÃ¡rio, skip
  # Aqui faremos um teste simples: --headless -v -silent startup verifica que o binÃ¡rio inicia
  "${OBJDIR}/dist/bin/firefox" --headless --version >/dev/null 2>&1 || {
    echo "âš ï¸  smoke test: firefox nÃ£o inicializou corretamente"
    echo "[`date -u`] smoke test failed" >> "$ADM_LOG"
    # nÃ£o aborta automaticamente; marca warn
  }
fi

# 3) Empacotar artefatos: criar tar.xz/zip a partir do dist dir
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) criaria pacote a partir de $DIST_DIR"
  exit 0
fi

mkdir -p "${ADM_ROOT}/cache" 2>/dev/null || true
PKG_FILE="${ADM_ROOT}/cache/${PACKAGE_NAME}.tar.xz"

if [ -d "$DIST_DIR" ]; then
  echo "ðŸ“¦ Empacotando $DIST_DIR -> $PKG_FILE (isso pode demorar)"
  tar -C "$DIST_DIR" -cJf "$PKG_FILE" . || { echo "âŒ Falha ao empacotar"; exit 1; }
  echo "[`date -u`] Packaged: $PKG_FILE" >> "$ADM_LOG"
  echo "âœ… Pacote gerado: $PKG_FILE"
else
  echo "âš ï¸ Dist dir nÃ£o encontrado: $DIST_DIR (pode ser que o build use outro caminho)"
  # tentar localizar dist
  alt="$(find "$OBJDIR" -maxdepth 3 -type d -name 'dist*' -print -quit || true)"
  if [ -n "$alt" ]; then
    echo "â„¹ï¸  Usando dist alternativo: $alt"
    tar -C "$alt" -cJf "$PKG_FILE" . || { echo "âŒ Falha ao empacotar (alt)"; exit 1; }
    echo "âœ… Pacote gerado (alt): $PKG_FILE"
  else
    echo "âŒ NÃ£o foi possÃ­vel criar pacote: diretÃ³rio de saÃ­da nÃ£o encontrado"
    exit 2
  fi
fi

# 4) Gerar checksums do pacote
sha256sum "$PKG_FILE" > "${PKG_FILE}.sha256" || true
echo "[`date -u`] checksum criado: ${PKG_FILE}.sha256" >> "$ADM_LOG"

echo "âœ… [firefox post-build] Finalizado"
