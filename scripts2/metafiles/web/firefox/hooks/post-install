#!/usr/bin/env bash
#
# ADM HOOK: Firefox post-install
# - Executa aÃ§Ãµes pÃ³s-instalaÃ§Ã£o dentro do DESTDIR:
#   - corrige desktop entries, atualiza cache de Ã­cones (somente no target/rootfs),
#   - gera registro de versÃ£o e limpa arquivos temporÃ¡rios.
# - NÃƒO executa comandos que alterem o host como update-desktop-database global ou gtk-update-icon-cache fora do DESTDIR.
#
set -euo pipefail

echo "ðŸ”§ [firefox post-install] Ajustes finais no DESTDIR..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/firefox-install.log}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/firefox-destdir}"
PREFIX="${PREFIX:-/usr}"
BIN_PATH="${DESTDIR}${PREFIX}/bin"

echo "[`date -u`] post-install start for DESTDIR=${DESTDIR}" >> "$ADM_LOG"

# DESTDIR safety check
if [ -z "${DESTDIR:-}" ]; then
  echo "âŒ RISCO: DESTDIR vazio. Abortando."
  exit 2
fi
_norm_dest="${DESTDIR%/}"
if [ "${_norm_dest}" = "" ] || [ "${_norm_dest}" = "/" ]; then
  echo "âŒ RISCO: DESTDIR resolves to root. Abortando."
  exit 2
fi

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) executaria ajustes pÃ³s-instalaÃ§Ã£o dentro de $DESTDIR"
  exit 0
fi

# 1) Registrar versÃ£o
if [ -x "$BIN_PATH/firefox" ]; then
  ver="$("$BIN_PATH/firefox" --version 2>/dev/null | head -n1 || echo unknown)"
  mkdir -p "$DESTDIR/var/lib/firefox" 2>/dev/null || true
  echo "$ver" > "$DESTDIR/var/lib/firefox/version" || true
  echo "â„¹ï¸  VersÃ£o registrada: $ver"
fi

# 2) Desktop entry: ajustar caminhos relativos se necessÃ¡rio
DESKTOP_FILE_REL="${PREFIX}/share/applications/firefox.desktop"
if [ -f "$DESTDIR/$DESKTOP_FILE_REL" ]; then
  # garantir Exec usando caminho dentro do prefix
  sed -i "s|Exec=firefox|Exec=${PREFIX}/bin/firefox|g" "$DESTDIR/$DESKTOP_FILE_REL" || true
  echo "â„¹ï¸  Arquivo .desktop ajustado: $DESKTOP_FILE_REL"
fi

# 3) Atualizar cache de Ã­cones dentro do dest (apenas se gtk-update-icon-cache disponÃ­vel no chroot)
if [ -x "$DESTDIR/usr/bin/gtk-update-icon-cache" ]; then
  echo "âš™ï¸  Atualizando cache de Ã­cones dentro do DESTDIR"
  chroot "$DESTDIR" /usr/bin/gtk-update-icon-cache -f -t /usr/share/icons/hicolor || true
else
  echo "â„¹ï¸  gtk-update-icon-cache nÃ£o disponÃ­vel dentro do DESTDIR (ignorando)"
fi

# 4) Limpeza opcional de arquivos temporÃ¡rios, sÃ­mbolos .la
find "$DESTDIR" -name '*.la' -delete 2>/dev/null || true
echo "ðŸ§¹ Limpeza de arquivos .la concluÃ­da"

echo "[`date -u`] post-install completed" >> "$ADM_LOG"
echo "âœ… [firefox post-install] Finalizado"
