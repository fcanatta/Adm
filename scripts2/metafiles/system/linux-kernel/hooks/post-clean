#!/usr/bin/env bash
#
# ADM HOOK: linux-kernel post-clean
# - Remove diretÃ³rios temporÃ¡rios e artefatos antigos de build.
# - Evita tocar /usr, /lib ou qualquer coisa fora do SRC_DIR.
#
set -euo pipefail

echo "ðŸ§¹ [linux-kernel post-clean] Limpando diretÃ³rios temporÃ¡rios..."

DRY_RUN="${DRY_RUN:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/linux-kernel-clean.log}"
SRC_DIR="${SRC_DIR:-$(pwd)}"

echo "[`date -u`] post-clean start" >> "$ADM_LOG"

if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) removeria build/, tmp/ e arquivos *.o"
  exit 0
fi

for dir in "$SRC_DIR/build" "$SRC_DIR/tmp"; do
  if [ -d "$dir" ]; then
    echo "ðŸ—‘ï¸  Removendo $dir ..."
    rm -rf "$dir" 2>/dev/null || true
  fi
done

find "$SRC_DIR" -type f -name '*.o' -delete 2>/dev/null || true
find "$SRC_DIR" -type f -name '*.cmd' -delete 2>/dev/null || true

echo "[`date -u`] post-clean complete" >> "$ADM_LOG"
echo "âœ… [linux-kernel post-clean] Limpeza concluÃ­da."
