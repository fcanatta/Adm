#!/usr/bin/env bash
# ADM HOOK: linux-kernel pre-install
# Instala kernel image, System.map e modules em DESTDIR seguro (INSTALACAO)
# Usa make INSTALL_MOD_PATH and manual copy; valida DESTDIR estritamente
set -euo pipefail

echo "ðŸ“¦ [linux-kernel pre-install] Preparando instalaÃ§Ã£o..."

DRY_RUN="${DRY_RUN:-0}"
FORCE="${FORCE:-0}"
ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_LOG="${ADM_LOG:-${ADM_ROOT}/logs/linux-kernel-preinstall.log}"
SRC_DIR="${SRC_DIR:-$(pwd)}"
DESTDIR="${DESTDIR:-${ADM_ROOT}/tmp/linux-kernel-destdir}"
PREFIX="${PREFIX:-/usr}"
KIMAGE_DEST="${DESTDIR}/boot"
MODULES_DEST="${DESTDIR}/lib/modules"
MAKEFLAGS="${MAKEFLAGS:--j$(nproc)}"

mkdir -p "$(dirname "$ADM_LOG")" || true
echo "[`date -u`] pre-install start (DESTDIR=${DESTDIR})" >> "$ADM_LOG"

# STRICT DESTDIR checks
if [ -z "${DESTDIR:-}" ]; then
  echo "âŒ RISCO: DESTDIR vazio. Abortando."
  exit 2
fi
_norm_dest="${DESTDIR%/}"
if [ "${_norm_dest}" = "" ] || [ "${_norm_dest}" = "/" ]; then
  echo "âŒ RISCO: DESTDIR resolve para / - abortando para proteger o host."
  exit 2
fi

mkdir -p "$KIMAGE_DEST" "$MODULES_DEST" 2>/dev/null || true

# If dry-run, show planned commands
if [ "$DRY_RUN" -eq 1 ]; then
  echo "(dry-run) make -C ${SRC_DIR} INSTALL_MOD_PATH=${DESTDIR} modules_install"
  echo "(dry-run) cp -v <kernel-image> ${KIMAGE_DEST}/"
  exit 0
fi

# 1) install modules into DESTDIR using INSTALL_MOD_PATH
echo "âš™ï¸  Instalando mÃ³dulos (INSTALL_MOD_PATH=${DESTDIR}) ..."
if ! make -C "${SRC_DIR}" INSTALL_MOD_PATH="${DESTDIR}" modules_install > "${DESTDIR}/modules_install.log" 2>&1; then
  echo "âŒ modules_install falhou â€” ver ${DESTDIR}/modules_install.log"
  tail -n 80 "${DESTDIR}/modules_install.log" || true
  if [ "${FORCE}" -ne 1 ]; then
    exit 1
  fi
fi

# 2) copy kernel image(s)
# Locate kernel image
KIMG=""
for candidate in "arch/$(uname -m)/boot/bzImage" "arch/x86/boot/bzImage" "vmlinux" "arch/$(uname -m)/boot/Image"; do
  if [ -f "${SRC_DIR}/${candidate}" ]; then
    KIMG="${SRC_DIR}/${candidate}"
    break
  fi
done
if [ -z "$KIMG" ]; then
  KIMG="$(find "${SRC_DIR}" -type f -name 'bzImage' -o -name 'vmlinuz' -print -quit 2>/dev/null || true)"
fi

if [ -z "$KIMG" ]; then
  echo "âŒ Kernel image nÃ£o encontrada â€” abortando instalaÃ§Ã£o."
  exit 2
fi

echo "â„¹ï¸  Copiando kernel image ${KIMG} -> ${KIMAGE_DEST}/"
cp -av "$KIMG" "${KIMAGE_DEST}/" || {
  echo "âŒ Falha ao copiar kernel image"
  exit 1
}

# 3) copy System.map if exists
if [ -f "${SRC_DIR}/System.map" ]; then
  cp -av "${SRC_DIR}/System.map" "${KIMAGE_DEST}/System.map-$(uname -r)" || true
fi

echo "[`date -u`] pre-install completed: kernel+modules staged into ${DESTDIR}" >> "$ADM_LOG"
echo "âœ… [linux-kernel pre-install] Instalado em DESTDIR."
