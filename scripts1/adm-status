#!/usr/bin/env bash
# ================================================================
# adm-status v1.0
# Status e diagnóstico completo do ambiente ADM.
# ================================================================

set -euo pipefail
IFS=$'\n\t'

ADM_ROOT=${ADM_ROOT:-/usr/src/adm}
BUILD_DIR="$ADM_ROOT/build"
PKG_DIR="$ADM_ROOT/packages"
INSTALLED_DIR="$ADM_ROOT/installed"
LOG_DIR="$ADM_ROOT/logs"
BACKUP_DIR="$ADM_ROOT/inst-backups"
CFG_DIR="$ADM_ROOT/cfg"
UPD_DIR="$CFG_DIR/updates"
TMP_DIR="$ADM_ROOT/tmp"

mkdir -p "$BUILD_DIR" "$PKG_DIR" "$INSTALLED_DIR" "$LOG_DIR" "$BACKUP_DIR" "$TMP_DIR" "$UPD_DIR"

# ---------------------------
# COLORS
# ---------------------------
CLR_RESET='\e[0m'
CLR_MAGENTA='\e[95m'
CLR_GREEN='\e[92m'
CLR_CYAN='\e[96m'
CLR_YELLOW='\e[93m'
CLR_RED='\e[91m'
CLR_GRAY='\e[90m'

timestamp(){ date '+%Y-%m-%d %H:%M:%S'; }
headline(){ printf "%b%s%b %b=>%b %s\n" "$CLR_CYAN" "$(timestamp)" "$CLR_RESET" "$CLR_MAGENTA" "$CLR_RESET" "$1"; }
short_ok(){ printf "%b[✔]%b %s\n" "$CLR_GREEN" "$CLR_RESET" "$1"; }
short_fail(){ printf "%b[✖]%b %s\n" "$CLR_RED" "$CLR_RESET" "$1"; }
short_info(){ printf "%b[%s]%b %s\n" "$CLR_GREEN" "$(timestamp)" "$CLR_RESET" "$1"; }
short_warn(){ printf "%b[!]%b %s\n" "$CLR_YELLOW" "$CLR_RESET" "$1"; }

# ---------------------------
# ARGUMENTOS
# ---------------------------
MODE="summary"
JSON=0
DRY_RUN=0

USAGE="Usage: $(basename "$0") [--summary|--installed|--failed|--orphans|--logs|--updates|--verify] [--json] [--dry-run]"
while [[ $# -gt 0 ]]; do
    case "$1" in
        --summary) MODE="summary"; shift ;;
        --installed) MODE="installed"; shift ;;
        --failed) MODE="failed"; shift ;;
        --orphans) MODE="orphans"; shift ;;
        --logs) MODE="logs"; shift ;;
        --updates) MODE="updates"; shift ;;
        --verify) MODE="verify"; shift ;;
        --json) JSON=1; shift ;;
        --dry-run) DRY_RUN=1; shift ;;
        -h|--help) echo "$USAGE"; exit 0 ;;
        *) echo "Unknown arg: $1"; echo "$USAGE"; exit 1 ;;
    esac
done

# ---------------------------
# SAFETY & LOG
# ---------------------------
RUN_LOG="$LOG_DIR/adm-status.$(date +%Y%m%d-%H%M%S).log"
: >"$RUN_LOG"
log(){ printf "%s %s\n" "$(timestamp)" "$*" >>"$RUN_LOG"; }

headline "Coletando status (modo: $MODE)"

# ---------------------------
# FUNÇÕES
# ---------------------------

list_installed() {
    headline "Pacotes instalados:"
    shopt -s nullglob
    for m in "$INSTALLED_DIR"/*.manifest; do
        pkg=$(basename "$m" .manifest)
        meta="${m}.meta"
        dest="desconhecido"; ver="?"
        [[ -f "$meta" ]] && dest=$(grep '^installed_to:' "$meta" | awk '{print $2}') && ver=$(grep '^version:' "$meta" | awk '{print $2}')
        printf "%b%-25s%b %b%-12s%b %b%s%b\n" "$CLR_GREEN" "$pkg" "$CLR_RESET" "$CLR_CYAN" "$ver" "$CLR_RESET" "$CLR_GRAY" "$dest" "$CLR_RESET"
    done
    shopt -u nullglob
}

list_failed_builds() {
    headline "Builds falhados:"
    find "$BUILD_DIR" -type f -name ".state" -print0 2>/dev/null | while IFS= read -r -d '' st; do
        if grep -q "FAILED" "$st"; then
            pkg=$(basename "$(dirname "$st")")
            log_err="$LOG_DIR/${pkg}.build.err"
            printf "%b[✖]%b %-25s %b(ver log: %s)%b\n" "$CLR_RED" "$CLR_RESET" "$pkg" "$CLR_GRAY" "$log_err" "$CLR_RESET"
        fi
    done
}

list_orphans() {
    headline "Detectando pacotes órfãos..."
    declare -A deps
    for meta in "$INSTALLED_DIR"/*.meta; do
        [[ -f "$meta" ]] || continue
        grep -i '^depends:' "$meta" 2>/dev/null | while read -r line; do
            for d in ${line#depends:}; do deps["$d"]=1; done
        done
    done
    for m in "$INSTALLED_DIR"/*.manifest; do
        pkg=$(basename "$m" .manifest)
        if [[ -z "${deps["$pkg"]:-}" ]]; then
            printf "%b[~]%b %s (sem dependentes)\n" "$CLR_YELLOW" "$CLR_RESET" "$pkg"
        fi
    done
}

list_logs() {
    headline "Últimos logs:"
    find "$LOG_DIR" -type f -printf "%T@ %p\n" | sort -n | tail -n 10 | while read -r ts path; do
        ts_fmt=$(date -d "@${ts%.*}" '+%Y-%m-%d %H:%M:%S')
        size=$(du -h "$path" | awk '{print $1}')
        printf "%b%s%b  %b%-8s%b  %s\n" "$CLR_CYAN" "$ts_fmt" "$CLR_RESET" "$CLR_YELLOW" "$size" "$CLR_RESET" "$path"
    done
}

list_updates() {
    headline "Atualizações disponíveis:"
    if [[ -f "$UPD_DIR/source.list" ]]; then
        awk '{printf "%b%s%b\n", "\e[92m", $0, "\e[0m"}' "$UPD_DIR/source.list"
    else
        short_info "Nenhuma atualização detectada."
    fi
}

verify_integrity() {
    headline "Verificando integridade dos manifests e arquivos..."
    local errors=0
    for m in "$INSTALLED_DIR"/*.manifest; do
        [[ -f "$m" ]] || continue
        pkg=$(basename "$m" .manifest)
        while IFS= read -r rel; do
            f="/$rel"
            if [[ ! -e "$f" ]]; then
                short_warn "$pkg: arquivo ausente -> $f"
                ((errors++))
            fi
        done <"$m"
    done
    if (( errors > 0 )); then
        short_warn "Integridade falhou para $errors arquivo(s)!"
    else
        short_ok "Integridade verificada sem problemas."
    fi
}

print_summary() {
    headline "Resumo geral do sistema ADM"
    local total_builds total_pkgs total_installed total_failed total_orphans
    total_builds=$(find "$BUILD_DIR" -mindepth 1 -maxdepth 1 -type d | wc -l || echo 0)
    total_pkgs=$(find "$PKG_DIR" -type f -name "*.pkg.tar.*" | wc -l || echo 0)
    total_installed=$(find "$INSTALLED_DIR" -type f -name "*.manifest" | wc -l || echo 0)
    total_failed=$(grep -rl "FAILED" "$BUILD_DIR" 2>/dev/null | wc -l || echo 0)
    total_backups=$(find "$BACKUP_DIR" -mindepth 1 -type d | wc -l || echo 0)

    printf "%bBuilds:%b %-5s  %bPacotes:%b %-5s  %bInstalados:%b %-5s\n" \
        "$CLR_CYAN" "$CLR_RESET" "$total_builds" \
        "$CLR_CYAN" "$CLR_RESET" "$total_pkgs" \
        "$CLR_CYAN" "$CLR_RESET" "$total_installed"

    printf "%bFalhas:%b %-5s  %bBackups:%b %-5s  %bLogs:%b %-5s\n" \
        "$CLR_RED" "$CLR_RESET" "$total_failed" \
        "$CLR_MAGENTA" "$CLR_RESET" "$total_backups" \
        "$CLR_YELLOW" "$CLR_RESET" "$(find "$LOG_DIR" -type f | wc -l)"

    headline "Espaço usado:"
    du -sh "$BUILD_DIR" "$PKG_DIR" "$BACKUP_DIR" "$LOG_DIR" "$TMP_DIR" 2>/dev/null | awk '{printf " %-30s %10s\n",$2,$1}'
    short_ok "Resumo concluído"
}

# ---------------------------
# EXECUÇÃO
# ---------------------------
case "$MODE" in
    summary)
        print_summary
        ;;
    installed)
        list_installed
        ;;
    failed)
        list_failed_builds
        ;;
    orphans)
        list_orphans
        ;;
    logs)
        list_logs
        ;;
    updates)
        list_updates
        ;;
    verify)
        verify_integrity
        ;;
    *)
        short_fail "Modo inválido: $MODE"
        exit 1
        ;;
esac

headline "adm-status finalizado (log: $RUN_LOG)"
exit 0
