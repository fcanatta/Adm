#!/usr/bin/env bash
# ================================================================
# adm-init v2.0
# Inicializa o ambiente ADM. Cria estrutura, valida dependências,
# gera perfis de compilação, executa hooks e prepara o sistema.
# Reexecutável com segurança. Nenhum erro silencioso.
# ================================================================

set -euo pipefail
IFS=$'\n\t'

source /usr/src/adm/core/adm-core.sh

adm_headline "Inicializando o ambiente ADM"

# ---------------------------------------------------------------
# VARIÁVEIS DE CONTROLE
# ---------------------------------------------------------------
STATE_FILE="$CFG_DIR/init.state"
PROFILE_DIR="$CFG_DIR/profiles"
HOOK_PHASE="init"

# ---------------------------------------------------------------
# FUNÇÕES INTERNAS
# ---------------------------------------------------------------

create_structure() {
    adm_start_spinner "Criando estrutura de diretórios..."
    for dir in "$SRC_DIR" "$BUILD_DIR" "$PKG_DIR" "$INSTALLED_DIR" "$LOG_DIR" \
               "$BACKUP_DIR" "$CFG_DIR" "$HOOK_DIR/pre" "$HOOK_DIR/post" "$CACHE_DIR"; do
        safe_mkdir "$dir"
    done
    adm_stop_spinner 0 "Estrutura pronta."
}

validate_permissions() {
    adm_start_spinner "Validando permissões de diretórios..."
    chown -R "$(id -u):$(id -g)" "$ADM_ROOT" >/dev/null 2>&1 || true
    chmod -R u+rwX,go+rX "$ADM_ROOT" >/dev/null 2>&1 || true
    adm_stop_spinner 0 "Permissões corrigidas (se necessário)."
}

validate_tools() {
    adm_start_spinner "Verificando ferramentas essenciais..."
    local tools=(bash wget curl git rsync gcc make tar gzip xz)
    if ! adm_require_tools "${tools[@]}"; then
        adm_fail "Ferramentas essenciais ausentes. Instale-as e reexecute."
        exit 1
    fi
    adm_stop_spinner 0 "Ferramentas OK."
}

generate_profiles() {
    adm_start_spinner "Gerando perfis de compilação..."
    safe_mkdir "$PROFILE_DIR"

    # Standard - sem otimizações (bootstrap)
    cat >"$PROFILE_DIR/standard.conf" <<'EOF'
# Perfil padrão (sem otimizações)
CFLAGS="-O2 -pipe"
CXXFLAGS="-O2 -pipe"
LDFLAGS=""
MAKEFLAGS="-j$(nproc)"
EOF

    # Conservative - estável e seguro
    cat >"$PROFILE_DIR/conservative.conf" <<'EOF'
# Perfil conservador (otimização segura)
CFLAGS="-O2 -march=native -fstack-protector-strong -pipe"
CXXFLAGS="$CFLAGS"
LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"
MAKEFLAGS="-j$(nproc)"
EOF

    # Aggressive - desempenho máximo
    cat >"$PROFILE_DIR/aggressive.conf" <<'EOF'
# Perfil agressivo (máximo desempenho)
CFLAGS="-O3 -march=native -flto -fomit-frame-pointer -pipe"
CXXFLAGS="$CFLAGS"
LDFLAGS="-Wl,-O3,--as-needed"
MAKEFLAGS="-j$(nproc)"
EOF

    adm_stop_spinner 0 "Perfis criados em $PROFILE_DIR"
}

write_state() {
    local now
    now="$(timestamp)"
    echo "initialized_at=$now" >"$STATE_FILE"
    adm_ok "Estado gravado: $STATE_FILE"
}

verify_reinit() {
    if [[ -f "$STATE_FILE" ]]; then
        local last
        last=$(grep '^initialized_at=' "$STATE_FILE" | cut -d= -f2- || true)
        adm_warn "O ambiente já foi inicializado em: ${last:-desconhecido}"
        adm_info "Reexecutando em modo de verificação..."
    fi
}

final_summary() {
    adm_headline "Resumo da inicialização:"
    echo "  Diretórios principais criados em: $ADM_ROOT"
    echo "  Perfis de compilação: $PROFILE_DIR"
    echo "  Log central: $LOG_FILE"
    echo "  Estado: $STATE_FILE"
    echo
    adm_ok "Inicialização concluída com sucesso."
}

# ---------------------------------------------------------------
# EXECUÇÃO PRINCIPAL
# ---------------------------------------------------------------

adm_run_hooks pre "$HOOK_PHASE"

verify_reinit
create_structure
validate_permissions
validate_tools
generate_profiles
write_state

adm_run_hooks post "$HOOK_PHASE"
final_summary

exit 0
