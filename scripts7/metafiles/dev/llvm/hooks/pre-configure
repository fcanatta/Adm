#!/usr/bin/env bash
set -euo pipefail
: "${WORKDIR:?WORKDIR não definido}"   # fornecido pelo adm-constructor
: "${CONFIGURE_EXTRAS:=}"
BUILD_DIR="${WORKDIR}/build-llvm"
mkdir -p "$BUILD_DIR"
export ADM_OUT_OF_TREE_BUILD="$BUILD_DIR"

# Configuração mínima do core (sem projects extras)
cat > "${BUILD_DIR}/CMAKE_ARGS.txt" <<'EOF'
-DCMAKE_INSTALL_PREFIX=/usr
-DCMAKE_BUILD_TYPE=Release
-DLLVM_ENABLE_PROJECTS=
-DLLVM_ENABLE_RUNTIMES=
-DLLVM_TARGETS_TO_BUILD=all
-DLLVM_ENABLE_TERMINFO=OFF
-DLLVM_ENABLE_ZLIB=ON
-DLLVM_ENABLE_ZSTD=ON
-DBUILD_SHARED_LIBS=ON
-DCMAKE_SKIP_RPATH=ON
-GNinja
EOF

export CONFIGURE_EXTRAS+=" -S llvm -B ${BUILD_DIR} $(tr '\n' ' ' < ${BUILD_DIR}/CMAKE_ARGS.txt)"
