#!/usr/bin/env bash
set -euo pipefail
: "${WORKDIR:?}"
: "${TARGET:?}"
: "${SYSROOT:?}"
: "${CONFIGURE_EXTRAS:=}"
BUILD_DIR="${WORKDIR}/build-libcxx"
mkdir -p "$BUILD_DIR"
export ADM_OUT_OF_TREE_BUILD="$BUILD_DIR"

cat > "${BUILD_DIR}/CMAKE_ARGS.txt" <<EOF
-DCMAKE_INSTALL_PREFIX=/usr
-DCMAKE_BUILD_TYPE=Release
-DCMAKE_SYSROOT=${SYSROOT}
-DCMAKE_C_COMPILER=clang
-DCMAKE_C_COMPILER_TARGET=${TARGET}
-DCMAKE_CXX_COMPILER=clang++
-DCMAKE_CXX_COMPILER_TARGET=${TARGET}
-DLIBCXX_USE_COMPILER_RT=ON
-DLIBCXX_ENABLE_SHARED=ON
-DLIBCXX_ENABLE_STATIC=ON
-DLIBCXX_ENABLE_EXCEPTIONS=ON
-DLIBCXX_ENABLE_THREADS=ON
-DLIBCXX_CXX_ABI=libcxxabi
-DLIBCXX_CXX_ABI_INCLUDE_PATHS=${SYSROOT}/usr/include/c++/v1
-DCMAKE_SKIP_RPATH=ON
-GNinja
EOF

export CONFIGURE_EXTRAS+=" -S libcxx -B ${BUILD_DIR} $(tr '\n' ' ' < ${BUILD_DIR}/CMAKE_ARGS.txt)"
