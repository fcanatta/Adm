#!/usr/bin/env bash
set -euo pipefail
: "${TARGET:?TARGET não definido}"
: "${MAKE:=make}"
: "${NPROC:=$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)}"

case "${TARGET}" in
  x86_64-*)      export ARCH=x86_64 ;;
  i?86-*)        export ARCH=i386 ;;
  aarch64-*)     export ARCH=arm64 ;;
  arm-*)         export ARCH=arm ;;
  riscv64-*)     export ARCH=riscv ;;
  powerpc64le-*) export ARCH=powerpc ;;
  *) echo "TARGET não mapeado para ARCH: $TARGET" >&2; exit 70 ;;
esac
export CROSS_COMPILE="${TARGET}-"

# preferência de config:
# 1) /usr/src/adm/kconfigs/${ARCH}/kernel-lts.config
# 2) $KCONFIG se definido
# 3) /proc/config.gz → olddefconfig
# 4) defconfig
CFG_DIR="/usr/src/adm/kconfigs/${ARCH}"
if [[ -f "${CFG_DIR}/kernel-lts.config" ]]; then
  cp -f "${CFG_DIR}/kernel-lts.config" .config
elif [[ -n "${KCONFIG:-}" && -f "${KCONFIG}" ]]; then
  cp -f "${KCONFIG}" .config
elif zcat /proc/config.gz >/dev/null 2>&1; then
  zcat /proc/config.gz > .config || true
  $MAKE olddefconfig
else
  $MAKE defconfig
fi
