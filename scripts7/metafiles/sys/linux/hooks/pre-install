#!/usr/bin/env bash
set -euo pipefail
: "${DESTDIR:?DESTDIR n찾o definido}"
: "${MAKE:=make}"

# Descobrir a vers찾o exata (kernelrelease)
KVER="$(make -s kernelrelease)"
: "${KVER:?Falha ao detectar kernelrelease}"

# Instalar m처dulos no DESTDIR
$MAKE modules_install INSTALL_MOD_PATH="${DESTDIR}"

# Copiar imagem do kernel para /boot no DESTDIR
install -d "${DESTDIR}/boot"
# Nome da imagem conforme arch
IMG=""
for cand in arch/${ARCH:-x86}/boot/bzImage arch/${ARCH:-arm64}/boot/Image arch/${ARCH:-arm}/boot/zImage vmlinux; do
  [[ -f "$cand" ]] && IMG="$cand" && break
done
[[ -n "$IMG" ]] || { echo "Imagem do kernel n찾o encontrada"; exit 60; }
install -m 0644 "$IMG" "${DESTDIR}/boot/vmlinuz-${KVER}"

# System.map e config
[[ -f System.map ]] && install -m 0644 System.map "${DESTDIR}/boot/System.map-${KVER}" || true
[[ -f .config    ]] && install -m 0644 .config    "${DESTDIR}/boot/config-${KVER}"     || true

# DTBs (ARM/ARM64)
if [[ -d arch/${ARCH:-}/boot/dts ]]; then
  install -d "${DESTDIR}/boot/dtbs-${KVER}"
  rsync -a --delete "arch/${ARCH}/boot/dts/" "${DESTDIR}/boot/dtbs-${KVER}/" 2>/dev/null || true
fi
