#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_wk(){ date +"%Y-%m-%d %H:%M:%S"; }
  adm_info(){ printf '[%s] [INFO] %s\n' "$(_ts_wk)" "$*" >&2; }
fi

wk_root() {
  [ -n "${ADM_INSTALL_ROOT:-}" ] && printf '%s' "$ADM_INSTALL_ROOT" ||
  [ -n "${DESTDIR:-}" ]          && printf '%s' "$DESTDIR"          ||
  printf '/'
}

wk_cxxflags() {
  local f="-O2 -fPIC"
  [ "${ADM_PROFILE:-normal}" = "aggressive" ] && f="-O3 -fPIC -march=native -mtune=native -flto"
  printf '%s\n' "$f"
}

adm_hook_pre_build() { export ADM_SKIP_DEFAULT_BUILD=1; }

adm_hook_build() {
  rm -rf build
  mkdir -p build
  cd build

  CXXFLAGS="$(wk_cxxflags)" CFLAGS="$(wk_cxxflags)" \
  cmake .. \
      -G Ninja \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DCMAKE_BUILD_TYPE=Release \
      -DENABLE_MINIBROWSER=OFF \
      -DENABLE_WEBDRIVER=OFF \
      -DENABLE_DOCUMENTATION=OFF

  ninja -j"$(nproc)"
}

adm_hook_install() {
  cd build
  DESTDIR="$(wk_root)" ninja install
}

adm_hook_post_install() {
  adm_info "webkitgtk: instalado (tuned, sem minibrowser/docs)."
}
