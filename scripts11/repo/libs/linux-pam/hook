#!/usr/bin/env bash
# Hook avançado para libs/linux-pam
# - Controla configure/make/make install
# - Garante /etc/pam.d com arquivos básicos, sem sobrescrever nada sem backup
# - Não cria entradas específicas de serviços (login, sudo etc.) para não conflitar com outros pacotes

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_pam() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_pam)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_pam)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_pam)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

pam_jobs() { nproc 2>/dev/null || echo 1; }

pam_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

pam_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "libs/linux-pam: instalar diretamente em '/' requer root."
  fi
}

pam_detect_srctree() {
  if [ -n "${ADM_LINUX_PAM_SRCDIR:-}" ] && [ -f "$ADM_LINUX_PAM_SRCDIR/configure" ]; then
    printf '%s\n' "$ADM_LINUX_PAM_SRCDIR"; return 0
  fi
  if [ -f "configure" ] && [ -d "modules" ]; then
    printf '%s\n' "$PWD"; return 0
  fi
  local d
  for d in "$PWD"/Linux-PAM-* "$PWD"/*; do
    [ -d "$d" ] || continue
    if [ -f "$d/configure" ] && [ -d "$d/modules" ]; then
      printf '%s\n' "$d"; return 0
    fi
  done
  adm_die "libs/linux-pam: não foi possível detectar diretório de fonte."
}

pam_backup_if_exists() {
  local path="$1"
  if [ -f "$path" ]; then
    local backup="${path}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "libs/linux-pam: '$path' já existe; backup em '$backup'."
    cp -f "$path" "$backup"
  fi
}

pam_init_configs() {
  local root="$1"
  local etc="$root/etc"
  local pamd="$etc/pam.d"

  mkdir -p "$pamd"

  # Cria somente arquivos "genéricos" que outros serviços podem usar
  local system_auth="$pamd/system-auth"
  local system_account="$pamd/system-account"
  local system_password="$pamd/system-password"
  local system_session="$pamd/system-session"

  if [ ! -f "$system_auth" ]; then
    adm_info "libs/linux-pam: criando '$system_auth'."
    cat >"$system_auth" <<'EOF'
auth      required   pam_env.so
auth      required   pam_unix.so try_first_pass nullok
EOF
  else
    pam_backup_if_exists "$system_auth"
  fi

  if [ ! -f "$system_account" ]; then
    adm_info "libs/linux-pam: criando '$system_account'."
    cat >"$system_account" <<'EOF'
account   required   pam_unix.so
EOF
  else
    pam_backup_if_exists "$system_account"
  fi

  if [ ! -f "$system_password" ]; then
    adm_info "libs/linux-pam: criando '$system_password'."
    cat >"$system_password" <<'EOF'
password  required   pam_unix.so sha512 shadow try_first_pass use_authtok
EOF
  else
    pam_backup_if_exists "$system_password"
  fi

  if [ ! -f "$system_session" ]; then
    adm_info "libs/linux-pam: criando '$system_session'."
    cat >"$system_session" <<'EOF'
session   required   pam_limits.so
session   required   pam_unix.so
EOF
  else
    pam_backup_if_exists "$system_session"
  fi
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "libs/linux-pam: build padrão desativado; usando hook."
}

adm_hook_build() {
  local src jobs
  src="$(pam_detect_srctree)"
  jobs="$(pam_jobs)"

  adm_info "libs/linux-pam: src=$src jobs=$jobs"

  (
    cd "$src"
    ./configure \
      --prefix=/usr \
      --sysconfdir=/etc \
      --libdir=/usr/lib \
      --sbindir=/usr/sbin \
      --enable-securedir=/lib/security
    make -j"$jobs"
  )
}

adm_hook_install() {
  local src root
  src="$(pam_detect_srctree)"
  root="$(pam_install_root)"

  pam_require_root_if_needed "$root"

  adm_info "libs/linux-pam: instalando em '$root'..."
  (
    cd "$src"
    make install DESTDIR="$root"
  )

  pam_init_configs "$root"

  adm_info "libs/linux-pam: instalação concluída."
}

adm_hook_post_install() {
  adm_info "libs/linux-pam: post-install – revise /etc/pam.d/system-* antes de colocar em produção."
}
