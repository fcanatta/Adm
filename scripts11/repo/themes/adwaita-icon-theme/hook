#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_ait(){ date +"%Y-%m-%d %H:%M:%S"; }
  adm_info(){ printf '[%s] [INFO] %s\n' "$(_ts_ait)" "$*" >&2; }
  adm_warn(){ printf '[%s] [WARN] %s\n' "$(_ts_ait)" "$*" >&2; }
fi

ait_root() {
  [ -n "${ADM_INSTALL_ROOT:-}" ] && printf '%s\n' "$ADM_INSTALL_ROOT" ||
  [ -n "${DESTDIR:-}" ]          && printf '%s\n' "$DESTDIR"          ||
  printf '/\n'
}

ait_update_cache() {
  local root="$1" dir="$2"
  local bin="$root/usr/bin/gtk-update-icon-cache"

  [ -d "$root$dir" ] || return 0

  if [ -x "$bin" ]; then
    adm_info "adwaita-icon-theme: atualizando cache em '$dir' (chroot)."
    chroot "$root" gtk-update-icon-cache -f -q "$dir" 2>/dev/null || true
  else
    adm_warn "adwaita-icon-theme: gtk-update-icon-cache não encontrado em '$bin'; pulando."
  fi
}

adm_hook_pre_build() { adm_info "adwaita-icon-theme: build padrão do ADM é suficiente."; }
adm_hook_build() { :; }

adm_hook_install() {
  : # install padrão do ADM já copia os ícones
}

adm_hook_post_install() {
  local root; root="$(ait_root)"
  # Atualiza cache para o tema Adwaita (ícones principais)
  ait_update_cache "$root" "/usr/share/icons/Adwaita"
}
