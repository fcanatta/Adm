#!/usr/bin/env bash
# Hook avançado para apps/firefox (build real a partir do código-fonte)
#
# Responsabilidades:
# - Desativar o build padrão do ADM e usar ./mach build
# - Instalar o Firefox em <root>/<ADM_FIREFOX_INSTALL_DIR> (default: /opt/firefox)
# - Criar symlink /usr/bin/firefox -> /opt/firefox/firefox
# - Criar arquivo .desktop em /usr/share/applications/firefox.desktop
# - Copiar ícone para /usr/share/pixmaps/firefox.png (se possível)
# - Gerar perfil padrão em /etc/skel/.mozilla/firefox/default/user.js
#
# Variáveis importantes:
#   ADM_FIREFOX_SRCDIR           -> diretório do source (opcional)
#   ADM_FIREFOX_BUILD_PROFILE    -> release|debug (default: release)
#   ADM_FIREFOX_JOBS             -> número de jobs (default: nproc)
#   ADM_FIREFOX_INSTALL_DIR      -> onde instalar dentro do root (default: /opt/firefox)
#
# Requisitos:
#   - ./mach presente no diretório de fonte
#   - toolchain e deps já satisfeitos pelo metafile

set -euo pipefail
IFS=$'\n\t'

# ----------------------------------------------------------------------------
# Logging mínimo, caso 01-log-ui.sh ainda não tenha sido carregado
# ----------------------------------------------------------------------------
if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_ff() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_ff)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_ff)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_ff)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

# ----------------------------------------------------------------------------
# Helpers de ambiente / paths
# ----------------------------------------------------------------------------
ff_jobs() {
  if [ -n "${ADM_FIREFOX_JOBS:-}" ]; then
    printf '%s\n' "$ADM_FIREFOX_JOBS"
  else
    nproc 2>/dev/null || echo 1
  fi
}

ff_build_profile() {
  case "${ADM_FIREFOX_BUILD_PROFILE:-release}" in
    release|debug)
      printf '%s\n' "$ADM_FIREFOX_BUILD_PROFILE"
      ;;
    *)
      adm_warn "apps/firefox: ADM_FIREFOX_BUILD_PROFILE inválido, usando 'release'."
      printf 'release\n'
      ;;
  esac
}

ff_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

ff_install_dir() {
  # Diretório absoluto dentro do root
  local root="$1"
  local rel="${ADM_FIREFOX_INSTALL_DIR:-/opt/firefox}"
  case "$rel" in
    /*)  printf '%s%s\n' "$root" "$rel" ;;
    *)   printf '%s/%s\n' "$root" "$rel" ;;
  esac
}

ff_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "apps/firefox: instalar diretamente em '/' requer root."
  fi
}

ff_backup_if_exists() {
  local path="$1"
  if [ -e "$path" ]; then
    local backup="${path}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "apps/firefox: '$path' já existe; backup em '$backup'."
    cp -a "$path" "$backup"
  fi
}

# ----------------------------------------------------------------------------
# Descoberta do diretório de fonte e do objdir
# ----------------------------------------------------------------------------
ff_detect_srctree() {
  if [ -n "${ADM_FIREFOX_SRCDIR:-}" ] && [ -f "$ADM_FIREFOX_SRCDIR/mach" ]; then
    printf '%s\n' "$ADM_FIREFOX_SRCDIR"
    return 0
  fi
  if [ -f "mach" ]; then
    printf '%s\n' "$PWD"
    return 0
  fi
  local d
  for d in "$PWD"/firefox-* "$PWD"/*; do
    [ -d "$d" ] || continue
    if [ -f "$d/mach" ]; then
      printf '%s\n' "$d"
      return 0
    fi
  done
  adm_die "apps/firefox: não foi possível detectar diretório de fonte (mach não encontrado)."
}

ff_detect_objdir() {
  # Heurística: procurar obj-*/dist ou obj-*/dist/firefox
  local src="$1"
  local d
  for d in "$src"/obj-*; do
    [ -d "$d" ] || continue
    if [ -d "$d/dist" ]; then
      printf '%s\n' "$d"
      return 0
    fi
  done

  # Caso não exista ainda, vamos confiar que ./mach build criará um objdir padrão
  # e tentar localizar depois de build.
  return 1
}

ff_find_installdir_in_obj() {
  # Tenta encontrar diretório com binário firefox dentro do objdir
  local obj="$1"

  # Primeiro: formato dist/firefox (tarball oficial unpack)
  if [ -x "$obj/dist/firefox/firefox" ]; then
    printf '%s\n' "$obj/dist/firefox"
    return 0
  fi

  # Alternativa: dist/bin
  if [ -x "$obj/dist/bin/firefox" ]; then
    printf '%s\n' "$obj/dist/bin"
    return 0
  fi

  adm_die "apps/firefox: não foi possível localizar diretório com binário 'firefox' dentro de '$obj'."
}

# ----------------------------------------------------------------------------
# Integração: .desktop, symlink, ícone, user.js
# ----------------------------------------------------------------------------
ff_create_symlink_bin() {
  local root="$1"
  local install_dir="$2"

  local bindir="$root/usr/bin"
  local target="$bindir/firefox"
  mkdir -p "$bindir"

  ff_backup_if_exists "$target"

  local reltarget
  # usar caminho absoluto dentro do root
  reltarget="$install_dir/firefox"

  adm_info "apps/firefox: criando symlink '$target' -> '$reltarget'."
  ln -sf "$reltarget" "$target"
}

ff_install_icon() {
  local root="$1"
  local install_dir="$2"

  local pix="$root/usr/share/pixmaps"
  mkdir -p "$pix"

  local icon_src=""
  if [ -f "$install_dir/browser/chrome/icons/default/default128.png" ]; then
    icon_src="$install_dir/browser/chrome/icons/default/default128.png"
  elif [ -f "$install_dir/browser/chrome/icons/default/default48.png" ]; then
    icon_src="$install_dir/browser/chrome/icons/default/default48.png"
  elif [ -f "$install_dir/browser/icons/mozicon128.png" ]; then
    icon_src="$install_dir/browser/icons/mozicon128.png"
  fi

  if [ -n "$icon_src" ]; then
    ff_backup_if_exists "$pix/firefox.png"
    adm_info "apps/firefox: copiando ícone '$icon_src' para '$pix/firefox.png'."
    cp "$icon_src" "$pix/firefox.png"
  else
    adm_warn "apps/firefox: não foi possível localizar ícone para copiar em $install_dir."
  fi
}

ff_install_desktop_file() {
  local root="$1"
  local appdir="$root/usr/share/applications"
  local desktop="$appdir/firefox.desktop"

  mkdir -p "$appdir"
  ff_backup_if_exists "$desktop"

  adm_info "apps/firefox: criando arquivo .desktop em '$desktop'."

  cat >"$desktop" <<'EOF'
[Desktop Entry]
Name=Firefox Web Browser
GenericName=Web Browser
Comment=Browse the Web
Exec=firefox %u
Terminal=false
Type=Application
Icon=firefox
Categories=Network;WebBrowser;
MimeType=text/html;text/xml;application/xhtml+xml;x-scheme-handler/http;x-scheme-handler/https;
StartupNotify=true
EOF
}

ff_install_default_profile() {
  local root="$1"
  local skel="$root/etc/skel"
  local profdir="$skel/.mozilla/firefox/default"
  local userjs="$profdir/user.js"

  mkdir -p "$profdir"

  ff_backup_if_exists "$userjs"

  adm_info "apps/firefox: criando user.js padrão em '$userjs'."

  cat >"$userjs" <<'EOF'
// user.js gerado pelo ADM para Firefox
// Foco em privacidade básica e evitar que o Firefox gerencie atualizações
user_pref("app.update.enabled", false);
user_pref("app.update.auto", false);
user_pref("app.update.service.enabled", false);

// Telemetria / estudos / report
user_pref("datareporting.healthreport.uploadEnabled", false);
user_pref("datareporting.policy.dataSubmissionEnabled", false);
user_pref("toolkit.telemetry.enabled", false);
user_pref("toolkit.telemetry.unified", false);
user_pref("toolkit.telemetry.archive.enabled", false);
user_pref("toolkit.telemetry.updatePing.enabled", false);
user_pref("toolkit.telemetry.bhrPing.enabled", false);
user_pref("toolkit.telemetry.firstShutdownPing.enabled", false);
user_pref("toolkit.telemetry.newProfilePing.enabled", false);
user_pref("toolkit.telemetry.shutdownPingSender.enabled", false);
user_pref("toolkit.telemetry.reportingpolicy.firstRun", false);

user_pref("experiments.enabled", false);
user_pref("experiments.supported", false);
user_pref("experiments.manifest.uri", "");

// Crash reporter
user_pref("breakpad.reportURL", "");
user_pref("browser.tabs.crashReporting.sendReport", false);
user_pref("browser.crashReports.unsubmittedCheck.enabled", false);

// Estudos / recomendações
user_pref("browser.discovery.enabled", false);
user_pref("browser.newtabpage.activity-stream.feeds.telemetry", false);
user_pref("browser.newtabpage.activity-stream.telemetry", false);
user_pref("browser.ping-centre.telemetry", false);
user_pref("browser.urlbar.quicksuggest.enabled", false);
user_pref("browser.urlbar.suggest.quicksuggest.nonsponsored", false);
user_pref("browser.urlbar.suggest.quicksuggest.sponsored", false);

// Outras coisinhas "chatas"
user_pref("extensions.pocket.enabled", false);
user_pref("signon.rememberSignons", false);

// ADM: indicativo de que este perfil foi criado automaticamente
user_pref("adm.profile.generated", true);
EOF
}

# ----------------------------------------------------------------------------
# Hooks do ADM
# ----------------------------------------------------------------------------
adm_hook_pre_build() {
  # vamos controlar o build
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "apps/firefox: build padrão desativado; usando hook customizado (./mach build)."
}

adm_hook_build() {
  local src jobs profile
  src="$(ff_detect_srctree)"
  jobs="$(ff_jobs)"
  profile="$(ff_build_profile)"

  adm_info "apps/firefox: src=$src jobs=$jobs profile=$profile"

  if ! command -v python3 >/dev/null 2>&1; then
    adm_die "apps/firefox: python3 não encontrado; verifique dev/python3."
  fi

  if [ ! -x "$src/mach" ]; then
    adm_die "apps/firefox: script 'mach' não é executável em '$src/mach'."
  fi

  (
    cd "$src"
    # Profile de build – simplificado: usamos ENV FLAG, o sistema de build do Firefox
    # decidirá detalhes de otimização (mozconfig etc.).
    export MOZCONFIG="${MOZCONFIG:-}"

    case "$profile" in
      release)
        adm_info "apps/firefox: build de release (otimizado)."
        ;;
      debug)
        adm_info "apps/firefox: build de debug."
        ;;
    esac

    # Build principal
    ./mach build -j"$jobs"
  )
}

adm_hook_install() {
  local src root obj install_dir objdir_install
  src="$(ff_detect_srctree)"
  root="$(ff_install_root)"

  ff_require_root_if_needed "$root"

  # Tentar detectar objdir (se não conseguir antes, tenta depois do build)
  if obj="$(ff_detect_objdir "$src")"; then
    adm_info "apps/firefox: objdir detectado em '$obj'."
  else
    adm_warn "apps/firefox: objdir não detectado antes; tentando localizar após build."
    obj="$(ff_detect_objdir "$src")" || adm_die "apps/firefox: objdir ainda não encontrado após build."
  fi

  objdir_install="$(ff_find_installdir_in_obj "$obj")"
  install_dir="$(ff_install_dir "$root")"

  adm_info "apps/firefox: copiando do objdir '$objdir_install' para '$install_dir'."

  # Limpar destino anterior com backup
  if [ -d "$install_dir" ]; then
    ff_backup_if_exists "$install_dir"
    rm -rf "$install_dir"
  fi

  mkdir -p "$(dirname "$install_dir")"
  cp -a "$objdir_install" "$install_dir"

  ff_create_symlink_bin "$root" "$install_dir"
  ff_install_icon "$root" "$install_dir"
  ff_install_desktop_file("$root") 2>/dev/null || ff_install_desktop_file "$root"
  ff_install_default_profile "$root"

  adm_info "apps/firefox: instalação concluída em '$install_dir'."
}

adm_hook_post_install() {
  adm_info "apps/firefox: post-install – verifique /usr/bin/firefox, .desktop e perfil default em /etc/skel."
}
