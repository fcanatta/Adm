#!/usr/bin/env bash
# Hook inteligente para sys/linux-firmware
# - Desativa build padrão
# - Detecta diretório de fonte do firmware
# - Copia tudo para $ROOT/lib/firmware (ou ADM_FIRMWARE_DIR)
# - Faz backup do firmware antigo se existir

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_fw() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_fw)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_fw)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_fw)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

fw_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

fw_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/linux-firmware: instalar diretamente em '/' requer root."
  fi
}

fw_target_dir() {
  local root="$1"
  if [ -n "${ADM_FIRMWARE_DIR:-}" ]; then
    printf '%s\n' "$root${ADM_FIRMWARE_DIR}"
  else
    # default: /lib/firmware dentro do root
    printf '%s\n' "$root/lib/firmware"
  fi
}

fw_detect_srctree() {
  # 1) explícito
  if [ -n "${ADM_LINUX_FIRMWARE_SRCDIR:-}" ] && [ -f "$ADM_LINUX_FIRMWARE_SRCDIR/WHENCE" ]; then
    printf '%s\n' "$ADM_LINUX_FIRMWARE_SRCDIR"; return 0
  fi
  # 2) diretório atual tem WHENCE + vários firmwares
  if [ -f "WHENCE" ] && [ -d "intel-ucode" -o -d "amd-ucode" -o -d "rtl_nic" ]; then
    printf '%s\n' "$PWD"; return 0
  fi
  # 3) procurar linux-firmware-* no diretório atual
  local d
  for d in "$PWD"/linux-firmware-* "$PWD"/*; do
    [ -d "$d" ] || continue
    if [ -f "$d/WHENCE" ]; then
      printf '%s\n' "$d"; return 0
    fi
  done
  adm_die "sys/linux-firmware: não foi possível detectar diretório de fonte (WHENCE não encontrado)."
}

fw_backup_if_exists() {
  local dir="$1"
  if [ -d "$dir" ] && [ "$(ls -A "$dir" 2>/dev/null | wc -l)" -gt 0 ]; then
    local backup="${dir}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "sys/linux-firmware: '$dir' já existe e não está vazio; criando backup em '$backup'."
    mv "$dir" "$backup"
  fi
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/linux-firmware: build padrão desativado (não há compilação, apenas instalação de arquivos)."
}

adm_hook_build() {
  adm_info "sys/linux-firmware: nenhum build necessário (apenas cópia de firmware)."
}

adm_hook_install() {
  local src root target
  src="$(fw_detect_srctree)"
  root="$(fw_install_root)"
  fw_require_root_if_needed "$root"

  target="$(fw_target_dir "$root")"

  adm_info "sys/linux-firmware: src='$src' -> target='$target'"

  fw_backup_if_exists "$target"
  mkdir -p "$target"

  adm_info "sys/linux-firmware: copiando firmware (pode demorar, é bastante coisa)..."
  # cp -a preserva permissões, timestamps, symlinks
  cp -a "$src"/. "$target/"

  adm_info "sys/linux-firmware: instalação concluída."
}

adm_hook_post_install() {
  adm_info "sys/linux-firmware: post-install – certifique-se que o kernel está apontando para $ADM_FIRMWARE_DIR (ou /lib/firmware)."
}
