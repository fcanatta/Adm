#!/usr/bin/env bash
# Hook avançado para sys/elogind
# - Controla configure/make/make install
# - Garante /etc/elogind/logind.conf se não existir
# - Cria diretórios de runtime em /run /var específicos do elogind

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_el() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_el)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_el)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_el)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

el_jobs() { nproc 2>/dev/null || echo 1; }

el_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

el_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/elogind: instalar diretamente em '/' requer root."
  fi
}

el_detect_srctree() {
  if [ -n "${ADM_ELOGIND_SRCDIR:-}" ] && [ -f "$ADM_ELOGIND_SRCDIR/configure" -o -f "$ADM_ELOGIND_SRCDIR/meson.build" ]; then
    printf '%s\n' "$ADM_ELOGIND_SRCDIR"; return 0
  fi
  if [ -f "configure" -o -f "meson.build" ]; then
    printf '%s\n' "$PWD"; return 0
  fi
  local d
  for d in "$PWD"/elogind-* "$PWD"/*; do
    [ -d "$d" ] || continue
    if [ -f "$d/configure" -o -f "$d/meson.build" ]; then
      printf '%s\n' "$d"; return 0
    fi
  done
  adm_die "sys/elogind: não foi possível detectar diretório de fonte."
}

el_init_config() {
  local root="$1"
  local etc="$root/etc"
  local confdir="$etc/elogind"
  local conf="$confdir/logind.conf"

  mkdir -p "$confdir"

  if [ -f "$conf" ]; then
    local backup="${conf}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "sys/elogind: '$conf' já existe; backup em '$backup'."
    cp -f "$conf" "$backup"
    return 0
  fi

  adm_info "sys/elogind: criando logind.conf padrão."
  cat >"$conf" <<'EOF'
[Login]
HandlePowerKey=poweroff
HandleSuspendKey=suspend
HandleHibernateKey=hibernate
HandleLidSwitch=suspend
IdleAction=ignore
EOF
}

el_init_dirs_runtime() {
  local root="$1"
  mkdir -p "$root/run" "$root/var/lib/elogind" "$root/var/log/elogind"
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/elogind: build padrão desativado; usando hook."
}

adm_hook_build() {
  local src jobs
  src="$(el_detect_srctree)"
  jobs="$(el_jobs)"

  adm_info "sys/elogind: src=$src jobs=$jobs"

  if [ -f "$src/meson.build" ]; then
    # Caminho moderno via meson
    (
      cd "$src"
      meson setup build \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        -Ddefault-hierarchy=hybrid
      ninja -C build -j"$jobs"
    )
  else
    # Caminho autotools
    (
      cd "$src"
      ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var
      make -j"$jobs"
    )
  fi
}

adm_hook_install() {
  local src root
  src="$(el_detect_srctree)"
  root="$(el_install_root)"

  el_require_root_if_needed "$root"

  adm_info "sys/elogind: instalando em '$root'..."

  if [ -f "$src/meson.build" ]; then
    (
      cd "$src/build"
      DESTDIR="$root" ninja install
    )
  else
    (
      cd "$src"
      make install DESTDIR="$root"
    )
  fi

  el_init_config "$root"
  el_init_dirs_runtime "$root"

  adm_info "sys/elogind: instalação concluída."
}

adm_hook_post_install() {
  adm_info "sys/elogind: post-install – integre com PAM (system-auth) e dbus se for usar como logind principal."
}
