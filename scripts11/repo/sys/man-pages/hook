#!/usr/bin/env bash
# Hook inteligente para sys/man-pages
# Pacote só de documentação (man), basicamente "make prefix=/usr install".
# Este hook:
#   - evita build padrão
#   - instala em root custom (DESTDIR / ADM_INSTALL_ROOT)
#   - evita sobrescrever silenciosamente (usa install via make)

set -euo pipefail
IFS=$'\n\t'

ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"

if ! declare -F adm_info >/dev/null 2>&1; then
    _ts_m() { date +"%Y-%m-%d %H:%M:%S"; }
    adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_m)" "$*" >&2; }
    adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_m)" "$*" >&2; }
    adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_m)" "$*" >&2; }
    adm_die()   { adm_error "$*"; exit 1; }
fi

mp_install_root() {
    if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
        printf '%s\n' "$ADM_INSTALL_ROOT"
    elif [ -n "${DESTDIR:-}" ]; then
        printf '%s\n' "$DESTDIR"
    else
        printf '/\n'
    fi
}

mp_require_root_if_needed() {
    local root="$1"
    if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
        adm_die "sys/man-pages: instalar diretamente em '/' requer root."
    fi
}

mp_detect_srctree() {
    # man-pages costuma ter Makefile no topo e diretórios man1, man2...
    if [ -f "Makefile" ] && [ -d "man1" ]; then
        printf '%s\n' "$PWD"; return 0
    fi
    local d
    for d in "$PWD"/man-pages-* "$PWD"/*; do
        [ -d "$d" ] || continue
        if [ -f "$d/Makefile" ] && [ -d "$d/man1" ]; then
            printf '%s\n' "$d"; return 0
        fi
    done
    adm_die "sys/man-pages: não foi possível detectar diretório de fonte."
}

adm_hook_pre_build() {
    export ADM_SKIP_DEFAULT_BUILD=1
    adm_info "sys/man-pages: build padrão desativado; apenas instalação será feita."
}

adm_hook_build() {
    # nada para compilar, apenas logs
    adm_info "sys/man-pages: nenhum build necessário (somente instalação)."
}

adm_hook_install() {
    local src root
    src="$(mp_detect_srctree)"
    root="$(mp_install_root)"

    mp_require_root_if_needed "$root"

    adm_info "sys/man-pages: instalando em root='$root' (prefix=/usr)..."
    (
        cd "$src"
        # man-pages suporta DESTDIR, se não suportar seu build-engine pode ajustar.
        make prefix=/usr DESTDIR="$root" install
    )

    adm_info "sys/man-pages: instalação concluída em '$root/usr/share/man'."
}

adm_hook_post_install() {
    adm_info "sys/man-pages: post-install – atualize MANPATH se necessário."
}
