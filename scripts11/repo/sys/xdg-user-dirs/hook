#!/usr/bin/env bash
# Hook para sys/xdg-user-dirs
# - Cria /etc/xdg/user-dirs.defaults se não existir
# - Cria diretórios padrão em /etc/skel (Desktop, Downloads, Documents etc.)

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_xdg() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_xdg)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_xdg)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_xdg)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

xdg_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

xdg_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/xdg-user-dirs: instalar diretamente em '/' requer root."
  fi
}

xdg_backup_if_exists() {
  local path="$1"
  if [ -e "$path" ]; then
    local backup="${path}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "sys/xdg-user-dirs: '$path' já existe; backup em '$backup'."
    cp -a "$path" "$backup"
  fi
}

adm_hook_pre_build() { adm_info "sys/xdg-user-dirs: build padrão."; }
adm_hook_build() { :; }

adm_hook_install() {
  local root xdgdir cfg skel
  root="$(xdg_root)"
  xdg_require_root_if_needed "$root"

  xdgdir="$root/etc/xdg"
  cfg="$xdgdir/user-dirs.defaults"
  skel="$root/etc/skel"

  mkdir -p "$xdgdir" "$skel"

  if [ ! -f "$cfg" ]; then
    adm_info "sys/xdg-user-dirs: criando '$cfg'."
    cat >"$cfg" <<'EOF'
DESKTOP=Desktop
DOWNLOAD=Downloads
TEMPLATES=Templates
PUBLICSHARE=Public
DOCUMENTS=Documents
MUSIC=Music
PICTURES=Pictures
VIDEOS=Videos
EOF
  fi

  adm_info "sys/xdg-user-dirs: criando diretórios padrão em /etc/skel."
  mkdir -p "$skel"/Desktop "$skel"/Downloads "$skel"/Documents \
           "$skel"/Music "$skel"/Pictures "$skel"/Videos \
           "$skel"/Templates "$skel"/Public
}

adm_hook_post_install() {
  adm_info "sys/xdg-user-dirs: diretórios padrão configurados em /etc/xdg e /etc/skel."
}
