#!/usr/bin/env bash
# Hook inteligente para o pacote sys/linux-xanmod
# Responsável por:
#   - compilar o kernel com patches XanMod
#   - escolher config específico para XanMod
#   - instalar com nome vmlinuz-xanmod-<release>

set -euo pipefail
IFS=$'\n\t'

ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"
ADM_KERNEL_CONFIG_DIR="${ADM_KERNEL_CONFIG_DIR:-$ADM_ROOT/kconfig}"

if ! declare -F adm_info >/dev/null 2>&1; then
    _k_ts() { date +"%Y-%m-%d %H:%M:%S"; }
    adm_info()  { printf '[%s] [INFO] %s\n'  "$(_k_ts)" "$*" >&2; }
    adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_k_ts)" "$*" >&2; }
    adm_error() { printf '[%s] [ERRO] %s\n'  "$(_k_ts)" "$*" >&2; }
    adm_die()   { adm_error "$*"; exit 1; }
fi

xan_jobs() { nproc 2>/dev/null || echo 1; }

xan_detect_srctree() {
    if [ -n "${ADM_KERNEL_SRCDIR:-}" ] && [ -f "$ADM_KERNEL_SRCDIR/Makefile" ]; then
        printf '%s\n' "$ADM_KERNEL_SRCDIR"; return 0
    fi
    if [ -f "Makefile" ] && grep -q "^VERSION =" Makefile 2>/dev/null; then
        printf '%s\n' "$PWD"; return 0
    fi
    local d
    for d in "$PWD"/linux-* "$PWD"/*; do
        [ -d "$d" ] || continue
        if [ -f "$d/Makefile" ] && grep -q "^VERSION =" "$d/Makefile" 2>/dev/null; then
            printf '%s\n' "$d"; return 0
        fi
    done
    adm_die "sys/linux-xanmod: não encontrei árvore de fonte do kernel."
}

xan_detect_arch() {
    if [ -n "${ADM_KERNEL_ARCH:-}" ]; then
        printf '%s\n' "$ADM_KERNEL_ARCH"; return 0
    fi
    local u; u="$(uname -m)"
    case "$u" in
        x86_64) printf 'x86_64\n' ;;
        i?86)   printf 'i386\n' ;;
        aarch64)printf 'arm64\n' ;;
        arm*)   printf 'arm\n' ;;
        *)      printf '%s\n' "$u" ;;
    esac
}

xan_install_root() {
    if [ -n "${ADM_KERNEL_INSTALL_ROOT:-}" ]; then
        printf '%s\n' "$ADM_KERNEL_INSTALL_ROOT"
    elif [ -n "${ADM_INSTALL_ROOT:-}" ]; then
        printf '%s\n' "$ADM_INSTALL_ROOT"
    elif [ -n "${DESTDIR:-}" ]; then
        printf '%s\n' "$DESTDIR"
    else
        printf '/\n'
    fi
}

xan_require_root_if_needed() {
    local root="$1"
    if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
        adm_die "sys/linux-xanmod: instalar em '/' requer root."
    fi
}

xan_choose_config() {
    local prof="${ADM_PROFILE:-normal-system}"
    local src="$1"
    local cfg=""

    # prioridade para configs específicos do xanmod
    if [ -n "${ADM_KERNEL_CONFIG:-}" ] && [ -f "$ADM_KERNEL_CONFIG" ]; then
        cfg="$ADM_KERNEL_CONFIG"
    elif [ -f "$ADM_KERNEL_CONFIG_DIR/linux-xanmod-${prof}.config" ]; then
        cfg="$ADM_KERNEL_CONFIG_DIR/linux-xanmod-${prof}.config"
    elif [ -f "$ADM_KERNEL_CONFIG_DIR/linux-xanmod-default.config" ]; then
        cfg="$ADM_KERNEL_CONFIG_DIR/linux-xanmod-default.config"
    elif [ -f "$ADM_KERNEL_CONFIG_DIR/linux-${prof}.config" ]; then
        cfg="$ADM_KERNEL_CONFIG_DIR/linux-${prof}.config"
    elif [ -f "$ADM_KERNEL_CONFIG_DIR/linux-default.config" ]; then
        cfg="$ADM_KERNEL_CONFIG_DIR/linux-default.config"
    fi

    if [ -n "$cfg" ]; then
        adm_info "sys/linux-xanmod: usando config '$cfg'"
        cp -f "$cfg" "$src/.config"
        ( cd "$src" && make olddefconfig )
    else
        adm_warn "sys/linux-xanmod: nenhum config específico; usando 'make defconfig'."
        ( cd "$src" && make defconfig )
    fi
}

xan_kernelrelease() {
    ( cd "$1" && make -s kernelrelease )
}

adm_hook_pre_build() {
    export ADM_SKIP_DEFAULT_BUILD=1
    adm_info "sys/linux-xanmod: build padrão desativado; usando fluxo XanMod."
}

adm_hook_build() {
    local src arch jobs
    src="$(xan_detect_srctree)"
    arch="$(xan_detect_arch)"
    jobs="$(xan_jobs)"

    adm_info "sys/linux-xanmod: src=$src arch=$arch jobs=$jobs"

    xan_choose_config "$src"

    adm_info "sys/linux-xanmod: compilando kernel + módulos..."
    ( cd "$src" && make -j"$jobs" all )
}

adm_hook_install() {
    local src arch root krel bootdir img name
    src="$(xan_detect_srctree)"
    arch="$(xan_detect_arch)"
    root="$(xan_install_root)"
    xan_require_root_if_needed "$root"

    krel="$(xan_kernelrelease "$src")" || krel="xanmod-unknown"
    bootdir="$root/boot"

    adm_info "sys/linux-xanmod: instalando em '$root' (release=$krel)"

    mkdir -p "$bootdir"

    if [ -f "$src/arch/$arch/boot/bzImage" ]; then
        img="$src/arch/$arch/boot/bzImage"
    elif [ -f "$src/arch/x86/boot/bzImage" ]; then
        img="$src/arch/x86/boot/bzImage"
    else
        adm_die "sys/linux-xanmod: não encontrei bzImage."
    fi

    name="vmlinuz-xanmod-$krel"
    cp -f "$img" "$bootdir/$name"
    [ -f "$src/System.map" ] && cp -f "$src/System.map" "$bootdir/System.map-xanmod-$krel"
    [ -f "$src/.config" ]    && cp -f "$src/.config"    "$bootdir/config-xanmod-$krel"

    adm_info "sys/linux-xanmod: instalando módulos..."
    ( cd "$src" && make modules_install INSTALL_MOD_PATH="$root" )

    adm_info "sys/linux-xanmod: instalado como $bootdir/$name"
}

adm_hook_post_install() {
    adm_info "sys/linux-xanmod: post-install; configure o bootloader para vmlinuz-xanmod-* se desejar."
}
