#!/usr/bin/env bash
# Hook inteligente para sys/intel-microcode
# - Não compila nada, só organiza microcode Intel
# - Depende de sys/linux-firmware já instalado
# - Opcionalmente gera /boot/intel-ucode.img (cpio+compressão) se configurado

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_imc() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_imc)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_imc)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_imc)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

imc_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

imc_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/intel-microcode: instalar diretamente em '/' (gerar /boot/intel-ucode.img) requer root."
  fi
}

imc_firmware_dir() {
  local root="$1"
  if [ -n "${ADM_FIRMWARE_DIR:-}" ]; then
    printf '%s\n' "$root${ADM_FIRMWARE_DIR}"
  else
    printf '%s\n' "$root/lib/firmware"
  fi
}

imc_boot_dir() {
  local root="$1"
  if [ -n "${ADM_BOOT_DIR:-}" ]; then
    printf '%s\n' "$root${ADM_BOOT_DIR}"
  else
    printf '%s\n' "$root/boot"
  fi
}

imc_check_intel_ucode() {
  local fwdir="$1"
  if [ ! -d "$fwdir/intel-ucode" ]; then
    adm_warn "sys/intel-microcode: diretório '$fwdir/intel-ucode' não encontrado. linux-firmware está instalado corretamente?"
    return 1
  fi
  return 0
}

imc_create_ucode_image() {
  local root="$1"
  local fwdir="$2"
  local bootdir
  bootdir="$(imc_boot_dir "$root")"

  mkdir -p "$bootdir"

  local out="$bootdir/intel-ucode.img"
  adm_info "sys/intel-microcode: gerando imagem de microcode em '$out'."

  if ! command -v cpio >/dev/null 2>&1; then
    adm_warn "sys/intel-microcode: 'cpio' não encontrado, não será possível gerar a imagem."
    return 1
  fi

  # compressão opcional: se xz existir, comprime; senão deixa raw
  if command -v xz >/dev/null 2>&1; then
    ( cd "$fwdir" && find intel-ucode -type f | sort | cpio -o -H newc ) | xz -c >"$out"
  else
    ( cd "$fwdir" && find intel-ucode -type f | sort | cpio -o -H newc ) >"$out"
  fi

  adm_info "sys/intel-microcode: imagem gerada. Ajuste seu bootloader para carregar '$out' como microcode early."
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/intel-microcode: build padrão desativado (meta-pacote, sem sources próprios)."
}

adm_hook_build() {
  adm_info "sys/intel-microcode: nenhum build necessário (somente organização de microcode)."
}

adm_hook_install() {
  local root fwdir
  root="$(imc_install_root)"
  fwdir="$(imc_firmware_dir "$root")"

  imc_require_root_if_needed "$root"

  adm_info "sys/intel-microcode: root='$root' firmware_dir='$fwdir'"

  if ! imc_check_intel_ucode "$fwdir"; then
    adm_warn "sys/intel-microcode: prosseguindo sem gerar imagem (firmware Intel não encontrado)."
    return 0
  fi

  # se só quiser garantir presença de intel-ucode, isso já basta
  adm_info "sys/intel-microcode: microcode Intel disponível em '$fwdir/intel-ucode'."

  # geração opcional de imagem
  if [ "${ADM_INTEL_UCODE_CREATE_IMAGE:-0}" = "1" ]; then
    imc_create_ucode_image "$root" "$fwdir" || adm_warn "sys/intel-microcode: falha ao gerar imagem (ignorado)."
  else
    adm_info "sys/intel-microcode: ADM_INTEL_UCODE_CREATE_IMAGE!=1; não gerando imagem, usando arquivos diretos."
  fi
}

adm_hook_post_install() {
  adm_info "sys/intel-microcode: post-install – configure o bootloader para carregar o microcode (arquivo .img ou diretório intel-ucode) conforme seu kernel/initramfs."
}
