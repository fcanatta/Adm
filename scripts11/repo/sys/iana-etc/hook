#!/usr/bin/env bash
# Hook inteligente para sys/iana-etc
# Pacote que provê /etc/services e /etc/protocols.
# Este hook:
#   - evita build padrão
#   - instala em root custom
#   - faz backup se arquivos já existirem

set -euo pipefail
IFS=$'\n\t'

ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"

if ! declare -F adm_info >/dev/null 2>&1; then
    _ts_i() { date +"%Y-%m-%d %H:%M:%S"; }
    adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_i)" "$*" >&2; }
    adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_i)" "$*" >&2; }
    adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_i)" "$*" >&2; }
    adm_die()   { adm_error "$*"; exit 1; }
fi

iana_install_root() {
    if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
        printf '%s\n' "$ADM_INSTALL_ROOT"
    elif [ -n "${DESTDIR:-}" ]; then
        printf '%s\n' "$DESTDIR"
    else
        printf '/\n'
    fi
}

iana_require_root_if_needed() {
    local root="$1"
    if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
        adm_die "sys/iana-etc: instalar diretamente em '/' requer root."
    fi
}

iana_detect_srctree() {
    # Pacotes iana-etc em geral possuem arquivos services/protocols na raiz ou em subdir etc/
    if [ -f "services" ] && [ -f "protocols" ]; then
        printf '%s\n' "$PWD"; return 0
    fi
    if [ -d "etc" ] && [ -f "etc/services" ] && [ -f "etc/protocols" ]; then
        printf '%s\n' "$PWD/etc"; return 0
    fi
    local d
    for d in "$PWD"/iana-etc-* "$PWD"/*; do
        [ -d "$d" ] || continue
        if [ -f "$d/services" ] && [ -f "$d/protocols" ]; then
            printf '%s\n' "$d"; return 0
        fi
        if [ -d "$d/etc" ] && [ -f "$d/etc/services" ] && [ -f "$d/etc/protocols" ]; then
            printf '%s\n' "$d/etc"; return 0
        fi
    done
    adm_die "sys/iana-etc: não foi possível detectar diretório com services/protocols."
}

iana_backup_if_exists() {
    local file="$1"
    if [ -f "$file" ]; then
        local backup="${file}.adm-backup-$(date +%Y%m%d%H%M%S)"
        adm_warn "sys/iana-etc: '$file' já existe; criando backup '$backup'."
        cp -f "$file" "$backup"
    fi
}

adm_hook_pre_build() {
    export ADM_SKIP_DEFAULT_BUILD=1
    adm_info "sys/iana-etc: build padrão desativado; apenas instalação de arquivos."
}

adm_hook_build() {
    adm_info "sys/iana-etc: nenhum build necessário (somente cópia de arquivos)."
}

adm_hook_install() {
    local src root etcdir
    src="$(iana_detect_srctree)"
    root="$(iana_install_root)"

    iana_require_root_if_needed "$root"

    etcdir="$root/etc"
    mkdir -p "$etcdir"

    adm_info "sys/iana-etc: instalando services/protocols em '$etcdir'..."

    iana_backup_if_exists "$etcdir/services"
    iana_backup_if_exists "$etcdir/protocols"

    cp -f "$src/services"   "$etcdir/services"
    cp -f "$src/protocols"  "$etcdir/protocols"

    adm_info "sys/iana-etc: instalação concluída."
}

adm_hook_post_install() {
    adm_info "sys/iana-etc: post-install – verifique se /etc/services e /etc/protocols estão corretos para seu ambiente."
}
