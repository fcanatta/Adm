#!/usr/bin/env bash
# Hook avançado para sys/e2fsprogs
# - build em diretório separado
# - make install + install-libs
# - cria /etc/mke2fs.conf se não existir

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_e2() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_e2)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_e2)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_e2)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

e2_jobs() { nproc 2>/dev/null || echo 1; }

e2_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

e2_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/e2fsprogs: instalar em '/' requer root."
  fi
}

e2_detect_srctree() {
  if [ -n "${ADM_E2FSPROGS_SRCDIR:-}" ] && [ -f "$ADM_E2FSPROGS_SRCDIR/configure" ]; then
    printf '%s\n' "$ADM_E2FSPROGS_SRCDIR"; return 0
  fi
  if [ -f "configure" ] && [ -d "lib" ] && [ -d "misc" ]; then
    printf '%s\n' "$PWD"; return 0
  fi
  local d
  for d in "$PWD"/e2fsprogs-* "$PWD"/*; do
    [ -d "$d" ] || continue
    if [ -f "$d/configure" ] && [ -d "$d/lib" ]; then
      printf '%s\n' "$d"; return 0
    fi
  done
  adm_die "sys/e2fsprogs: não encontrei diretório de fonte."
}

e2_build_dir() {
  local src="$1"
  printf '%s\n' "$src/build"
}

e2_init_mke2fs_conf() {
  local root="$1"
  local etc="$root/etc"
  local conf="$etc/mke2fs.conf"

  mkdir -p "$etc"

  if [ -f "$conf" ]; then
    local backup="${conf}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "sys/e2fsprogs: '$conf' já existe; backup em '$backup'."
    cp -f "$conf" "$backup"
    return 0
  fi

  adm_info "sys/e2fsprogs: criando /etc/mke2fs.conf padrão."
  cat >"$conf" <<'EOF'
[defaults]
    base_features = sparse_super,large_file,filetype,resize_inode,dir_index
    enable_periodic_fsck = 0
    blocksize = 4096
    inode_ratio = 16384

[fs_types]
    ext4 = {
        features = has_journal,extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize
        inode_size = 256
    }
EOF
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/e2fsprogs: build padrão desativado; usando hook."
}

adm_hook_build() {
  local src build jobs
  src="$(e2_detect_srctree)"
  build="$(e2_build_dir "$src")"
  jobs="$(e2_jobs)"

  adm_info "sys/e2fsprogs: src=$src build=$build jobs=$jobs"

  rm -rf "$build"
  mkdir -p "$build"

  (
    cd "$build"
    "$src/configure" \
      --prefix=/usr \
      --sysconfdir=/etc \
      --enable-elf-shlibs
    make -j"$jobs"
  )
}

adm_hook_install() {
  local src build root
  src="$(e2_detect_srctree)"
  build="$(e2_build_dir "$src")"
  root="$(e2_install_root)"

  e2_require_root_if_needed "$root"

  adm_info "sys/e2fsprogs: instalando em '$root'..."
  (
    cd "$build"
    make install DESTDIR="$root"
    make install-libs DESTDIR="$root"
  )

  e2_init_mke2fs_conf "$root"

  adm_info "sys/e2fsprogs: instalação concluída."
}

adm_hook_post_install() {
  adm_info "sys/e2fsprogs: post-install – use e2fsck, tune2fs e mke2fs conforme seu layout de partições."
}
