#!/usr/bin/env bash
# Hook avançado para sys/sysvinit
# - Compila e instala o SysVinit
# - Cria /etc/inittab se não existir (com backup se já existir)

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_sv() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_sv)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_sv)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_sv)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

sv_jobs() { nproc 2>/dev/null || echo 1; }

sv_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

sv_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/sysvinit: instalar em '/' requer root."
  fi
}

sv_detect_srctree() {
  if [ -n "${ADM_SYSVINIT_SRCDIR:-}" ] && [ -f "$ADM_SYSVINIT_SRCDIR/src/init.c" ]; then
    printf '%s\n' "$ADM_SYSVINIT_SRCDIR"; return 0
  fi
  if [ -d "src" ] && [ -f "src/init.c" ]; then
    printf '%s\n' "$PWD"; return 0
  fi
  local d
  for d in "$PWD"/sysvinit-* "$PWD"/*; do
    [ -d "$d/src" ] || continue
    if [ -f "$d/src/init.c" ]; then
      printf '%s\n' "$d"; return 0
    fi
  done
  adm_die "sys/sysvinit: não encontrei diretório de fonte."
}

sv_backup_if_exists() {
  local path="$1"
  if [ -f "$path" ]; then
    local backup="${path}.adm-backup-$(date +%Y%m%d%H%M%S)"
    adm_warn "sys/sysvinit: '$path' existe; backup em '$backup'."
    cp -f "$path" "$backup"
  fi
}

sv_init_inittab() {
  local root="$1"
  local etc="$root/etc"
  local inittab="$etc/inittab"

  mkdir -p "$etc"
  if [ -f "$inittab" ]; then
    sv_backup_if_exists "$inittab"
    adm_info "sys/sysvinit: /etc/inittab já existe, não sobrescrevendo."
    return 0
  fi

  adm_info "sys/sysvinit: criando /etc/inittab padrão."
  cat >"$inittab" <<'EOF'
# /etc/inittab padrão para SysVinit
id:3:initdefault:

si::sysinit:/etc/rc.d/rc.sysinit

l0:0:wait:/etc/rc.d/rc 0
l1:1:wait:/etc/rc.d/rc 1
l2:2:wait:/etc/rc.d/rc 2
l3:3:wait:/etc/rc.d/rc 3
l4:4:wait:/etc/rc.d/rc 4
l5:5:wait:/etc/rc.d/rc 5
l6:6:wait:/etc/rc.d/rc 6

ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

su:S:wait:/sbin/sulogin

1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600
EOF
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/sysvinit: build padrão desativado; usando hook."
}

adm_hook_build() {
  local src jobs
  src="$(sv_detect_srctree)"
  jobs="$(sv_jobs)"

  adm_info "sys/sysvinit: src=$src jobs=$jobs"

  (
    cd "$src/src"
    make -j"$jobs"
  )
}

adm_hook_install() {
  local src root
  src="$(sv_detect_srctree)"
  root="$(sv_install_root)"

  sv_require_root_if_needed "$root"

  adm_info "sys/sysvinit: instalando em '$root'..."
  (
    cd "$src"
    make install ROOT="$root"
  )

  sv_init_inittab "$root"

  adm_info "sys/sysvinit: instalação concluída."
}

adm_hook_post_install() {
  adm_info "sys/sysvinit: post-install – configure scripts em /etc/rc.d e runlevels conforme sua política."
}
