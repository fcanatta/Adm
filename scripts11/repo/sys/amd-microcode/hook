#!/usr/bin/env bash
# Hook inteligente para sys/amd-microcode
# - Usa blobs do linux-firmware (amd-ucode)
# - Opcionalmente gera /boot/amd-ucode.img para early microcode

set -euo pipefail
IFS=$'\n\t'

if ! declare -F adm_info >/dev/null 2>&1; then
  _ts_amc() { date +"%Y-%m-%d %H:%M:%S"; }
  adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_amc)" "$*" >&2; }
  adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_amc)" "$*" >&2; }
  adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_amc)" "$*" >&2; }
  adm_die()   { adm_error "$*"; exit 1; }
fi

amc_install_root() {
  if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
    printf '%s\n' "$ADM_INSTALL_ROOT"
  elif [ -n "${DESTDIR:-}" ]; then
    printf '%s\n' "$DESTDIR"
  else
    printf '/\n'
  fi
}

amc_require_root_if_needed() {
  local root="$1"
  if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
    adm_die "sys/amd-microcode: instalar diretamente em '/' (gerar /boot/amd-ucode.img) requer root."
  fi
}

amc_firmware_dir() {
  local root="$1"
  if [ -n "${ADM_FIRMWARE_DIR:-}" ]; then
    printf '%s\n' "$root${ADM_FIRMWARE_DIR}"
  else
    printf '%s\n' "$root/lib/firmware"
  fi
}

amc_boot_dir() {
  local root="$1"
  if [ -n "${ADM_BOOT_DIR:-}" ]; then
    printf '%s\n' "$root${ADM_BOOT_DIR}"
  else
    printf '%s\n' "$root/boot"
  fi
}

amc_check_amd_ucode() {
  local fwdir="$1"
  if [ ! -d "$fwdir/amd-ucode" ]; then
    adm_warn "sys/amd-microcode: diretório '$fwdir/amd-ucode' não encontrado. linux-firmware está instalado corretamente?"
    return 1
  fi
  return 0
}

amc_create_ucode_image() {
  local root="$1"
  local fwdir="$2"
  local bootdir
  bootdir="$(amc_boot_dir "$root")"

  mkdir -p "$bootdir"

  local out="$bootdir/amd-ucode.img"
  adm_info "sys/amd-microcode: gerando imagem de microcode em '$out'."

  if ! command -v cpio >/dev/null 2>&1; then
    adm_warn "sys/amd-microcode: 'cpio' não encontrado, não será possível gerar a imagem."
    return 1
  fi

  if command -v xz >/dev/null 2>&1; then
    ( cd "$fwdir" && find amd-ucode -type f | sort | cpio -o -H newc ) | xz -c >"$out"
  else
    ( cd "$fwdir" && find amd-ucode -type f | sort | cpio -o -H newc ) >"$out"
  fi

  adm_info "sys/amd-microcode: imagem gerada. Ajuste seu bootloader para carregar '$out' como microcode early."
}

adm_hook_pre_build() {
  export ADM_SKIP_DEFAULT_BUILD=1
  adm_info "sys/amd-microcode: build padrão desativado (meta-pacote, sem sources próprios)."
}

adm_hook_build() {
  adm_info "sys/amd-microcode: nenhum build necessário (somente organização de microcode)."
}

adm_hook_install() {
  local root fwdir
  root="$(amc_install_root)"
  fwdir="$(amc_firmware_dir "$root")"

  amc_require_root_if_needed "$root"

  adm_info "sys/amd-microcode: root='$root' firmware_dir='$fwdir'"

  if ! amc_check_amd_ucode "$fwdir"; then
    adm_warn "sys/amd-microcode: prosseguindo sem gerar imagem (firmware AMD não encontrado)."
    return 0
  fi

  adm_info "sys/amd-microcode: microcode AMD disponível em '$fwdir/amd-ucode'."

  if [ "${ADM_AMD_UCODE_CREATE_IMAGE:-0}" = "1" ]; then
    amc_create_ucode_image "$root" "$fwdir" || adm_warn "sys/amd-microcode: falha ao gerar imagem (ignorado)."
  else
    adm_info "sys/amd-microcode: ADM_AMD_UCODE_CREATE_IMAGE!=1; não gerando imagem, usando arquivos diretos."
  fi
}

adm_hook_post_install() {
  adm_info "sys/amd-microcode: post-install – configure o bootloader/initramfs para carregar o microcode conforme documentação do kernel."
}
