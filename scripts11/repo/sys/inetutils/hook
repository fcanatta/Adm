#!/usr/bin/env bash
# Hook avançado para sys/inetutils
# - Compila inetutils com opções seguras por padrão
# - Desativa clientes/servidores inseguros (rsh, rlogin, telnet etc.) a menos que explicitamente habilitados
# - Ajusta permissão de ping (setuid root) quando instalando em '/'
# - Respeita ADM_INSTALL_ROOT/DESTDIR

set -euo pipefail
IFS=$'\n\t'

ADM_ROOT="${ADM_ROOT:-/usr/src/adm}"

if ! declare -F adm_info >/dev/null 2>&1; then
    _ts_i2() { date +"%Y-%m-%d %H:%M:%S"; }
    adm_info()  { printf '[%s] [INFO] %s\n'  "$(_ts_i2)" "$*" >&2; }
    adm_warn()  { printf '[%s] [WARN] %s\n'  "$(_ts_i2)" "$*" >&2; }
    adm_error() { printf '[%s] [ERRO] %s\n'  "$(_ts_i2)" "$*" >&2; }
    adm_die()   { adm_error "$*"; exit 1; }
fi

inet_jobs() { nproc 2>/dev/null || echo 1; }

inet_install_root() {
    if [ -n "${ADM_INSTALL_ROOT:-}" ]; then
        printf '%s\n' "$ADM_INSTALL_ROOT"
    elif [ -n "${DESTDIR:-}" ]; then
        printf '%s\n' "$DESTDIR"
    else
        printf '/\n'
    fi
}

inet_require_root_if_needed() {
    local root="$1"
    if [ "$root" = "/" ] && [ "$(id -u)" -ne 0 ]; then
        adm_die "sys/inetutils: instalar diretamente em '/' requer root."
    fi
}

inet_detect_srctree() {
    if [ -n "${ADM_INETUTILS_SRCDIR:-}" ] && [ -f "$ADM_INETUTILS_SRCDIR/configure" ]; then
        printf '%s\n' "$ADM_INETUTILS_SRCDIR"; return 0
    fi
    if [ -f "configure" ] && [ -f "src/ping.c" ] 2>/dev/null; then
        printf '%s\n' "$PWD"; return 0
    fi
    local d
    for d in "$PWD"/inetutils-* "$PWD"/*; do
        [ -d "$d" ] || continue
        if [ -f "$d/configure" ] && [ -f "$d/src/ping.c" ] 2>/dev/null; then
            printf '%s\n' "$d"; return 0
        fi
    done
    adm_die "sys/inetutils: não foi possível detectar diretório de fonte."
}

inet_configure_flags() {
    # Padrão: desabilitar clientes/servidores inseguros
    local insecure="${ADM_INETUTILS_ENABLE_INSECURE:-0}"
    local flags="--prefix=/usr --sysconfdir=/etc --localstatedir=/var"

    if [ "$insecure" = "1" ]; then
        adm_warn "sys/inetutils: habilitando utilitários considerados inseguros (telnet, rlogin, rsh etc.) por ADM_INETUTILS_ENABLE_INSECURE=1."
        # aqui poderíamos deixar todos enable padrão
    else
        adm_info "sys/inetutils: desabilitando utilitários de rede inseguros (telnet, rlogin, rsh...)"
        flags="$flags \
            --disable-rsh \
            --disable-rlogin \
            --disable-rwho \
            --disable-rcp \
            --disable-telnet \
            --disable-telnetd \
            --disable-uucpd \
            --disable-syslogd \
            --disable-rlogind"
    fi

    # Exemplo: em minimal-toolchain podemos ainda restringir
    case "${ADM_PROFILE:-}" in
        minimal-toolchain)
            adm_info "sys/inetutils: profile minimal-toolchain – mantendo apenas ferramentas essenciais."
            # se quiser, você pode adicionar mais --disable aqui
            ;;
        *)
            ;;
    esac

    printf '%s\n' "$flags"
}

inet_fix_ping_permissions() {
    local root="$1"
    local ping="$root/bin/ping"
    local ping6="$root/bin/ping6"

    # Só faz sentido setuid em root real
    if [ "$root" != "/" ]; then
        adm_info "sys/inetutils: pulando ajuste de setuid em ping (root='$root' não é '/')."
        return 0
    fi

    if [ "$(id -u)" -ne 0 ]; then
        adm_warn "sys/inetutils: não é root; não foi possível ajustar setuid de ping."
        return 0
    fi

    if [ -f "$ping" ]; then
        adm_info "sys/inetutils: ajustando setuid em '$ping'."
        chmod u+s "$ping"
    fi
    if [ -f "$ping6" ]; then
        adm_info "sys/inetutils: ajustando setuid em '$ping6'."
        chmod u+s "$ping6" || true
    fi
}

adm_hook_pre_build() {
    export ADM_SKIP_DEFAULT_BUILD=1
    adm_info "sys/inetutils: build padrão desativado; usando fluxo do hook."
}

adm_hook_build() {
    local src root jobs cfg
    src="$(inet_detect_srctree)"
    root="$(inet_install_root)"
    jobs="$(inet_jobs)"
    cfg="$(inet_configure_flags)"

    inet_require_root_if_needed "$root"

    adm_info "sys/inetutils: src=$src root=$root jobs=$jobs"
    adm_info "sys/inetutils: flags de configure: $cfg"

    (
        cd "$src"
        adm_info "sys/inetutils: configurando..."
        ./configure $cfg

        adm_info "sys/inetutils: compilando..."
        make -j"$jobs"
    )
}

adm_hook_install() {
    local src root
    src="$(inet_detect_srctree)"
    root="$(inet_install_root)"

    inet_require_root_if_needed "$root"

    adm_info "sys/inetutils: instalando em '$root'..."
    (
        cd "$src"
        make install DESTDIR="$root"
    )

    inet_fix_ping_permissions "$root"

    adm_info "sys/inetutils: instalação concluída."
}

adm_hook_post_install() {
    adm_info "sys/inetutils: post-install – verifique se os serviços desejados estão habilitados e as ferramentas inseguras seguem a política do seu perfil."
}
