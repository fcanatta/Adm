# /usr/src/packages/core/lz4/metadata

name="lz4"
category="core"
version="1.10.0"
release="1"

sources=(
    "https://ftp.lfs-matrix.net/pub/lfs/lfs-packages/12.4/lz4-${version}.tar.gz"
)

# SHA256 deixado em branco como solicitado
sha256sums=()

depends=(
    "bash"
    "coreutils"
    "make"
    "gcc"
)

upstream_latest_version() {
    local api="https://api.github.com/repos/lz4/lz4/releases/latest"
    local json
    if command -v curl >/dev/null 2>&1; then
        json="$(curl -fsSL "$api")" || return 1
    elif command -v wget >/dev/null 2>&1; then
        json="$(wget -qO- "$api")" || return 1
    else
        echo "curl/wget ausentes" >&2
        return 1
    fi

    printf '%s\n' "$json" \
        | sed -n 's/.*"tag_name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' \
        | sed 's/^v//' \
        | head -n1
}

# Build real (LFS 12.4 – 8.9) adaptado para DESTDIR:
#   make BUILD_SHARED=yes PREFIX=/usr
#   make test
#   make BUILD_SHARED=yes PREFIX=/usr install
build() {
    : "${DESTDIR:=/}"

    local sdir
    sdir="$(find . -mindepth 1 -maxdepth 1 -type d -name "lz4-${version}" | head -n1)"
    [ -z "$sdir" ] && echo "Diretório lz4-${version} não encontrado" >&2 && return 1

    cd "$sdir"

    make BUILD_SHARED=yes PREFIX=/usr
    make test
    make BUILD_SHARED=yes PREFIX=/usr DESTDIR="${DESTDIR}" install
}
