# /usr/src/packages/core/xz/metadata

name="xz"
category="core"
version="5.8.1"
release="1"

# Fonte oficial (a mesma que o LFS usa, versão estável atual)
# Página oficial lista xz-5.8.1.tar.xz como um dos tarballs estáveis. 0
sources=(
  "https://tukaani.org/xz/xz-${version}.tar.xz"
)

depends=(
  "bash"
  "gcc"
  "make"
  "coreutils"
)

# SHA256 real do xz-5.8.1.tar.xz
# (hash confirmado em distros que usam o tarball original, por ex. Debian/PureOS
# para xz-utils_5.8.1.orig.tar.xz). 1
sha256sums=(
  "xz-${version}.tar.xz=0b54f79df85912504de0b14aec7971e3f964491af1812d83447005807513cd9e"
)

# Descobre versão mais nova usando a página oficial do XZ. 2
upstream_latest_version() {
  local html
  if command -v curl >/dev/null 2>&1; then
    html="$(curl -fsSL "https://tukaani.org/xz/")" || return 1
  else
    html="$(wget -qO- "https://tukaani.org/xz/")" || return 1
  fi

  printf '%s\n' "$html" \
    | sed -n 's/.*xz-\([0-9][0-9.]*\)\.tar\.xz.*/\1/p' \
    | sort -V | tail -n1
}

# BUILD REAL – seguindo exatamente o LFS 8.8.1:
#   ./configure --prefix=/usr --disable-static --docdir=/usr/share/doc/xz-5.8.1
#   make
#   make check
#   make install
# Só que aqui o "make install" vai para DESTDIR pra permitir empacotamento. 3
build() {
  : "${DESTDIR:=/}"

  # Encontrar diretório xz-5.8.1
  local sdir
  sdir="$(find . -mindepth 1 -maxdepth 1 -type d -name "xz-${version}" | head -n1)"

  if [ -z "$sdir" ]; then
    echo "Diretório xz-${version} não encontrado" >&2
    return 1
  fi

  cd "$sdir"

  ########################################
  # Configure (igual ao livro)
  ########################################

  ./configure --prefix=/usr        \
              --disable-static     \
              --docdir=/usr/share/doc/xz-${version}

  ########################################
  # Build + Teste (igual ao livro)
  ########################################

  make

  # Testes do LFS – se falhar você decide se ignora ou não no teu fluxo
  make check

  ########################################
  # Instalação em DESTDIR
  ########################################

  make DESTDIR="${DESTDIR}" install
}
