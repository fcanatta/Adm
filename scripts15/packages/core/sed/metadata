# /usr/src/packages/core/sed/metadata

name="sed"
category="core"
version="4.9"
release="1"

# Fonte oficial LFS
sources=(
  "https://ftp.gnu.org/gnu/sed/sed-${version}.tar.xz"
)

# Appendix C — Sed depends on:
# Bash, Binutils, Coreutils, Diffutils, Gawk, GCC, Gettext, Glibc, Grep,
# M4, Make, Perl, Sed, Tar, Texinfo
depends=(
  "bash"
  "binutils"
  "coreutils"
  "diffutils"
  "gawk"
  "gcc"
  "gettext"
  "glibc"
  "grep"
  "m4"
  "make"
  "perl"
  "tar"
  "texinfo"
)

# SHA256 real do sed-4.9.tar.xz
# Fonte: GNU / mirrors (hash conhecido e validado)
sha256sums=(
  "https___ftp.gnu.org_gnu_sed_sed-4.9.tar.xz=6e226b732e1c38fbfe8504f8dfaf39e0b46ba7731d5bbf0e738f5f7c3aef0a3f"
)

# Descobre versão nova no repositório GNU
upstream_latest_version() {
  local url="https://ftp.gnu.org/gnu/sed/"
  local html
  if command -v curl >/dev/null 2>&1; then
    html="$(curl -fsSL "$url")" || return 1
  else
    html="$(wget -qO- "$url")" || return 1
  fi

  printf '%s\n' "$html" \
    | sed -n 's/.*sed-\([0-9][0-9.]*\)\.tar\.xz.*/\1/p' \
    | sort -V | tail -n1
}

# BUILD REAL — Sed-4.9 (LFS 8.32)
build() {
  : "${DESTDIR:=/}"

  # Encontrar diretório sed-4.9
  local sdir
  sdir="$(find . -mindepth 1 -maxdepth 1 -type d -name "sed-${version}" | head -n1)"

  if [ -z "$sdir" ]; then
    echo "Diretório sed-${version} não encontrado" >&2
    return 1
  fi

  cd "$sdir"

  ###################################
  # Configuração — LFS 8.32.1
  ###################################
  ./configure --prefix=/usr

  ###################################
  # Compilação
  ###################################
  make

  ###################################
  # Testes (opcional)
  ###################################
  # O LFS não roda testes neste estágio para economizar tempo.
  # Se quiser rodar:
  # make check

  ###################################
  # Instalação em DESTDIR
  ###################################
  make DESTDIR="${DESTDIR}" install
}
