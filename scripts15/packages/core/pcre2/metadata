# /usr/src/packages/core/pcre2/metadata

name="pcre2"
category="core"
version="10.47"
release="1"

sources=(
    "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-${version}/pcre2-${version}.tar.bz2"
)

# Deixa em branco por enquanto (sem verificação de hash)
sha256sums=()

# Dependências reais:
# - zlib: --enable-pcre2grep-libz
# - bzip2: --enable-pcre2grep-libbz2
# - readline: --enable-pcre2test-libreadline
depends=(
    "bash"
    "coreutils"
    "make"
    "gcc"
    "zlib"
    "bzip2"
    "readline"
)

upstream_latest_version() {
    local url="https://github.com/PCRE2Project/pcre2/releases/latest"
    local html
    if command -v curl >/dev/null 2>&1; then
        html="$(curl -fsSL "$url")" || return 1
    elif command -v wget >/dev/null 2>&1; then
        html="$(wget -qO- "$url")" || return 1
    else
        echo "curl/wget não encontrados" >&2
        return 1
    fi

    printf '%s\n' "$html" \
        | sed -n 's/.*pcre2-\([0-9][0-9.]*\)\.tar\.bz2.*/\1/p' \
        | sort -V | tail -n1
}

# Build real LFS r12.4 (64-bit apenas), adaptado pra DESTDIR
build() {
    : "${DESTDIR:=/}"

    local sdir
    sdir="$(find . -mindepth 1 -maxdepth 1 -type d -name "pcre2-${version}" | head -n1)"
    [ -z "$sdir" ] && { echo "Diretório pcre2-${version} não encontrado" >&2; return 1; }

    cd "$sdir"

    ./configure --prefix=/usr                       \
                --docdir=/usr/share/doc/pcre2-${version} \
                --enable-unicode                    \
                --enable-jit                        \
                --enable-pcre2-16                   \
                --enable-pcre2-32                   \
                --enable-pcre2grep-libz             \
                --enable-pcre2grep-libbz2           \
                --enable-pcre2test-libreadline      \
                --disable-static

    make
    make check

    make DESTDIR="${DESTDIR}" install
}
