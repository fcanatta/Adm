# /usr/src/packages/core/gmp/metadata
name="gmp"
category="core"
version="6.3.0"
release="1"

sources=(
  "https://ftp.gnu.org/gnu/gmp/gmp-${version}.tar.xz"
)

# Dependências reais (Installation depends on, Appendix C)
depends=(
  "bash"
  "binutils"
  "coreutils"
  "diffutils"
  "gawk"
  "gcc"
  "glibc"
  "grep"
  "m4"
  "make"
  "sed"
  "texinfo"
)

sha256sums=(
  "gmp-${version}.tar.xz="
)

upstream_latest_version() {
  local url="https://ftp.gnu.org/gnu/gmp/"
  local html
  if command -v curl >/dev/null 2>&1; then
    html="$(curl -fsSL "$url")" || return 1
  else
    html="$(wget -qO- "$url")" || return 1
  fi
  printf '%s\n' "$html" \
    | sed -n 's/.*gmp-\([0-9][0-9.]*\)\.tar\.xz.*/\1/p' \
    | sort -V | tail -n1
}

# BUILD REAL – GMP-6.3.0 (LFS 8.21) com DESTDIR
build() {
  : "${DESTDIR:=/}"
  local sdir
  sdir="$(find . -mindepth 1 -maxdepth 1 -type d -name "gmp-${version}" | head -n1)"
  if [ -z "$sdir" ]; then
    echo "Diretório gmp-${version} não encontrado" >&2
    return 1
  fi

  cd "$sdir"

  ###################################
  # Ajuste para gcc-15 (LFS 8.21.1)
  ###################################
  sed -i '/long long t1;/,+1s/()/(...)/' configure

  ###################################
  # Configuração
  ###################################
  ./configure --prefix=/usr    \
              --enable-cxx     \
              --disable-static \
              --docdir=/usr/share/doc/gmp-${version}

  ###################################
  # Compilação + HTML
  ###################################
  make
  make html

  ###################################
  # Testes (críticos segundo o livro)
  ###################################
  make check 2>&1 | tee gmp-check-log || true
  # O livro ainda manda verificar 199+ PASS, mas isso é manual

  ###################################
  # Instalação em DESTDIR
  ###################################
  make DESTDIR="${DESTDIR}" install
  make DESTDIR="${DESTDIR}" install-html
}
