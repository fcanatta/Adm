#!/usr/bin/env bash
# Hook pós-instalação do Glibc para o adm
# Caminho: /mnt/adm/packages/libs/glibc/glibc.post_install
#
# Rodado DEPOIS que o tarball do glibc já foi extraído em / pelo adm.

set -euo pipefail

echo "==> [glibc.post_install] Configurações pós-instalação (ldd, nsswitch, loader, ld.so.conf)"

# ---------------------------------------------------------
# 1) Ajustar /usr/bin/ldd (passo do LFS) 0
#    sed '/RTLDLIST=/s@/usr@@g' -i /usr/bin/ldd
# ---------------------------------------------------------
if [ -x /usr/bin/ldd ]; then
  echo "==> [glibc.post_install] Ajustando /usr/bin/ldd (RTLDLIST)"
  sed -i '/RTLDLIST=/s@/usr@@g' /usr/bin/ldd || true
else
  echo "AVISO: /usr/bin/ldd não encontrado ou não executável."
fi

# ---------------------------------------------------------
# 2) /etc/nsswitch.conf
#    Glibc tem defaults muito pobres, então criamos um arquivo
#    básico se ele ainda não existir. Versão genérica (sem systemd),
#    inspirada nas configs do LFS. 1
# ---------------------------------------------------------
if [ ! -f /etc/nsswitch.conf ]; then
  echo "==> [glibc.post_install] Criando /etc/nsswitch.conf padrão"
  cat > /etc/nsswitch.conf << "EOF"
# Begin /etc/nsswitch.conf

passwd: files
group:  files
shadow: files

hosts:   files dns
networks: files

protocols: files
services:  files
ethers:    files
rpc:       files

# End /etc/nsswitch.conf
EOF
else
  echo "==> [glibc.post_install] /etc/nsswitch.conf já existe, não vou sobrescrever."
fi

# ---------------------------------------------------------
# 3) /etc/ld.so.conf + /etc/ld.so.conf.d
#    Configura o dynamic loader pra procurar libs em /usr/local/lib
#    e /opt/lib, e habilita include de *.conf. 2
# ---------------------------------------------------------
if [ ! -f /etc/ld.so.conf ]; then
  echo "==> [glibc.post_install] Criando /etc/ld.so.conf padrão"
  cat > /etc/ld.so.conf << "EOF"
# Begin /etc/ld.so.conf

/usr/local/lib
/opt/lib

# Add an include directory
include /etc/ld.so.conf.d/*.conf

# End /etc/ld.so.conf
EOF
else
  # Se já existe, pelo menos garantimos o include, sem duplicar
  if ! grep -q 'include /etc/ld.so.conf.d/\*.conf' /etc/ld.so.conf 2>/dev/null; then
    echo "==> [glibc.post_install] Adicionando include /etc/ld.so.conf.d/*.conf em /etc/ld.so.conf"
    cat >> /etc/ld.so.conf << "EOF"

# Add an include directory
include /etc/ld.so.conf.d/*.conf
EOF
  fi
fi

mkdir -p /etc/ld.so.conf.d

# ---------------------------------------------------------
# 4) Rodar ldconfig para atualizar o cache do loader
# ---------------------------------------------------------
if command -v ldconfig >/dev/null 2>&1; then
  echo "==> [glibc.post_install] Rodando ldconfig"
  ldconfig
else
  echo "AVISO: ldconfig não encontrado; não foi possível atualizar o cache de libs."
fi

# ---------------------------------------------------------
# 5) Time zone – apenas ajuda a criar /etc/localtime se ainda não existir
#    O povo do LFS gera os arquivos de zona com o pacote tzdata
#    (tzdata2025b.tar.gz + zic). 3
#
#    Aqui NÃO geramos zoneinfo (isso é trabalho do pacote tzdata),
#    só criamos o link /etc/localtime se:
#      - /etc/localtime não existe, e
#      - o arquivo em /usr/share/zoneinfo/$TZ existe.
#
#    Usa a variável ADM_TIMEZONE ou, se não setada, assumimos
#    America/Sao_Paulo (teu timezone). Ajuste isso se quiser outro padrão.
# ---------------------------------------------------------
TZ_DEFAULT="${ADM_TIMEZONE:-America/Sao_Paulo}"

if [ ! -e /etc/localtime ]; then
  if [ -f "/usr/share/zoneinfo/$TZ_DEFAULT" ]; then
    echo "==> [glibc.post_install] Criando /etc/localtime -> $TZ_DEFAULT"
    ln -sf "/usr/share/zoneinfo/$TZ_DEFAULT" /etc/localtime
  else
    echo "AVISO: /usr/share/zoneinfo/$TZ_DEFAULT não existe."
    echo "       Instale tzdata e/ou ajuste ADM_TIMEZONE antes de criar /etc/localtime."
  fi
else
  echo "==> [glibc.post_install] /etc/localtime já existe; não vou mexer."
fi

echo "==> [glibc.post_install] Configurações pós-instalação do glibc concluídas."
