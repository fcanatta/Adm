#!/usr/bin/env bash
# linux-kernel: pre-configure (atualizado)
# - Seleciona ARCH/CROSS_COMPILE a partir do TARGET_TRIPLET (se houver)
# - Prioridade do .config:
#   1) ADM_KERNEL_CONFIG (variável de ambiente)
#   2) /usr/src/adm/state/kernel-config.current (se apontar p/ arquivo válido)
#   3) arquivo "config" no diretório do source
#   4) defconfig
# - Sempre roda olddefconfig no final para preencher opções novas

set -Eeuo pipefail

: "${ADM_WORK_DIR:?}"; : "${ADM_BUILD_DIR:?}"

cd "${ADM_WORK_DIR}"

# ---------------- ARCH / CROSS_COMPILE ----------------
ARCH="${ARCH:-}"
if [ -z "$ARCH" ] && [ -n "${TARGET_TRIPLET:-}" ]; then
  case "$TARGET_TRIPLET" in
    x86_64-* ) ARCH=x86_64 ;;
    i?86-*   ) ARCH=i386 ;;
    aarch64-*|arm64-* ) ARCH=arm64 ;;
    arm-*    ) ARCH=arm ;;
    riscv64-* ) ARCH=riscv ;;
    ppc64le-* ) ARCH=powerpc ;;
    s390x-*  ) ARCH=s390 ;;
    *        ) ARCH="$(uname -m)";;
  esac
fi
[ -n "$ARCH" ] || ARCH="$(uname -m)"

CROSS_COMPILE="${CROSS_COMPILE:-}"
if [ -z "$CROSS_COMPILE" ] && [ -n "${TARGET_TRIPLET:-}" ]; then
  CROSS_COMPILE="${TARGET_TRIPLET}-"
fi

export ARCH CROSS_COMPILE

# ---------------- Diretório de build (O=) ----------------
mkdir -p "${ADM_BUILD_DIR}"

# ---------------- Seleção do .config ----------------
# Preferência a partir do estado, se ADM_KERNEL_CONFIG não vier do ambiente
if [ -z "${ADM_KERNEL_CONFIG:-}" ]; then
  if [ -f "/usr/src/adm/state/kernel-config.current" ]; then
    CAND="$(cat /usr/src/adm/state/kernel-config.current || true)"
    if [ -n "$CAND" ] && [ -f "$CAND" ]; then
      ADM_KERNEL_CONFIG="$CAND"
    fi
  fi
fi

# 1) ADM_KERNEL_CONFIG definido e existente → usar
if [ -n "${ADM_KERNEL_CONFIG:-}" ] && [ -f "${ADM_KERNEL_CONFIG}" ]; then
  cp -f "${ADM_KERNEL_CONFIG}" "${ADM_BUILD_DIR}/.config"
# 2) Arquivo "config" dentro do source → usar
elif [ -f "${ADM_WORK_DIR}/config" ]; then
  cp -f "${ADM_WORK_DIR}/config" "${ADM_BUILD_DIR}/.config"
# 3) Senão, gerar defconfig
else
  make -C "${ADM_WORK_DIR}" O="${ADM_BUILD_DIR}" ARCH="${ARCH}" CROSS_COMPILE="${CROSS_COMPILE}" defconfig
fi

# Completar opções novas sem interação
make -C "${ADM_WORK_DIR}" O="${ADM_BUILD_DIR}" ARCH="${ARCH}" CROSS_COMPILE="${CROSS_COMPILE}" olddefconfig
