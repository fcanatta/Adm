#!/usr/bin/env bash
# llvm-runtimes: configura build dos runtimes via monorepo (runtimes/)
set -Eeuo pipefail
: "${ADM_WORK_DIR:?}" "${ADM_BUILD_DIR:?}"

mkdir -p "$ADM_BUILD_DIR"
cd "$ADM_BUILD_DIR"

# Target opcional (melhor quando o toolchain final já existe)
TARGET_TRIPLET="${TARGET_TRIPLET:-}"
CMAKE_EXTRA=()
if [ -n "$TARGET_TRIPLET" ]; then
  CMAKE_EXTRA+=(-DCMAKE_C_COMPILER_TARGET="${TARGET_TRIPLET}"
                -DCMAKE_CXX_COMPILER_TARGET="${TARGET_TRIPLET}")
fi

# musl: preferir libunwind/abi estáveis
if ldd --version 2>&1 | grep -qi musl; then
  CMAKE_EXTRA+=( -DLIBCXX_USE_COMPILER_RT=ON
                 -DLIBCXXABI_USE_COMPILER_RT=ON
                 -DLIBCXXABI_USE_LLVM_UNWINDER=ON
                 -DLIBCXXABI_ENABLE_SHARED=ON
                 -DLIBCXX_ENABLE_SHARED=ON
                 -DLIBUNWIND_ENABLE_SHARED=ON )
fi

cmake -S "$ADM_WORK_DIR/runtimes" -B "$ADM_BUILD_DIR" \
  -G Ninja \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_BUILD_TYPE=Release \
  -DLLVM_ENABLE_RUNTIMES="compiler-rt;libcxx;libcxxabi;libunwind" \
  -DLLVM_INCLUDE_TESTS=OFF \
  -DLLVM_INCLUDE_DOCS=OFF \
  "${CMAKE_EXTRA[@]}"
