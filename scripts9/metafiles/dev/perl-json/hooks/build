#!/usr/bin/env bash
set -Eeuo pipefail
: "${WORKDIR:?}"; : "${JOBS:=4}"

cd "$WORKDIR"
srcdir="$(find . -maxdepth 1 -type d \( -name 'JSON-*' -o -name 'JSON-*.*' \) | head -n1 || true)"
[[ -d "$srcdir" ]] || { echo "[ERR] diretório JSON-* não encontrado em $WORKDIR" >&2; exit 3; }

cd "$srcdir"

if [[ -f Makefile.PL ]]; then
  make -j"$JOBS"
elif [[ -f Build.PL ]]; then
  ./Build
else
  echo "[ERR] nem Makefile.PL nem Build.PL encontrados em $(pwd)" >&2
  exit 4
fi
