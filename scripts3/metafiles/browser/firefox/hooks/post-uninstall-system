#!/usr/bin/env bash
# firefox post-uninstall-system ‚Äî remo√ß√£o limpa e atualiza√ß√£o dos caches
# $1 = WORKDIR (n√£o usado), $2 = DESTDIR (raiz onde firefox estava instalado)
set -euo pipefail

WORKDIR="${1:-${WORKDIR:-.}}"
DESTDIR="${2:-${DESTDIR:-/}}"

log() { printf '[firefox post-uninstall-system] %s\n' "$*"; }

log "Iniciando limpeza de integra√ß√£o do Firefox em ${DESTDIR}..."

# Caminhos de refer√™ncia
BIN_LINK="${DESTDIR}/usr/bin/firefox"
APP_FILE="${DESTDIR}/usr/share/applications/firefox.desktop"
ICON_FILE="${DESTDIR}/usr/share/icons/hicolor/128x128/apps/firefox.png"
FIREFOX_DIR="${DESTDIR}/usr/lib/firefox"
UPDATE_FILE="/usr/src/adm/update/browser/firefox/metafile"

# üîó Remover link simb√≥lico
if [ -L "${BIN_LINK}" ]; then
  rm -fv "${BIN_LINK}"
  log "Link simb√≥lico /usr/bin/firefox removido."
elif [ -f "${BIN_LINK}" ]; then
  rm -fv "${BIN_LINK}"
  log "Arquivo /usr/bin/firefox removido (n√£o era link)."
else
  log "Nenhum link/arquivo /usr/bin/firefox encontrado."
fi

# üóÇÔ∏è Remover arquivo .desktop
if [ -f "${APP_FILE}" ]; then
  rm -fv "${APP_FILE}"
  log "Arquivo .desktop removido."
else
  log "Nenhum arquivo .desktop encontrado."
fi

# üñºÔ∏è Remover √≠cone
if [ -f "${ICON_FILE}" ]; then
  rm -fv "${ICON_FILE}"
  log "√çcone firefox.png removido."
else
  log "Nenhum √≠cone encontrado em ${ICON_FILE}."
fi

# üßπ Remover diret√≥rio do Firefox (se sobrou algo e n√£o √© compartilhado)
if [ -d "${FIREFOX_DIR}" ]; then
  log "Removendo diret√≥rio de instala√ß√£o residual..."
  rm -rfv "${FIREFOX_DIR}" || true
fi

# üîÑ Atualizar caches (desktop/mime/icons)
if command -v update-desktop-database >/dev/null 2>&1; then
  update-desktop-database "${DESTDIR}/usr/share/applications" || true
fi
if command -v update-mime-database >/dev/null 2>&1; then
  update-mime-database "${DESTDIR}/usr/share/mime" || true
fi
if command -v gtk-update-icon-cache >/dev/null 2>&1; then
  gtk-update-icon-cache -qf "${DESTDIR}/usr/share/icons/hicolor" || true
fi

# üßæ Remover do adm-db (registro)
if command -v adm-db >/dev/null 2>&1; then
  log "Removendo registro do Firefox do adm-db..."
  adm-db remove --name firefox --category browser || true
fi

# üÜô Remover metafile de atualiza√ß√£o
if [ -f "${UPDATE_FILE}" ]; then
  rm -fv "${UPDATE_FILE}"
  log "Metafile de atualiza√ß√£o removido (${UPDATE_FILE})."
fi

log "Limpeza de integra√ß√£o do Firefox conclu√≠da com sucesso."
exit 0
