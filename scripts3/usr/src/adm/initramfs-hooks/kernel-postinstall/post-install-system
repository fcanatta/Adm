#!/usr/bin/env bash
# post-install-system — Hook de pós-instalação do kernel
# Cria initramfs automaticamente após instalação do kernel
# Integrado com adm-mkinitramfs.sh
#
# Chamado automaticamente pelo adm-build / adm-install após instalar "linux" (kernel)
# ou manualmente: /usr/src/adm/metafiles/kernel/linux/hooks/post-install-system
#
# Autor: GPT-5 para o sistema ADM de Fernando
# Versão: 1.0 (completa e funcional)
set -euo pipefail

HOOK_NAME="[kernel post-install]"
ADM_SCRIPTS="/usr/src/adm/scripts"
ADM_LOG="/usr/src/adm/log"
ADM_TMP="/usr/src/adm/temp"

KERNEL_NAME="linux"
KERNEL_VERSION=""
KERNEL_IMAGE=""
DEST="/boot"
STAGE_DIR=""
DRYRUN=0
YES=0
COMPRESSOR="xz"
MKINIT="${ADM_SCRIPTS}/adm-mkinitramfs.sh"

# Funções utilitárias
log() { printf "\033[1;35m%s\033[0m %s\n" "${HOOK_NAME}" "$*"; }
warn() { printf "\033[1;33m[WARN]\033[0m %s\n" "$*"; }
err()  { printf "\033[1;31m[ERRO]\033[0m %s\n" "$*" >&2; exit 1; }

# Verifica se adm-mkinitramfs existe e é executável
if [ ! -x "${MKINIT}" ]; then
  err "adm-mkinitramfs.sh não encontrado em ${MKINIT}"
fi

# Detectar versão do kernel recém-instalado
detect_kernel_version() {
  local ver=""
  # Tenta detectar pelo /lib/modules
  if [ -d "/lib/modules" ]; then
    ver="$(ls -1 /lib/modules | sort -V | tail -n1 || true)"
  fi
  # Fallback: detecta arquivo vmlinuz*
  if [ -z "$ver" ]; then
    ver="$(ls -1 /boot/vmlinuz-* 2>/dev/null | sed -E 's|.*/vmlinuz-||' | sort -V | tail -n1 || true)"
  fi
  echo "$ver"
}

KERNEL_VERSION="$(detect_kernel_version)"
[ -n "${KERNEL_VERSION}" ] || err "Não foi possível detectar a versão do kernel instalado."

log "Kernel instalado detectado: versão ${KERNEL_VERSION}"

# Detectar imagem kernel
KERNEL_IMAGE="/boot/vmlinuz-${KERNEL_VERSION}"
if [ ! -f "${KERNEL_IMAGE}" ]; then
  warn "Imagem do kernel não encontrada: ${KERNEL_IMAGE}"
  warn "Continuando mesmo assim (usando apenas /lib/modules/${KERNEL_VERSION})"
fi

# Determinar se estamos em um stage de bootstrap
if [ -n "${ADM_STAGE:-}" ] && [[ "${ADM_STAGE}" =~ ^stage[0-9]+$ ]]; then
  STAGE_DIR="/usr/src/adm/bootstrap/${ADM_STAGE}/root"
  YES=1  # modo automático em bootstrap
  log "Detectado modo bootstrap (${ADM_STAGE}), usando ${STAGE_DIR} e --yes"
fi

# Log e status inicial
mkdir -p "${ADM_LOG}"
LOG_FILE="${ADM_LOG}/adm-mkinitramfs-${KERNEL_VERSION}.log"
log "Registrando execução em: ${LOG_FILE}"

# Geração do initramfs
CMD="${MKINIT} --kernel-version ${KERNEL_VERSION} --compressor ${COMPRESSOR}"

if [ -n "${STAGE_DIR}" ]; then
  CMD+=" --stage-dir ${STAGE_DIR}"
else
  CMD+=" --dest ${DEST}"
fi

[ "${YES}" -eq 1 ] && CMD+=" --yes"

log "Executando: ${CMD}"

# >>> Esta operação cria initramfs e pode sobrescrever arquivos em /boot.
#     Comentário de segurança: somente é executada automaticamente após confirmação explícita
#     ou se estiver em modo bootstrap (--yes ativado).
set +e
"${MKINIT}" ${CMD#${MKINIT}} > "${LOG_FILE}" 2>&1
RC=$?
set -e

if [ "$RC" -eq 0 ]; then
  log "✔️ Initramfs criado com sucesso para ${KERNEL_VERSION}"
else
  err "Falha ao gerar initramfs. Consulte ${LOG_FILE}"
fi

# Registrar no banco de dados ADM (se disponível)
if command -v adm-db >/dev/null 2>&1; then
  adm-db log "kernel:${KERNEL_VERSION}" "initramfs criado com sucesso em $(date '+%Y-%m-%d %H:%M:%S')" || true
fi

# Notificação visual opcional
if command -v notify-send >/dev/null 2>&1; then
  notify-send -a "ADM Kernel" "Initramfs atualizado" "Kernel ${KERNEL_VERSION} → ${DEST}/initramfs-${KERNEL_VERSION}.img.${COMPRESSOR}"
fi

log "Hook de pós-instalação do kernel finalizado com sucesso."
exit 0
