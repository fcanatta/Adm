ROADMAP – ADM 2.0 (Gerenciador source-based inteligente)

Diretórios principais

/root/usr/src/adm/

scripts/ – todos os scripts ADM (sem subpastas)

packages/<categoria>/<programa>/

metadado

hook-pre-*, hook-post-*


build/       – diretórios de build

dest/        – DESTDIR de cada pacote

cache-src/   – cache de fontes (tarballs, clones git, etc.)

cache-bin/   – pacotes binários gerados

logs/        – logs de operações e builds

db/

installed/   – pacotes instalados e seus arquivos

history/     – histórico de builds por pacote/operação

upgrade-list – lista de pacotes para upgrade

snapshots/   – snapshots de estado de sistema

knowledge/   – banco de conhecimento (includes→pacotes, padrões, etc.)

metrics/     – tempos, tamanhos, contadores

events/      – eventos emitidos pelos scripts


backup/metadados/ – backups de arquivos metadado

tmp/         – temporários diversos



Instalação final sempre em /usr.

Formato do arquivo metadado

Campos mínimos:

name

version

release

category

license

url

build_deps  (lista simples de nomes)

run_deps

opt_deps

groups      (ex.: base, xorg, toolchain)

source_uri  (uma por linha; suporta http(s), git, gitlab, github, rsync, etc.)

source_checksum (uma por linha; sha256 correspondente a cada URI)


Scripts (ordem lógica de implementação)

1. adm-env

Define ROOT e caminhos padrão.

Ex: caminhos de build/, cache-src/, db/, logs/.



2. adm-log-ui

Padroniza saída no terminal:

timestamps, cores, spinner, símbolos ✔/✖/!.


Funções para:

iniciar operação, atualizar status, finalizar com sucesso/erro.


Estilo visual igual ao da foto enviada.



3. adm-eventd (barramento de eventos)

API simples para scripts emitirem eventos:

PKG_FETCH_STARTED, PKG_BUILD_DONE, UPGRADE_PLAN_READY, etc.


Grava eventos em db/events/.

Permite que adm-tui e adm-metrics leiam em tempo real.



4. adm-db

Lê/escreve:

db/installed/ (info de pacotes instalados)

db/history/ (registros de build/update/upgrade)

db/upgrade-list


Fornece funções para:

registrar instalação, remoção, falha, etc.




5. adm-knowledge

Mantém o banco de conhecimento em db/knowledge/:

includes → pacotes

libs detectadas → pacotes

padrões de arquivos → build_system.


Recebe eventos de adm-scan e adm-check e atualiza mapeamentos.

Ajuda adm-scan e adm-deps a inferirem deps com mais precisão.



6. adm-metrics

Grava métricas:

tempo total de build por pacote

tempos das fases (fetch, scan, build, check)

tamanho de pacotes binários

contagem de falhas/sucessos.


Lê eventos de adm-eventd.



7. adm-fetch

Lê source_uri do metadado.

Identifica tipo (git, http, sourceforge, rsync…).

Faz download em paralelo para cache-src/.

Calcula sha256 e compara com source_checksum.

Emite eventos PKG_FETCH_*.

Integra com adm-log-ui e adm-metrics.



8. adm-scan

Extrai fontes em build/….

Detecta:

build_system (autotools, cmake, meson, python, rust, go, etc.)

linguagens usadas (C, C++, Rust, Go, Fortran, etc.)

compiladores/linkers preferidos (via Makefile, configure, etc.)

dependências (includes, pkg-config, manifests).


Gera um “Plano de Construção” para cada pacote.

Emite PKG_SCAN_DONE.

Alimenta adm-knowledge.



9. adm-deps

Junta deps declaradas (build_deps, run_deps, opt_deps) com deps detectadas pelo scanner.

Constrói grafo de dependências:

normal (quem eu preciso)

reverso (quem depende de mim).


Calcula ordens de build.

É usado por adm, adm-build, adm-update, adm-upgrade.



10. adm-build

Recebe plano de build e ordem de dependências.

Escolhe profile, libc e toolchain.

Prepara chroot/sandbox.

Executa fases:

hooks hook-pre-*

configure (conforme build_system)

build (com cache de compilação)

test (opcional)

install em DESTDIR (dest/).

hooks hook-post-*


Empacota DESTDIR em cache-bin/.

Instala em /usr.

Atualiza db/installed e db/history.

Emite eventos PKG_BUILD_*.

Chama adm-check ao final (se configurado).



11. adm-check

Verifica:

permissões, donos, links simbólicos

libs dinâmicas (ldd) e RPATH seguro

shebangs

docs e manpages em locais certos.


Integra com adm-knowledge (associa libs detectadas a pacotes).

Emite PKG_CHECK_OK ou PKG_CHECK_FAILED.



12. adm-update

Alvos: pacote, grupo ou --all.

Para cada alvo:

verifica nova versão upstream (GitHub/GitLab/tarball/rsync).

se houver:

faz backup de metadado.

atualiza version, source_uri.

chama adm-fetch para baixar novo source e gerar source_checksum.

chama adm-scan e ajusta build_deps/run_deps.

gera metadados-esqueleto para novas deps.


se não houver:

marca como “up-to-date”.

se --force, adiciona à lista com flag de rebuild.



Mantém db/upgrade-list com todos os pacotes e versões novas.

Emite eventos UPDATE_*.



13. adm-upgrade

Lê db/upgrade-list (ou arquivo).

Usa adm-deps para descobrir reverse deps.

Analisa impacto de ABI/API:

compara SONAMEs e, se possível, símbolos exportados.

classifica upgrades como “safe” ou “abi-break”.


Gera planos:

safe, full ou customizados.


Resolve ordem de build e chama adm-build para cada item.

Reaproveita pacotes de cache-bin/ quando assinatura de build é igual.

Atualiza db/installed e db/history.

Emite eventos UPGRADE_*.



14. adm-snapshot

create: registra versões de todos os pacotes, profiles e toolchains.

diff: compara snapshots.

restore: calcula o que precisa ser buildado/upgrade/downgrade para voltar ao estado gravado.



15. adm-report

Lê db/metrics e db/history.

Gera relatórios:

pacotes que mais demoram

pacotes que mais falham

estatísticas de uso.




16. adm-tui

Interface de texto usando eventos e logs:

mostra fila de tarefas

status de cada pacote

barra de progresso global

acesso rápido a logs de build.


Permite pausar/resumir build, priorizar pacotes, etc.



17. adm (CLI principal)

Comandos:

build, build-group

update, upgrade

check

search, info, list-installed

snapshot, report, tui

help


Converte comandos em tarefas, chama scripts apropriados e registra estado.
