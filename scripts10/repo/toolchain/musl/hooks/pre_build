#!/usr/bin/env bash
# hook: pre_build para musl (toolchain cross)
# Constrói musl libc no sysroot ${ADM_CROSS_ROOT}/${ADM_TARGET}

set -eu

: "${ADM_ROOT:=/usr/src/adm}"
: "${ADM_CROSS_ROOT:=$ADM_ROOT/cross-tools}"
: "${ADM_TARGET:=x86_64-linux-musl}"

: "${ADM_BUILD_SRC_DIR:?}"
: "${ADM_BUILD_BUILD_DIR:?}"

mkdir -p "$ADM_BUILD_BUILD_DIR"

SYSROOT="${ADM_CROSS_ROOT}"

export ADM_BUILD_PREFIX="${SYSROOT}/${ADM_TARGET}"

export ADM_BUILD_CONFIGURE_EXTRA="
  --prefix=/usr
  --target=${ADM_TARGET}
  --syslibdir=/lib
"

if [ ! -d "${SYSROOT}/${ADM_TARGET}/include" ]; then
    printf '[musl pre_build] WARNING: headers do Linux não encontrados em %s\n' \
        "${SYSROOT}/${ADM_TARGET}/include" >&2
fi

export CC="${ADM_TARGET}-gcc"
export CFLAGS="${CFLAGS:--O2 -pipe}"
export CXXFLAGS="${CXXFLAGS:--O2 -pipe}"

case ":$PATH:" in
    *":${ADM_CROSS_ROOT}/bin:"*) ;;
    *) export PATH="${ADM_CROSS_ROOT}/bin:${PATH}" ;;
esac
