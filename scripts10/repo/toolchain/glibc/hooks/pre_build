#!/usr/bin/env bash
# hook: pre_build para glibc
# Objetivo:
#   - Configurar glibc para instalar no sysroot do cross-tools
#   - Usar headers do linux-headers

set -eu

: "${ADM_ROOT:=/usr/src/adm}"
: "${ADM_CROSS_ROOT:=$ADM_ROOT/cross-tools}"
: "${ADM_TARGET:=x86_64-linux-gnu}"

: "${ADM_BUILD_SRC_DIR:?}"
: "${ADM_BUILD_BUILD_DIR:?}"

mkdir -p "$ADM_BUILD_BUILD_DIR"

# DiretÃ³rio onde linux-headers instalou os headers
SYSROOT="${ADM_CROSS_ROOT}"

export ADM_BUILD_PREFIX="${SYSROOT}/${ADM_TARGET}"

export ADM_BUILD_CONFIGURE_EXTRA="
  --host=${ADM_TARGET}
  --build=$(../scripts/config.guess 2>/dev/null || echo $(uname -m)-unknown-linux-gnu)
  --prefix=/usr
  --with-headers=${SYSROOT}/${ADM_TARGET}/include
  --enable-kernel=6.12.0
  --disable-werror
"

export CFLAGS="-O2 -pipe"
export CXXFLAGS="-O2 -pipe"
export PATH="${ADM_CROSS_ROOT}/bin:${PATH}"
