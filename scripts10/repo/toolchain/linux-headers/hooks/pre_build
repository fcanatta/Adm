#!/usr/bin/env bash
# hook: pre_build para linux-headers
#
# Objetivo:
#   - Rodar o build REAL dos headers do kernel:
#       make mrproper
#       make headers_install
#   - Instalar em:
#       ${ADM_CROSS_ROOT}/${ADM_TARGET}/include
#   - Avisar ao build.sh que NÃO deve rodar o fluxo padrão
#     (configure/make/install) para este pacote.

set -eu

# Raiz do ADM e cross-tools
: "${ADM_ROOT:=/usr/src/adm}"
: "${ADM_CROSS_ROOT:=$ADM_ROOT/cross-tools}"

# Target padrão, se não vier de fora
: "${ADM_TARGET:=x86_64-linux-gnu}"

# Variáveis fornecidas pelo build.sh
: "${ADM_BUILD_SRC_DIR:?}"

# Destino dos headers dentro do sysroot
DESTDIR="${ADM_CROSS_ROOT}/${ADM_TARGET}/include"

mkdir -p "${DESTDIR}"

cd "${ADM_BUILD_SRC_DIR}"

# Limpa árvore (ignora erro se não suportar)
make mrproper >/dev/null 2>&1 || true

# ARCH aproximado a partir do target (x86_64-linux-gnu → x86_64)
ARCH="${ADM_TARGET%%-*}"

echo "[linux-headers hook] Instalando headers em ${DESTDIR} (ARCH=${ARCH})"

make headers_install \
    ARCH="${ARCH}" \
    INSTALL_HDR_PATH="${DESTDIR}"

# Diz pro build.sh que não deve rodar os drivers padrão
export ADM_BUILD_SKIP_DEFAULT=1
