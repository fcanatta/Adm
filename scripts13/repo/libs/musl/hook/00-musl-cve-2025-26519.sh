#!/usr/bin/env bash
# Hook: aplica patches de segurança da musl 1.2.5 (CVE-2025-26519)
# Usa os patches oficiais da lista musl@openwall:
#   https://www.openwall.com/lists/musl/2025/02/13/1/1
#   https://www.openwall.com/lists/musl/2025/02/13/1/2

set -euo pipefail

: "${ADM_BUILD_DIR:="${PWD}"}"

PATCH_MARKER="${ADM_BUILD_DIR}/.musl-cve-2025-26519.applied"

if [[ -f "${PATCH_MARKER}" ]]; then
    echo "[musl-hook] Patch CVE-2025-26519 já aplicado, ignorando."
    exit 0
fi

cd "${ADM_BUILD_DIR}"

echo "[musl-hook] Baixando e aplicando patches CVE-2025-26519 da Openwall..."

# Primeiro patch (validação de entrada no decodificador EUC-KR)
curl -fsSL "https://www.openwall.com/lists/musl/2025/02/13/1/1" \
  | sed '1,/^---$/d' \
  | patch -p1

# Segundo patch (reforça o encoder UTF-8 para não assumir invariantes inválidos)
curl -fsSL "https://www.openwall.com/lists/musl/2025/02/13/1/2" \
  | sed '1,/^---$/d' \
  | patch -p1

touch "${PATCH_MARKER}"

echo "[musl-hook] Patches CVE-2025-26519 aplicados com sucesso."
