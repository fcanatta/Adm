#!/usr/bin/env bash
# adm-profile - Gerenciador de profiles de compilação do ADM 2.0
#
# Funções principais (CLI):
#
#   init-defaults
#     Cria os perfis padrão (se ainda não existirem):
#       * glibc/extreme        (otimizações extremas para glibc)
#       * musl/extreme         (otimizações extremas para musl)
#       * toolchain/safe-glibc (perfil seguro para toolchain com glibc)
#       * toolchain/safe-musl  (perfil seguro para toolchain com musl)
#
#   list
#     Lista todos os profiles disponíveis (IDs).
#
#   show ID
#     Mostra o conteúdo detalhado de um profile.
#
#   export ID
#     Imprime "export ..." para:
#       ADM_PROFILE_ID, ADM_PROFILE_LIBC, ADM_PROFILE_KIND,
#       CFLAGS, CXXFLAGS, LDFLAGS, MAKEFLAGS (-j$(nproc) se houver)
#
#     Exemplo:
#       eval "$(adm-profile export glibc/extreme)"
#
#   current
#     Mostra o profile atual (se definido em db/profiles/current).
#
#   set-current ID
#     Define o profile atual.
#
#   create ID --libc glibc|musl --kind extreme|safe [--desc "texto"]
#     Cria um profile novo baseado nos templates internos de flags.
#
# Notas:
#   - Os profiles são armazenados em:
#       ${ADM_DB_DIR}/profiles/<id>.profile
#     Ex.: glibc/extreme -> ${ADM_DB_DIR}/profiles/glibc/extreme.profile
#
#   - Outros scripts (como adm-build) podem:
#       source adm-profile
#       adm_profile_load_env "glibc/extreme"
#
#     ou via CLI:
#       eval "$(adm-profile export glibc/extreme)"
#

set -o errexit
set -o nounset
set -o pipefail

# =========
# Descobrir diretório e carregar módulos
# =========

_adm_profile_script_dir() {
    local src="${BASH_SOURCE[0]:-$0}"
    while [ -L "$src" ]; do
        local target
        target=$(readlink "$src") || break
        if [[ "$target" = /* ]]; then
            src="$target"
        else
            src="$(dirname "$src")/$target"
        fi
    done
    cd "$(dirname "$src")" >/dev/null 2>&1 || {
        printf 'ADM-ERROR: Não foi possível entrar no diretório do script adm-profile.\n' >&2
        exit 1
    }
    pwd
}

_ADM_PROFILE_DIR="$(_adm_profile_script_dir)"

# shellcheck disable=SC1090
source "$_ADM_PROFILE_DIR/adm-env"
# shellcheck disable=SC1090
source "$_ADM_PROFILE_DIR/adm-log-ui"
# shellcheck disable=SC1090
source "$_ADM_PROFILE_DIR/adm-eventd"
# shellcheck disable=SC1090
source "$_ADM_PROFILE_DIR/adm-metrics"
# shellcheck disable=SC1090
source "$_ADM_PROFILE_DIR/adm-db"

ADM_PROFILE_DB_DIR="${ADM_DB_DIR}/profiles"
ADM_PROFILE_CURRENT_FILE="${ADM_PROFILE_DB_DIR}/current"

# =========
# Utilidades básicas
# =========

adm_profile_ensure_dir() {
    if [[ ! -d "$ADM_PROFILE_DB_DIR" ]]; then
        mkdir -p "$ADM_PROFILE_DB_DIR" || adm_log_fatal "Falha ao criar '$ADM_PROFILE_DB_DIR'."
    fi
}

adm_profile_id_to_path() {
    # ID ex: glibc/extreme -> ${ADM_DB_DIR}/profiles/glibc/extreme.profile
    local id="$1"
    adm_profile_ensure_dir
    printf '%s/%s.profile\n' "$ADM_PROFILE_DB_DIR" "$id"
}

adm_profile_list_ids() {
    # Lista IDs existentes, convertendo caminhos para ID (removendo prefixo e .profile).
    if [[ ! -d "$ADM_PROFILE_DB_DIR" ]]; then
        return 0
    fi
    local base="$ADM_PROFILE_DB_DIR"
    find "$base" -type f -name '*.profile' 2>/dev/null \
        | sed "s#^${base}/##" \
        | sed 's/\.profile$//' \
        | sort
}

adm_profile_read_field() {
    # Lê um campo key=value de um arquivo .profile.
    local file="$1"
    local key="$2"
    awk -F'=' -v k="$key" '
        $1 == k {
            $1="";
            sub(/^=/, "", $0);
            sub(/^[[:space:]]+/, "", $0);
            print $0;
            exit 0;
        }
    ' "$file"
}

adm_profile_default_flags() {
    # Retorna CFLAGS, CXXFLAGS, LDFLAGS (separados por TAB) para
    # a combinação (libc, kind).
    #
    # Uso:
    #   out=$(adm_profile_default_flags glibc extreme)
    #   cflags="${out%%$'\t'*}"
    #   rest="${out#*$'\t'}"
    #   cxxflags="${rest%%$'\t'*}"
    #   ldflags="${rest#*$'\t'}"
    local libc="$1"
    local kind="$2"
    local cflags="" cxxflags="" ldflags=""

    case "${libc}:${kind}" in
        glibc:extreme)
            cflags="-O3 -pipe -march=native -mtune=native -fno-plt -flto=auto -fgraphite-identity -floop-nest-optimize"
            cxxflags="$cflags"
            ldflags="-Wl,-O2,-Wl,-as-needed,-Wl,-z,relro,-Wl,-z,now"
            ;;
        musl:extreme)
            # mais conservador com musl, mas ainda agressivo
            cflags="-O3 -pipe -march=native -mtune=native -fno-plt -flto=auto -fvisibility=hidden -fstack-protector-strong"
            cxxflags="$cflags"
            ldflags="-Wl,-O2,-Wl,-z,relro,-Wl,-z,now"
            ;;
        glibc:safe)
            # seguro para toolchain glibc
            cflags="-O2 -pipe -fstack-protector-strong -D_FORTIFY_SOURCE=2 -fno-plt"
            cxxflags="$cflags"
            ldflags="-Wl,-O2,-Wl,-z,relro,-Wl,-z,now"
            ;;
        musl:safe)
            # seguro para toolchain musl
            cflags="-O2 -pipe -fstack-protector-strong -fno-plt"
            cxxflags="$cflags"
            ldflags="-Wl,-O2,-Wl,-z,relro,-Wl,-z,now"
            ;;
        *)
            # fallback neutro
            cflags="-O2 -pipe"
            cxxflags="$cflags"
            ldflags="-Wl,-O2"
            ;;
    esac

    printf '%s\t%s\t%s\n' "$cflags" "$cxxflags" "$ldflags"
}

adm_profile_write_file() {
    # Cria/atualiza um arquivo de profile com campos básicos.
    #
    # Uso:
    #   adm_profile_write_file ID libc kind desc cflags cxxflags ldflags
    local id="$1"
    local libc="$2"
    local kind="$3"
    local desc="$4"
    local cflags="$5"
    local cxxflags="$6"
    local ldflags="$7"

    local path
    path="$(adm_profile_id_to_path "$id")"
    local dir
    dir="$(dirname "$path")"

    mkdir -p "$dir" || adm_log_fatal "Falha ao criar diretório '$dir' para profile $id."

    cat >"$path.tmp" <<EOF
id=$id
libc=$libc
kind=$kind
desc=$desc
cflags=$cflags
cxxflags=$cxxflags
ldflags=$ldflags
EOF

    mv "$path.tmp" "$path" || adm_log_fatal "Falha ao gravar profile $id em '$path'."

    adm_log_ok "Profile salvo: $id"
    adm_event_emit "PROFILE_SAVE" "$id" "libc=$libc kind=$kind"
}

# =========
# Profile atual
# =========

adm_profile_set_current() {
    local id="$1"
    local path
    path="$(adm_profile_id_to_path "$id")"

    if [[ ! -f "$path" ]]; then
        adm_log_fatal "Profile não encontrado para set-current: $id ($path)"
    fi

    adm_profile_ensure_dir

    echo "$id" >"${ADM_PROFILE_CURRENT_FILE}.tmp"
    mv "${ADM_PROFILE_CURRENT_FILE}.tmp" "$ADM_PROFILE_CURRENT_FILE" \
        || adm_log_fatal "Falha ao gravar profile atual em '$ADM_PROFILE_CURRENT_FILE'."

    adm_log_ok "Profile atual definido: $id"
    adm_event_emit "PROFILE_SET_CURRENT" "$id" ""
}

adm_profile_get_current() {
    if [[ -f "$ADM_PROFILE_CURRENT_FILE" ]]; then
        sed -n '1p' "$ADM_PROFILE_CURRENT_FILE"
    fi
}

# =========
# Aplicar profile (export/env) – usado por outros scripts
# =========

adm_profile_load_env() {
    # Uso (para scripts que dão source em adm-profile):
    #   adm_profile_load_env ID
    #
    # Efeitos:
    #   export ADM_PROFILE_ID, ADM_PROFILE_LIBC, ADM_PROFILE_KIND
    #   export CFLAGS, CXXFLAGS, LDFLAGS (substituindo os atuais)
    #   export MAKEFLAGS="-j$(nproc)" (se nproc disponível)
    local id="${1:-}"

    if [[ -z "$id" ]]; then
        adm_log_fatal "adm_profile_load_env: ID não informado."
    fi

    local path
    path="$(adm_profile_id_to_path "$id")"
    if [[ ! -f "$path" ]]; then
        adm_log_fatal "Profile não encontrado: $id ($path)"
    fi

    local libc kind cflags cxxflags ldflags
    libc="$(adm_profile_read_field "$path" "libc" || echo "")"
    kind="$(adm_profile_read_field "$path" "kind" || echo "")"
    cflags="$(adm_profile_read_field "$path" "cflags" || echo "")"
    cxxflags="$(adm_profile_read_field "$path" "cxxflags" || echo "")"
    ldflags="$(adm_profile_read_field "$path" "ldflags" || echo "")"

    export ADM_PROFILE_ID="$id"
    export ADM_PROFILE_LIBC="$libc"
    export ADM_PROFILE_KIND="$kind"
    export CFLAGS="$cflags"
    export CXXFLAGS="$cxxflags"
    export LDFLAGS="$ldflags"

    if command -v nproc >/dev/null 2>&1; then
        export MAKEFLAGS="-j$(nproc)"
    fi

    adm_event_emit "PROFILE_APPLY" "$id" "libc=$libc kind=$kind"
}

adm_profile_export() {
    # CLI: imprime exports para o profile ID
    #
    # Uso:
    #   adm-profile export glibc/extreme
    #   eval "$(adm-profile export glibc/extreme)"
    local id="${1:-}"

    if [[ -z "$id" ]]; then
        adm_log_fatal "Uso: adm-profile export ID"
    fi

    local path
    path="$(adm_profile_id_to_path "$id")"
    if [[ ! -f "$path" ]]; then
        adm_log_fatal "Profile não encontrado: $id ($path)"
    fi

    local libc kind cflags cxxflags ldflags
    libc="$(adm_profile_read_field "$path" "libc" || echo "")"
    kind="$(adm_profile_read_field "$path" "kind" || echo "")"
    cflags="$(adm_profile_read_field "$path" "cflags" || echo "")"
    cxxflags="$(adm_profile_read_field "$path" "cxxflags" || echo "")"
    ldflags="$(adm_profile_read_field "$path" "ldflags" || echo "")"

    # gera export seguro com %q
    printf "export ADM_PROFILE_ID=%q\n" "$id"
    printf "export ADM_PROFILE_LIBC=%q\n" "$libc"
    printf "export ADM_PROFILE_KIND=%q\n" "$kind"
    printf "export CFLAGS=%q\n" "$cflags"
    printf "export CXXFLAGS=%q\n" "$cxxflags"
    printf "export LDFLAGS=%q\n" "$ldflags"

    if command -v nproc >/dev/null 2>&1; then
        local jobs
        jobs="$(nproc 2>/dev/null || echo 1)"
        printf "export MAKEFLAGS=%q\n" "-j${jobs}"
    fi

    # valores padrão de compiladores se não definidos
    printf 'export CC=${CC:-gcc}\n'
    printf 'export CXX=${CXX:-g++}\n'

    adm_event_emit "PROFILE_EXPORT" "$id" "libc=$libc kind=$kind"
}
# =========
# CLI helpers
# =========

adm_profile_usage() {
    cat <<'EOF'
adm-profile - Gerenciador de profiles de compilação do ADM 2.0

Uso:
  adm-profile init-defaults
      Cria os profiles padrão:
        - glibc/extreme
        - musl/extreme
        - toolchain/safe-glibc
        - toolchain/safe-musl

  adm-profile list
      Lista todos os profiles disponíveis.

  adm-profile show ID
      Mostra o conteúdo detalhado de um profile.

  adm-profile export ID
      Imprime exports para usar o profile no shell atual.
      Exemplo:
        eval "$(adm-profile export glibc/extreme)"

  adm-profile current
      Mostra o profile atual (definido em db/profiles/current).

  adm-profile set-current ID
      Define o profile atual.

  adm-profile create ID --libc glibc|musl --kind extreme|safe [--desc "texto"]
      Cria um profile novo baseado nos templates internos de flags.

Perfis padrão:
  glibc/extreme        -> otimizações extremas para glibc
  musl/extreme         -> otimizações extremas para musl
  toolchain/safe-glibc -> flags seguras para toolchain glibc
  toolchain/safe-musl  -> flags seguras para toolchain musl
EOF
}

adm_profile_cmd_init_defaults() {
    adm_log_phase_header "Inicializando profiles padrão"

    # glibc/extreme
    local out cflags cxxflags ldflags
    out="$(adm_profile_default_flags glibc extreme)"
    cflags="${out%%$'\t'*}"
    local rest
    rest="${out#*$'\t'}"
    cxxflags="${rest%%$'\t'*}"
    ldflags="${rest#*$'\t'}"
    if [[ -f "$(adm_profile_id_to_path 'glibc/extreme')" ]]; then
        adm_log_info "Profile glibc/extreme já existe; mantendo."
    else
        adm_profile_write_file "glibc/extreme" "glibc" "extreme" \
            "Otimizações extremas para glibc" \
            "$cflags" "$cxxflags" "$ldflags"
    fi

    # musl/extreme
    out="$(adm_profile_default_flags musl extreme)"
    cflags="${out%%$'\t'*}"
    rest="${out#*$'\t'}"
    cxxflags="${rest%%$'\t'*}"
    ldflags="${rest#*$'\t'}"
    if [[ -f "$(adm_profile_id_to_path 'musl/extreme')" ]]; then
        adm_log_info "Profile musl/extreme já existe; mantendo."
    else
        adm_profile_write_file "musl/extreme" "musl" "extreme" \
            "Otimizações extremas para musl" \
            "$cflags" "$cxxflags" "$ldflags"
    fi

    # toolchain/safe-glibc
    out="$(adm_profile_default_flags glibc safe)"
    cflags="${out%%$'\t'*}"
    rest="${out#*$'\t'}"
    cxxflags="${rest%%$'\t'*}"
    ldflags="${rest#*$'\t'}"
    if [[ -f "$(adm_profile_id_to_path 'toolchain/safe-glibc')" ]]; then
        adm_log_info "Profile toolchain/safe-glibc já existe; mantendo."
    else
        adm_profile_write_file "toolchain/safe-glibc" "glibc" "safe" \
            "Profile seguro para toolchain com glibc" \
            "$cflags" "$cxxflags" "$ldflags"
    fi

    # toolchain/safe-musl
    out="$(adm_profile_default_flags musl safe)"
    cflags="${out%%$'\t'*}"
    rest="${out#*$'\t'}"
    cxxflags="${rest%%$'\t'*}"
    ldflags="${rest#*$'\t'}"
    if [[ -f "$(adm_profile_id_to_path 'toolchain/safe-musl')" ]]; then
        adm_log_info "Profile toolchain/safe-musl já existe; mantendo."
    else
        adm_profile_write_file "toolchain/safe-musl" "musl" "safe" \
            "Profile seguro para toolchain com musl" \
            "$cflags" "$cxxflags" "$ldflags"
    fi

    adm_log_ok "Profiles padrão inicializados."
}

adm_profile_cmd_list() {
    adm_log_phase_header "Profiles disponíveis"
    local ids
    ids="$(adm_profile_list_ids || true)"
    if [[ -z "$ids" ]]; then
        adm_log_info "Nenhum profile encontrado em '$ADM_PROFILE_DB_DIR'."
        return 0
    fi
    printf '%s\n' "$ids"
}

adm_profile_cmd_show() {
    local id="${1:-}"
    if [[ -z "$id" ]]; then
        adm_log_fatal "Uso: adm-profile show ID"
    fi
    local path
    path="$(adm_profile_id_to_path "$id")"
    if [[ ! -f "$path" ]]; then
        adm_log_fatal "Profile não encontrado: $id ($path)"
    fi

    adm_log_phase_header "Profile: $id"
    cat "$path"
}

adm_profile_cmd_current() {
    local cur
    cur="$(adm_profile_get_current || true)"
    if [[ -z "$cur" ]]; then
        adm_log_info "Nenhum profile atual definido."
        return 0
    fi
    adm_log_phase_header "Profile atual"
    printf '%s\n' "$cur"
}

adm_profile_cmd_set_current() {
    local id="${1:-}"
    if [[ -z "$id" ]]; then
        adm_log_fatal "Uso: adm-profile set-current ID"
    fi
    adm_profile_set_current "$id"
}

adm_profile_cmd_create() {
    # adm-profile create ID --libc glibc|musl --kind extreme|safe [--desc "texto"]
    local id="${1:-}"
    shift || true

    if [[ -z "$id" ]]; then
        adm_log_fatal "Uso: adm-profile create ID --libc glibc|musl --kind extreme|safe [--desc \"texto\"]"
    fi

    local libc="" kind="" desc="Profile custom"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --libc)
                shift || true
                libc="${1:-}"
                ;;
            --kind)
                shift || true
                kind="${1:-}"
                ;;
            --desc)
                shift || true
                desc="${1:-}"
                ;;
            *)
                adm_log_fatal "Parâmetro desconhecido para create: '$1'"
                ;;
        esac
        shift || true
    done

    if [[ -z "$libc" || -z "$kind" ]]; then
        adm_log_fatal "create exige --libc e --kind."
    fi

    local out cflags cxxflags ldflags rest
    out="$(adm_profile_default_flags "$libc" "$kind")"
    cflags="${out%%$'\t'*}"
    rest="${out#*$'\t'}"
    cxxflags="${rest%%$'\t'*}"
    ldflags="${rest#*$'\t'}"

    adm_log_phase_header "Criando profile custom: $id"
    adm_profile_write_file "$id" "$libc" "$kind" "$desc" "$cflags" "$cxxflags" "$ldflags"
}

# =========
# MAIN
# =========

adm_profile_main() {
    local cmd="${1:-help}"
    [[ -n "$cmd" ]] && shift || true

    case "$cmd" in
        init-defaults)
            adm_profile_cmd_init_defaults
            ;;
        list)
            adm_profile_cmd_list
            ;;
        show)
            adm_profile_cmd_show "${1:-}"
            ;;
        export)
            adm_profile_export "${1:-}"
            ;;
        current)
            adm_profile_cmd_current
            ;;
        set-current)
            adm_profile_cmd_set_current "${1:-}"
            ;;
        create)
            adm_profile_cmd_create "$@"
            ;;
        help|--help|-h)
            adm_profile_usage
            ;;
        *)
            adm_log_error "Comando desconhecido para adm-profile: '$cmd'"
            adm_profile_usage
            return 1
            ;;
    esac
}

if [[ "${BASH_SOURCE[0]:-$0}" == "$0" ]]; then
    adm_profile_main "$@"
fi
