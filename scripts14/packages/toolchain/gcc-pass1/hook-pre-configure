#!/usr/bin/env bash
# hook-pre-configure para toolchain/gcc-pass1
#
# Objetivo:
#   - Transformar o ./configure em um wrapper que:
#       * ignora o --prefix=/usr padrão do adm-build
#       * injeta flags de cross para o GCC pass1:
#           - --target
#           - --prefix (cross prefix)
#           - --with-sysroot
#           - --with-newlib
#           - --without-headers
#           - --enable-languages=c
#           - desabilita tudo que não é C (como LFS cross pass1)
#
# Depende de variáveis (preferencialmente definidas pelo profile):
#   ADM_CROSS_TARGET  (ex: x86_64-lfs-linux-gnu)
#   ADM_CROSS_PREFIX  (ex: /usr/cross)
#   ADM_SYSROOT       (ex: / ou $LFS)
#
# O adm-build:
#   - entra no diretório do source
#   - exporta ADM_BUILD_DIR_CURRENT
#   - chama este hook
#   - depois chama ./configure com uma lista de args padrão
#
# Aqui nós renomeamos o configure original para configure.orig
# e colocamos um wrapper que adiciona os parâmetros certos.

set -o errexit
set -o nounset
set -o pipefail

PKG_ID="${ADM_PKG_ID:-toolchain/gcc-pass1}"
BUILD_DIR="${ADM_BUILD_DIR_CURRENT:-.}"

CROSS_TARGET="${ADM_CROSS_TARGET:-x86_64-lfs-linux-gnu}"
CROSS_PREFIX="${ADM_CROSS_PREFIX:-/usr/cross}"
SYSROOT="${ADM_SYSROOT:-/}"

echo "[hook-pre-configure][$PKG_ID] usando:"
echo "  TARGET = $CROSS_TARGET"
echo "  PREFIX = $CROSS_PREFIX"
echo "  SYSROOT = $SYSROOT"
echo "  BUILD_DIR = $BUILD_DIR"

cd "$BUILD_DIR"

if [[ ! -x ./configure ]]; then
    echo "[hook-pre-configure][$PKG_ID] ./configure não encontrado ou não executável."
    exit 1
fi

if [[ -x ./configure.orig ]]; then
    echo "[hook-pre-configure][$PKG_ID] ./configure.orig já existe; não vou sobrescrever."
    exit 0
fi

mv ./configure ./configure.orig

cat > ./configure << 'EOF'
#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

CROSS_TARGET="${ADM_CROSS_TARGET:-x86_64-lfs-linux-gnu}"
CROSS_PREFIX="${ADM_CROSS_PREFIX:-/usr/cross}"
SYSROOT="${ADM_SYSROOT:-/}"

orig_args=("$@")
filtered=()

# Remove qualquer --prefix=/usr que o adm-build passou
for a in "${orig_args[@]}"; do
    case "$a" in
        --prefix=/usr) ;;
        *) filtered+=("$a") ;;
    esac
done

# Flags padrão para GCC pass1 (cross, C-only, sem headers)
extra=(
    "--target=${CROSS_TARGET}"
    "--prefix=${CROSS_PREFIX}"
    "--with-sysroot=${SYSROOT}"
    "--with-newlib"
    "--without-headers"
    "--enable-languages=c"
    "--disable-nls"
    "--disable-shared"
    "--disable-multilib"
    "--disable-decimal-float"
    "--disable-libatomic"
    "--disable-libgomp"
    "--disable-libquadmath"
    "--disable-libssp"
    "--disable-libvtv"
    "--disable-libstdcxx"
)

echo "[hook-gcc-pass1-wrapper] chamando ./configure.orig com:"
printf '  %s\n' "${extra[@]}" "${filtered[@]}"

exec bash ./configure.orig "${extra[@]}" "${filtered[@]}"
EOF

chmod +x ./configure

echo "[hook-pre-configure][$PKG_ID] wrapper ./configure criado com sucesso."
