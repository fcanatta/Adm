#!/usr/bin/env bash
# hook-pre-configure para toolchain/perl-temp (LFS 7.9 + ADM 2.0)
#
# LFS:
#   sh Configure -des                                        \
#      -Dprefix=/usr                                         \
#      -Dvendorprefix=/usr                                   \
#      -Dprivlib=/usr/lib/perl5/5.36/core_perl               \
#      -Darchlib=/usr/lib/perl5/5.36/core_perl               \
#      -Dsitelib=/usr/lib/perl5/5.36/site_perl               \
#      -Dsitearch=/usr/lib/perl5/5.36/site_perl              \
#      -Dvendorlib=/usr/lib/perl5/5.36/vendor_perl           \
#      -Dvendorarch=/usr/lib/perl5/5.36/vendor_perl
#
# Depois:
#   make
#   make install
#
# No ADM 2.0:
#   - aqui rodamos o Configure e geramos o Makefile
#   - o adm-build (build_system=plain-make ou unknown) depois faz:
#       make
#       make DESTDIR="$ADM_DESTDIR" prefix=/usr install
#   - Resultado: igual ao LFS, mas instalado em DESTDIR.

set -o errexit
set -o nounset
set -o pipefail

: "${ADM_PKG_ID:=toolchain/perl-temp}"
: "${ADM_BUILD_DIR_CURRENT:?ADM_BUILD_DIR_CURRENT não definido}"

pkg_id="$ADM_PKG_ID"
build_dir="$ADM_BUILD_DIR_CURRENT"

cd "$build_dir"

# Evita rodar Configure mais de uma vez
if [[ -f ".adm-perl-configured.stamp" ]]; then
    echo "[hook-pre-configure][$pkg_id] Perl já foi configurado (stamp encontrado); pulando Configure." >&2
    exit 0
fi

if [[ ! -x "./Configure" ]]; then
    echo "[hook-pre-configure][$pkg_id] ERRO: script ./Configure não encontrado ou não executável em $build_dir" >&2
    exit 1
fi

if [[ "${ADM_DRY_RUN:-0}" -eq 1 ]]; then
    cat <<EOF >&2
[hook-pre-configure][$pkg_id][DRY-RUN] Rodaria:
  sh Configure -des \\
    -Dprefix=/usr \\
    -Dvendorprefix=/usr \\
    -Dprivlib=/usr/lib/perl5/5.36/core_perl \\
    -Darchlib=/usr/lib/perl5/5.36/core_perl \\
    -Dsitelib=/usr/lib/perl5/5.36/site_perl \\
    -Dsitearch=/usr/lib/perl5/5.36/site_perl \\
    -Dvendorlib=/usr/lib/perl5/5.36/vendor_perl \\
    -Dvendorarch=/usr/lib/perl5/5.36/vendor_perl
EOF
    exit 0
fi

echo "[hook-pre-configure][$pkg_id] Rodando Configure do Perl 5.36.0 (LFS 7.9)..." >&2

sh Configure -des                                        \
    -Dprefix=/usr                                        \
    -Dvendorprefix=/usr                                  \
    -Dprivlib=/usr/lib/perl5/5.36/core_perl              \
    -Darchlib=/usr/lib/perl5/5.36/core_perl              \
    -Dsitelib=/usr/lib/perl5/5.36/site_perl              \
    -Dsitearch=/usr/lib/perl5/5.36/site_perl             \
    -Dvendorlib=/usr/lib/perl5/5.36/vendor_perl          \
    -Dvendorarch=/usr/lib/perl5/5.36/vendor_perl

# Aqui o Configure gera o Makefile na raiz do source.
# Isso permite que o adm-build, com build_system=plain-make/unknown,
# use adm_build_do_plain_make:
#   make
#   make DESTDIR="$ADM_DESTDIR" prefix=/usr install

touch ".adm-perl-configured.stamp"

echo "[hook-pre-configure][$pkg_id] Configure do Perl concluído; Makefile pronto para o adm-build." >&2
