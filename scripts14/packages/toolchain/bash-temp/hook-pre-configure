#!/usr/bin/env bash
# /root/usr/src/adm/packages/toolchain/bash-temp/hook-pre-configure
# hook-pre-configure para toolchain/bash-temp (LFS 6.4 + ADM 2.0)
#
# Responsável por transformar ./configure num wrapper que:
#   - força --prefix=/usr
#   - força --build=$(sh support/config.guess)
#   - força --host=$LFS_TGT (ou ADM_CROSS_TARGET)
#   - força --without-bash-malloc
# e remove opções conflitantes vindas do adm-build.

set -o errexit
set -o nounset
set -o pipefail

: "${ADM_PKG_ID:=toolchain/bash-temp}"
: "${ADM_BUILD_DIR_CURRENT:?ADM_BUILD_DIR_CURRENT não definido}"
: "${ADM_DESTDIR:?ADM_DESTDIR não definido}"

pkg_id="$ADM_PKG_ID"
build_dir="$ADM_BUILD_DIR_CURRENT"

cd "$build_dir"

if [[ ! -x "./configure" ]]; then
    echo "[hook-pre-configure][$pkg_id] ./configure não encontrado em $build_dir; nada a fazer." >&2
    exit 0
fi

# Evita recriar wrapper se já existir
if [[ -x "./configure.orig" ]]; then
    echo "[hook-pre-configure][$pkg_id] Wrapper de configure já existe; pulando." >&2
    exit 0
fi

mv ./configure ./configure.orig

cat > ./configure << 'EOF'
#!/usr/bin/env bash
# Wrapper de ./configure para Bash temporário (LFS 6.4 / ADM 2.0)
set -o errexit
set -o nounset
set -o pipefail

pkg_id="${ADM_PKG_ID:-toolchain/bash-temp}"
build_dir="$(pwd)"

# ===== Determinar HOST =====
# Prioridade:
#   1) LFS_TGT (ambiente LFS)
#   2) ADM_CROSS_TARGET (toolchain ADM)
#   3) gcc -dumpmachine (fallback)
host="${LFS_TGT:-${ADM_CROSS_TARGET:-}}"

if [[ -z "$host" ]]; then
    if command -v gcc >/dev/null 2>&1; then
        host="$(gcc -dumpmachine 2>/dev/null || true)"
    fi
fi

if [[ -z "$host" ]]; then
    printf 'ADM-ERROR[%s]: não consegui determinar HOST (LFS_TGT/ADM_CROSS_TARGET/gcc -dumpmachine).\n' \
        "$pkg_id" >&2
    exit 1
fi

# ===== Determinar BUILD =====
# LFS manda: --build=$(sh support/config.guess)
if [[ -x "$build_dir/support/config.guess" ]]; then
    build="$(sh "$build_dir/support/config.guess")"
else
    # fallback razoável
    if command -v gcc >/dev/null 2>&1; then
        build="$(gcc -dumpmachine 2>/dev/null || echo "$host")"
    else
        build="$host"
    fi
fi

# ===== Filtrar args do adm-build =====
filtered_args=()
for a in "$@"; do
    case "$a" in
        --prefix=*|--host=*|--build=*|--without-bash-malloc)
            # ignoramos, vamos forçar nossos valores
            ;;
        *)
            filtered_args+=("$a")
            ;;
    esac
done

real_conf="./configure.orig"
if [[ ! -x "$real_conf" ]]; then
    printf 'ADM-ERROR[%s]: configure.orig não encontrado em %s\n' "$pkg_id" "$build_dir" >&2
    exit 1
fi

# ===== Monta linha final, alinhada com o livro =====
args=(
  "$real_conf"
  "--prefix=/usr"
  "--build=${build}"
  "--host=${host}"
  "--without-bash-malloc"
)

if [[ ${#filtered_args[@]} -gt 0 ]]; then
    args+=("${filtered_args[@]}")
fi

printf 'ADM-INFO[%s]: chamando configure real: %s\n' "$pkg_id" "${args[*]}" >&2
exec "${args[@]}"
EOF

chmod +x ./configure

echo "[hook-pre-configure][$pkg_id] Wrapper ./configure criado para Bash-5.3 (cross LFS/ADM 2.0)." >&2
