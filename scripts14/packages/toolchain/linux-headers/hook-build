#!/usr/bin/env bash
# hook-build para toolchain/linux-headers
#
# Objetivo:
#   - Construir e instalar os Linux API Headers usados pela glibc.
#
# Equivalente ao passo LFS:
#   make mrproper
#   make headers
#   make headers_install INSTALL_HDR_PATH=<sysroot>/usr
#
# Variáveis:
#   ADM_BUILD_DIR_CURRENT  -> diretório do source do kernel
#   ADM_SYSROOT            -> raiz lógica do sistema alvo (ex: /, $LFS)
#   ADM_DESTDIR            -> usado pelo adm-build para staging; aqui, preferimos SYSROOT.

set -o errexit
set -o nounset
set -o pipefail

PKG_ID="${ADM_PKG_ID:-toolchain/linux-headers}"
BUILD_DIR="${ADM_BUILD_DIR_CURRENT:-.}"
SYSROOT="${ADM_SYSROOT:-/}"

echo "[hook-build][$PKG_ID] BUILD_DIR=$BUILD_DIR"
echo "[hook-build][$PKG_ID] SYSROOT=$SYSROOT"

cd "$BUILD_DIR"

# Passo 1: limpeza
echo "[hook-build][$PKG_ID] make mrproper"
make mrproper

# Passo 2: gerar headers
echo "[hook-build][$PKG_ID] make headers"
make headers

# Passo 3: instalar headers
#   - caminho alvo: <SYSROOT>/usr/include
INSTALL_HDR_PATH="${SYSROOT%/}/usr"

echo "[hook-build][$PKG_ID] make headers_install INSTALL_HDR_PATH=${INSTALL_HDR_PATH}"
make headers_install INSTALL_HDR_PATH="${INSTALL_HDR_PATH}"

echo "[hook-build][$PKG_ID] Linux API Headers instalados em ${INSTALL_HDR_PATH}/include"
