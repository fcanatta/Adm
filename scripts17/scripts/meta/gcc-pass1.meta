# GCC-15.2.0 - Pass 1 (cross-compiler) - LFS 5.3
PKG_NAME="gcc-pass1"

PKG_BUILD() {
    set -e

    # Versões auxiliares (iguais ao livro)
    local MPFR_VER="4.2.2"
    local GMP_VER="6.3.0"
    local MPC_VER="1.3.1"

    cd "$LFS/sources"

    # Extrair GCC
    tar -xf "gcc-${GCC_VER}.tar."* 
    cd "gcc-${GCC_VER}"

    # Desempacotar mpfr, gmp, mpc dentro do diretório do GCC, como no livro
    tar -xf "../mpfr-${MPFR_VER}.tar."* 
    mv -v "mpfr-${MPFR_VER}" mpfr

    tar -xf "../gmp-${GMP_VER}.tar."* 
    mv -v "gmp-${GMP_VER}" gmp

    tar -xf "../mpc-${MPC_VER}.tar."* 
    mv -v "mpc-${MPC_VER}" mpc

    # Ajuste lib64 -> lib em x86_64 (5.3)
    case "$(uname -m)" in
        x86_64)
            sed -e '/m64=/s/lib64/lib/' \
                -i.orig gcc/config/i386/t-linux64
            ;;
    esac

    # Diretório de build separado
    mkdir -v build
    cd build

    # Configure (5.3.1)
    ../configure                  \
        --target="$LFS_TGT"       \
        --prefix="$LFS/tools"     \
        --with-glibc-version=2.42 \
        --with-sysroot="$LFS"     \
        --with-newlib             \
        --without-headers         \
        --enable-default-pie      \
        --enable-default-ssp      \
        --disable-nls             \
        --disable-shared          \
        --disable-multilib        \
        --disable-threads         \
        --disable-libatomic       \
        --disable-libgomp         \
        --disable-libquadmath     \
        --disable-libssp          \
        --disable-libvtv          \
        --disable-libstdcxx       \
        --enable-languages=c,c++

    # Compilar e instalar
    make
    make install

    # Criar headers internos completos (limits.h) – comando do livro
    cd ..
    cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
        "$(dirname "$("$LFS_TGT-gcc" -print-libgcc-file-name)")"/include/limits.h

    # Limpeza
    cd "$LFS/sources"
    rm -rf "gcc-${GCC_VER}"
}

# Verificação simples: o cross gcc existe e roda --version
PKG_CHECK() {
    if "$LFS/tools/bin/${LFS_TGT}-gcc" --version >/dev/null 2>&1; then
        return 0
    fi
    return 1
}
