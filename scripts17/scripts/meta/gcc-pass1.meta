# GCC-15.2.0 - Pass 1 (cross-compiler) - LFS
# -------------------------------------------
# Usa:
#   - GCC_VER    (definido no mini-adm)
#   - LFS        (raiz do sistema em construção)
#   - LFS_TGT    (triplet do target, ex: x86_64-lfs-linux-gnu)
#
# Instala o cross-compiler em:
#   $LFS/tools/bin/${LFS_TGT}-gcc
#
# E usa o esquema de checagem genérica do mini-adm:
#   PKG_MAIN_BINS, PKG_CHECK_LIBS, PKG_CHECK_CMDS

PKG_NAME="gcc-pass1"

PKG_BUILD() {
    set -e

    : "${GCC_VER:?GCC_VER não definido}"
    : "${LFS:?LFS não definido}"
    : "${LFS_TGT:?LFS_TGT não definido}"

    cd "$LFS/sources"

    # Tarball do GCC
    [[ -f "gcc-${GCC_VER}.tar.xz" ]] || [[ -f "gcc-${GCC_VER}.tar.gz" ]] || {
        echo "ERRO: gcc-${GCC_VER}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
        exit 1
    }

    # Versões auxiliares (iguais às usadas no LFS)
    local MPFR_VER="4.2.2"
    local GMP_VER="6.3.0"
    local MPC_VER="1.3.1"

    # Confere tarballs auxiliares
    for dep in "mpfr-${MPFR_VER}" "gmp-${GMP_VER}" "mpc-${MPC_VER}"; do
        [[ -f "${dep}.tar.xz" ]] || [[ -f "${dep}.tar.gz" ]] || {
            echo "ERRO: ${dep}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
            exit 1
        }
    done

    # Extrair GCC
    tar -xf "gcc-${GCC_VER}.tar."*
    cd "gcc-${GCC_VER}"

    # Integrar mpfr, gmp, mpc dentro da árvore do GCC
    tar -xf "../mpfr-${MPFR_VER}.tar."*
    mv -v "mpfr-${MPFR_VER}" mpfr

    tar -xf "../gmp-${GMP_VER}.tar."*
    mv -v "gmp-${GMP_VER}" gmp

    tar -xf "../mpc-${MPC_VER}.tar."*
    mv -v "mpc-${MPC_VER}" mpc

    # Ajuste lib64 -> lib para x86_64 (como no livro)
    case "$(uname -m)" in
        x86_64)
            sed -e '/m64=/s/lib64/lib/' \
                -i.orig gcc/config/i386/t-linux64
            ;;
    esac

    # Diretório separado de build
    mkdir -v build
    cd build

    # Configure Pass 1 (cross-compiler sem headers)
    ../configure                  \
        --target="$LFS_TGT"       \
        --prefix="$LFS/tools"     \
        --with-glibc-version=2.42 \
        --with-sysroot="$LFS"     \
        --with-newlib             \
        --without-headers         \
        --enable-default-pie      \
        --enable-default-ssp      \
        --disable-nls             \
        --disable-shared          \
        --disable-multilib        \
        --disable-threads         \
        --disable-libatomic       \
        --disable-libgomp         \
        --disable-libquadmath     \
        --disable-libssp          \
        --disable-libvtv          \
        --disable-libstdcxx       \
        --enable-languages=c,c++

    # Compilar e instalar
    make
    make install

    # Gerar limits.h internal completo (como no livro)
    cd ..
    cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
        "$(dirname "$("$LFS_TGT-gcc" -print-libgcc-file-name)")"/include/limits.h

    # Limpeza
    cd "$LFS/sources"
    rm -rf "gcc-${GCC_VER}"
}

#######################################################
# Checagem genérica (usa run_generic_pkg_checks do
# mini-adm: PKG_MAIN_BINS, PKG_CHECK_LIBS, PKG_CHECK_CMDS)
#
# Paths são relativos à raiz $LFS.
#######################################################

# Bins principais do cross-compiler
PKG_MAIN_BINS=(
  "/tools/bin/${LFS_TGT}-gcc"
  "/tools/bin/${LFS_TGT}-cpp"
)

# Bins extras que queremos garantir
PKG_CHECK_BINS=(
  "/tools/bin/${LFS_TGT}-gcc-ar"
  "/tools/bin/${LFS_TGT}-gcc-nm"
  "/tools/bin/${LFS_TGT}-gcc-ranlib"
)

# Bibliotecas principais (dentro da árvore do GCC em $LFS/tools)
PKG_CHECK_LIBS=(
  "/tools/lib/gcc/${LFS_TGT}/${GCC_VER}/libgcc.a"
)

# Comandos de teste (no host, sem chroot)
PKG_CHECK_CMDS=(
  "$LFS/tools/bin/${LFS_TGT}-gcc --version"
  "$LFS/tools/bin/${LFS_TGT}-cpp --version"
  "$LFS/tools/bin/${LFS_TGT}-gcc -print-libgcc-file-name"
)

# Não definimos PKG_CHECK():
# o mini-adm vai usar só a checagem genérica acima.
