# File-5.46 - LFS 6.7
# -------------------
# Variáveis: FILE_VER, LFS, LFS_TGT

PKG_NAME="file"

PKG_BUILD() {
    set -e

    : "${FILE_VER:?FILE_VER não definido}"
    : "${LFS:?LFS não definido}"
    : "${LFS_TGT:?LFS_TGT não definido}"

    cd "$LFS/sources"

    [[ -f "file-${FILE_VER}.tar.xz" ]] || [[ -f "file-${FILE_VER}.tar.gz" ]] || {
        echo "ERRO: file-${FILE_VER}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
        exit 1
    }

    tar -xf "file-${FILE_VER}.tar."*
    cd "file-${FILE_VER}"

    # build auxiliar só pra gerar o 'file' usado na build
    mkdir -v build
    pushd build
      ../configure --disable-bzlib      \
                   --disable-libseccomp \
                   --disable-xzlib      \
                   --disable-zlib
      make
    popd

    # configure principal (cross)
    ./configure --prefix=/usr --host="$LFS_TGT" --build="$(./config.guess)"

    # usa o file recém-compilado
    make FILE_COMPILE="$(pwd)/build/src/file"
    make DESTDIR="$LFS" install

    # remove .la
    rm -v "$LFS/usr/lib/libmagic.la" || true

    cd "$LFS/sources"
    rm -rf "file-${FILE_VER}"
}

#######################################################
# Checagem genérica
#######################################################

PKG_MAIN_BINS=(
  "/usr/bin/file"
)

PKG_CHECK_LIBS=(
  "/usr/lib/libmagic.so"
)

PKG_CHECK_CMDS=(
  "$LFS/usr/bin/file --version"
)
