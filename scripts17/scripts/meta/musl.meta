# musl-1.2.5 como libc alternativa dentro de $LFS
# com patches de segurança (CVE-2025-26519)
#
# Patches esperados em:
#   $LFS/sources/musl-1.2.5-cve-2025-26519-1.patch
#   $LFS/sources/musl-1.2.5-cve-2025-26519-2.patch

PKG_NAME="musl"

PKG_BUILD() {
    set -e

    : "${MUSL_VER:?MUSL_VER não definido}"
    : "${LFS:?LFS não definido}"

    cd "$LFS/sources"

    [[ -f "musl-${MUSL_VER}.tar.gz" ]] || [[ -f "musl-${MUSL_VER}.tar.xz" ]] || {
        echo "ERRO: musl-${MUSL_VER}.tar.* não encontrado em $LFS/sources" >&2
        exit 1
    }

    [[ -f "musl-${MUSL_VER}-cve-2025-26519-1.patch" ]] || {
        echo "ERRO: patch musl-${MUSL_VER}-cve-2025-26519-1.patch não encontrado em $LFS/sources" >&2
        exit 1
    }

    [[ -f "musl-${MUSL_VER}-cve-2025-26519-2.patch" ]] || {
        echo "ERRO: patch musl-${MUSL_VER}-cve-2025-26519-2.patch não encontrado em $LFS/sources" >&2
        exit 1
    }

    tar -xf "musl-${MUSL_VER}.tar."*
    cd "musl-${MUSL_VER}"

    # Aplicar patches de segurança
    patch -Np1 -i "../musl-${MUSL_VER}-cve-2025-26519-1.patch"
    patch -Np1 -i "../musl-${MUSL_VER}-cve-2025-26519-2.patch"

    ./configure \
        --prefix="$LFS/tools/musl" \
        --exec-prefix="$LFS/tools" \
        --syslibdir="$LFS/tools/musl/lib"

    make
    make install

    # (Opcional) ld-musl-*.path dentro do $LFS
    local arch
    arch="$(uname -m)"
    case "$arch" in
        x86_64)   arch="x86_64" ;;
        i?86)     arch="i386" ;;
        aarch64)  arch="aarch64" ;;
        *) : ;;
    esac

    mkdir -pv "$LFS/etc"
    cat > "$LFS/etc/ld-musl-${arch}.path" << "EOF"
/tools/musl/lib
/usr/local/musl/lib
EOF

    cd "$LFS/sources"
    rm -rf "musl-${MUSL_VER}"
}

#######################################################
# Checagem genérica
#######################################################

# Binário principal: musl-gcc wrapper
PKG_MAIN_BINS=(
  "/tools/bin/musl-gcc"
)

# Lib principal da musl
PKG_CHECK_LIBS=(
  "/tools/musl/lib/libc.so"
)

# Comando de teste (no host)
PKG_CHECK_CMDS=(
  "$LFS/tools/bin/musl-gcc --version"
)
