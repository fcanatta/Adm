# Ncurses-6.5-20250809 - LFS 6.3 (Cross Compiling Temporary Tools)
# ---------------------------------------------------------------
# Pré-requisitos:
#   - TOOLCHAIN pass1 + m4
# Variáveis:
#   - NCURSES_VER, LFS, LFS_TGT

PKG_NAME="ncurses"

PKG_BUILD() {
    set -e

    : "${NCURSES_VER:?NCURSES_VER não definido}"
    : "${LFS:?LFS não definido}"
    : "${LFS_TGT:?LFS_TGT não definido}"

    cd "$LFS/sources"

    [[ -f "ncurses-${NCURSES_VER}.tar.xz" ]] || [[ -f "ncurses-${NCURSES_VER}.tar.gz" ]] || {
        echo "ERRO: ncurses-${NCURSES_VER}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
        exit 1
    }

    tar -xf "ncurses-${NCURSES_VER}.tar."*
    cd "ncurses-${NCURSES_VER}"

    # 1) Construir tic pro host e instalar em $LFS/tools (como no LFS)
    mkdir -v build
    pushd build
      ../configure --prefix="$LFS/tools" AWK=gawk
      make -C include
      make -C progs tic
      install -v progs/tic "$LFS/tools/bin"
    popd

    # 2) Configure cross
    ./configure --prefix=/usr                \
                --host="$LFS_TGT"           \
                --build="$(./config.guess)" \
                --mandir=/usr/share/man     \
                --with-manpage-format=normal \
                --with-shared               \
                --without-normal            \
                --with-cxx-shared           \
                --without-debug             \
                --without-ada               \
                --disable-stripping         \
                AWK=gawk

    make

    make DESTDIR="$LFS" install

    # link libncurses.so -> libncursesw.so
    ln -svf libncursesw.so "$LFS/usr/lib/libncurses.so"

    # habilitar XOPEN em curses.h
    sed -e 's/^#if.*XOPEN.*$/#if 1/' \
        -i "$LFS/usr/include/curses.h"

    cd "$LFS/sources"
    rm -rf "ncurses-${NCURSES_VER}"
}

#######################################################
# Checagem genérica (run_generic_pkg_checks - mini-adm)
#######################################################

# Binário principal de tipo: tic (compila terminfo)
PKG_MAIN_BINS=(
  "/usr/bin/tic"
)

PKG_CHECK_BINS=(
  "/usr/bin/tput"
  "/usr/bin/clear"
)

PKG_CHECK_LIBS=(
  "/usr/lib/libncursesw.so"
  "/usr/lib/libncurses.so"
)

PKG_CHECK_DIRS=(
  "/usr/include"
  "/usr/share/terminfo"
)

PKG_CHECK_CMDS=(
  "$LFS/usr/bin/tic -V"
  "$LFS/usr/bin/tput cols >/dev/null"
)
