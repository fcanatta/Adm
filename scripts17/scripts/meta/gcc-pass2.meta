# GCC-15.2.0 - Pass 2 (LFS 6.18)
# -------------------------------
# Usa:
#   - GCC_VER
#   - LFS
#   - LFS_TGT
#
# Instala GCC (temporário) em $LFS/usr (gcc, cc, $LFS_TGT-gcc, etc.)
# e usa checagem genérica do mini-adm:
#   PKG_MAIN_BINS, PKG_CHECK_BINS, PKG_CHECK_LIBS, PKG_CHECK_CMDS

PKG_NAME="gcc-pass2"

PKG_BUILD() {
    set -e

    : "${GCC_VER:?GCC_VER não definido}"
    : "${LFS:?LFS não definido}"
    : "${LFS_TGT:?LFS_TGT não definido}"

    cd "$LFS/sources"

    # Tarball principal
    [[ -f "gcc-${GCC_VER}.tar.xz" ]] || [[ -f "gcc-${GCC_VER}.tar.gz" ]] || {
        echo "ERRO: gcc-${GCC_VER}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
        exit 1
    }

    # Versões auxiliares (LFS)
    local MPFR_VER="4.2.2"
    local GMP_VER="6.3.0"
    local MPC_VER="1.3.1"

    for dep in "mpfr-${MPFR_VER}" "gmp-${GMP_VER}" "mpc-${MPC_VER}"; do
        [[ -f "${dep}.tar.xz" ]] || [[ -f "${dep}.tar.gz" ]] || {
            echo "ERRO: ${dep}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
            exit 1
        }
    done

    # Extrair GCC
    tar -xf "gcc-${GCC_VER}.tar."*
    cd "gcc-${GCC_VER}"

    # Integrar MPFR, GMP, MPC
    tar -xf "../mpfr-${MPFR_VER}.tar."*
    mv -v "mpfr-${MPFR_VER}" mpfr

    tar -xf "../gmp-${GMP_VER}.tar."*
    mv -v "gmp-${GMP_VER}" gmp

    tar -xf "../mpc-${MPC_VER}.tar."*
    mv -v "mpc-${MPC_VER}" mpc

    # Ajuste lib64->lib para x86_64
    case "$(uname -m)" in
      x86_64)
        sed -e '/m64=/s/lib64/lib/' \
            -i.orig gcc/config/i386/t-linux64
        ;;
    esac

    # Habilitar POSIX threads em libgcc/libstdc++
    sed '/thread_header =/s/@.*@/gthr-posix.h/' \
        -i libgcc/Makefile.in libstdc++-v3/include/Makefile.in

    mkdir -v build
    cd build

    ../configure                   \
        --build="$(../config.guess)" \
        --host="$LFS_TGT"          \
        --target="$LFS_TGT"        \
        --prefix=/usr              \
        --with-build-sysroot="$LFS" \
        --enable-default-pie       \
        --enable-default-ssp       \
        --disable-nls              \
        --disable-multilib         \
        --disable-libatomic        \
        --disable-libgomp          \
        --disable-libquadmath      \
        --disable-libsanitizer     \
        --disable-libssp           \
        --disable-libvtv           \
        --enable-languages=c,c++   \
        LDFLAGS_FOR_TARGET="-L$PWD/$LFS_TGT/libgcc"

    make
    make DESTDIR="$LFS" install

    # Symlink cc -> gcc dentro do $LFS (como no livro)
    ln -svf gcc "$LFS/usr/bin/cc"

    cd "$LFS/sources"
    rm -rf "gcc-${GCC_VER}"
}

#######################################################
# Checagem genérica (run_generic_pkg_checks - mini-adm)
# Paths relativos a $LFS
#######################################################

# Bins principais (target e genéricos)
PKG_MAIN_BINS=(
  "/usr/bin/${LFS_TGT}-gcc"
  "/usr/bin/${LFS_TGT}-g++"
  "/usr/bin/gcc"
  "/usr/bin/cc"
)

# Bins extras uteis
PKG_CHECK_BINS=(
  "/usr/bin/${LFS_TGT}-cpp"
)

# Bibliotecas principais do GCC temporário
PKG_CHECK_LIBS=(
  "/usr/lib/gcc/${LFS_TGT}/${GCC_VER}/libgcc.a"
  "/usr/lib/gcc/${LFS_TGT}/${GCC_VER}/libstdc++.a"
)

# Comandos de teste (host, usando o tree do $LFS)
PKG_CHECK_CMDS=(
  "$LFS/usr/bin/${LFS_TGT}-gcc --version"
  "$LFS/usr/bin/gcc --version"
  "$LFS/usr/bin/cc --version"
  "$LFS/usr/bin/${LFS_TGT}-gcc -print-libgcc-file-name"
)

# Sem PKG_CHECK personalizado: mini-adm usa só a genérica.
