# Glibc-2.42 - LFS 5.5 (Cross Toolchain)
# --------------------------------------
# Instala a Glibc em $LFS/usr usando o cross-toolchain $LFS_TGT.
# Pré-requisitos:
#   - binutils-pass1, gcc-pass1, linux-headers
#   - GLIBC_VER, LFS, LFS_TGT exportados
# Tarball + patch em:
#   $LFS/sources/glibc-${GLIBC_VER}.tar.xz
#   $LFS/sources/glibc-2.42-fhs-1.patch (ou glibc-${GLIBC_VER}-fhs-1.patch)


PKG_NAME="glibc"

PKG_BUILD() {
    set -e

    : "${GLIBC_VER:?GLIBC_VER não definido}"
    : "${LFS:?LFS não definido}"
    : "${LFS_TGT:?LFS_TGT não definido}"

    cd "$LFS/sources"

    [[ -f "glibc-${GLIBC_VER}.tar.xz" ]] || [[ -f "glibc-${GLIBC_VER}.tar.gz" ]] || {
        echo "ERRO: glibc-${GLIBC_VER}.tar.[xz|gz] não encontrado em $LFS/sources" >&2
        exit 1
    }

    [[ -f "glibc-${GLIBC_VER}-fhs-1.patch" ]] || [[ -f "glibc-2.42-fhs-1.patch" ]] || {
        echo "ERRO: patch glibc-2.42-fhs-1.patch (ou glibc-${GLIBC_VER}-fhs-1.patch) não encontrado em $LFS/sources" >&2
        exit 1
    }

    local glibc_patch
    if [[ -f "glibc-${GLIBC_VER}-fhs-1.patch" ]]; then
        glibc_patch="glibc-${GLIBC_VER}-fhs-1.patch"
    else
        glibc_patch="glibc-2.42-fhs-1.patch"
    fi

    tar -xf "glibc-${GLIBC_VER}.tar."*
    cd "glibc-${GLIBC_VER}"

    # Symlinks LSB do loader
    case "$(uname -m)" in
        i?86)
            ln -sfv ld-linux.so.2 "$LFS/lib/ld-lsb.so.3"
            ;;
        x86_64)
            mkdir -pv "$LFS/lib64"
            ln -sfv ../lib/ld-linux-x86-64.so.2 "$LFS/lib64"
            ln -sfv ../lib/ld-linux-x86-64.so.2 "$LFS/lib64/ld-lsb-x86-64.so.3"
            ;;
    esac

    # Patch FHS
    patch -Np1 -i "../${glibc_patch}"

    mkdir -v build
    cd build

    echo "rootsbindir=/usr/sbin" > configparms

    ../configure                             \
          --prefix=/usr                      \
          --host="$LFS_TGT"                  \
          --build="$(../scripts/config.guess)" \
          --disable-nscd                     \
          libc_cv_slibdir=/usr/lib           \
          --enable-kernel=5.4

    make
    make DESTDIR="$LFS" install

    sed '/RTLDLIST=/s@/usr@@g' -i "$LFS/usr/bin/ldd"

    # Sanity check (igual livro, mas dentro do BUILD pra falhar cedo)
    cd "$LFS/sources"
    echo 'int main(){}' | "$LFS_TGT-gcc" -x c - -v -Wl,--verbose &> dummy.log || true

    # não falhar o build se sanity falhar — PKG_CHECK cuida depois
    rm -f a.out dummy.log || true

    cd "$LFS/sources"
    rm -rf "glibc-${GLIBC_VER}"
}

#######################################################
# Checagem genérica (run_generic_pkg_checks - mini-adm)
# Paths relativos a $LFS
#######################################################

# Bins principais relacionados à glibc
PKG_MAIN_BINS=(
  "/usr/bin/ldd"
)

# Bibliotecas essenciais da glibc
PKG_CHECK_LIBS=(
  "/usr/lib/libc.so.6"
)

# Diretórios importantes
PKG_CHECK_DIRS=(
  "/usr/include"
  "/usr/lib"
)

# Comandos rodados em chroot $LFS
PKG_CHECK_CHROOT=1
PKG_CHECK_CMDS=(
  "ldd --version"
  "echo 'int main(){}' > dummy.c && gcc dummy.c -v -Wl,--verbose -o dummy && readelf -l dummy | grep ': /lib' && rm -f dummy.c dummy"
)
